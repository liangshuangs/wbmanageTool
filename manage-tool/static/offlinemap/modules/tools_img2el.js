/**/﻿_jsload&&_jsload('tools', 'C.extend(fT.prototype,{_bind:function(){var i=this;i.setCursor(i._opts.cursor);C.on(i._map.container,"mousemove",function(hJ){if(!i._isOpen){return}if(!i.followTitle){return}hJ=window.event||hJ;var T=hJ.target||hJ.srcElement;if(T!==d9.getDom(i._map)){i.followTitle.hide();return}if(!i._mapMoving){i.followTitle.show()}var hI=d9.getDrawPoint(hJ,true);if(!i._isPointValid(hI)){i.followTitle.hide()}else{i.followTitle.show();i.followTitle.setPoint(hI)}});this._followTextOffsetNormal=new d1(14,16);this._followTextOffsetUpper=new d1(14,-32);if(this._opts.followText){var e=this.followTitle=new aI(this._opts.followText,{offset:this._followTextOffsetNormal});this.followTitle.setStyles({color:"#333",borderColor:"#ff0103"})}},_isPointValid:function(e){if(!e){return false}if(e.lat>this._maxLatMC||e.lat<this._minLatMC){return false}if(e.latLng&&(e.latLng.lat>this._maxLat||e.latLng.lat<this._minLat)){return false}if(e.lng<b1[this._map.mapType].bounds[0]||e.lng>b1[this._map.mapType].bounds[2]||e.lat<b1[this._map.mapType].bounds[1]||e.lat>b1[this._map.mapType].bounds[3]){return false}return true},_draw:function(){if(this._isOpen===true){this._isOpen=false;this._map._toolInUse=false;this.open()}}});C.extend(gC.prototype,{open:function(){if(this._isOpen===true){return true}if(this._map._toolInUse){return false}this._map._toolInUse=true;this._isOpen=true;if(this._mapMoving){delete this._mapMoving}var hJ=this;if(!this._binded){this._binded=true;this._bind();this._map.addEventListener("moving",function(){hJ._hideCurrent()})}if(this.followTitle){this._map.addOverlay(this.followTitle);this.followTitle.hide()}var hI=function(hR){var hN=hJ._map;if(hN.currentOperation&dO.toolbarOperation===0||!hJ._isOpen){return}hR=window.event||hR;var hV=d9.getDrawPoint(hR,true);if(!hJ._isPointValid(hV)){return}hJ._bind.initX=hR.pageX||hR.clientX||0;hJ._bind.initY=hR.pageY||hR.clientY||0;if(hJ._points.length>0){var hU=hN.pointToPixelIn(hJ._points[hJ._points.length-1]);var hO=hN.pointToPixelIn(hV);var hQ=Math.sqrt(Math.pow(hU.x-hO.x,2)+Math.pow(hU.y-hO.y,2));if(hQ<5){return}}hJ._bind.x=hR.offsetX||hR.layerX||0;hJ._bind.y=hR.offsetY||hR.layerY||0;hJ._points.push(hV);if(hJ._opts.showResult){hJ._addSectionMarker(hV)}if(hJ._opts.showResult&&hJ._paths.length===0){hJ._formatTitle(1,hJ._followTextM,hJ.getTotalDistance())}if(hJ._paths.length>0){hJ._paths[hJ._paths.length-1].show();if(hJ._opts.showResult){hJ._paths[hJ._paths.length-1].setStrokeOpacity(hJ._dOpacity)}}var hY=new fd([hV,hV],{enableMassClear:hJ._opts.enableMassClear,geodesic:true,clip:false});hJ._map.addOverlay(hY);hY._stCode=hJ._opts.styleCodes.lnCode;hJ._paths.push(hY);hJ._overlays.push(hY);if(hJ._opts.showResult){hY.setOptions({strokeWeight:hJ._dLineStroke,strokeColor:hJ._dLineColor,strokeOpacity:hJ._dOpacity/2,strokeStyle:hJ._dLineStyle})}else{hY.setOptions({strokeWeight:hJ._opts.lineStroke,strokeColor:hJ._opts.lineColor,strokeOpacity:hJ._opts.opacity,strokeStyle:hJ._opts.lineStyle})}if(hJ._mapMoving){hY.hide()}if(hJ._points.length>1){var hP=hJ._paths[hJ._points.length-2];hP.setPointAt(1,hV)}if(hJ._opts.showResult){var hS="";if(hJ._points.length>1){var hW=hJ._setSegDistance(hJ._points[hJ._points.length-2],hJ._points[hJ._points.length-1]);var hT=hJ.getTotalDistance();hS=hJ._formatDisStr(hT)}else{hS="起点"}var hX=new aI(hS,{offset:new bj.Size(10,-5),enableMassClear:hJ._opts.enableMassClear});hX.addEventListener("mouseover",function(){this.__zIndex=this.getDom().style.zIndex;this.getDom().style.zIndex=99999999});hX.addEventListener("mouseout",function(){this.getDom().style.zIndex=this.__zIndex});hX.setStyles({color:"#333",borderColor:"#ff0103"});hX._stCode=hJ._opts.styleCodes.slCode;hJ._map.addOverlay(hX);hJ._formatSegLabel(hX,hS);hJ._overlays.push(hX);hV.disLabel=hX;hX.setPoint(hV)}var hM=new a6("onaddpoint");hM.point=hV;hM.pixel=hJ._map.pointToPixelIn(hV);hM.index=hJ._points.length-1;hJ.dispatchEvent(hM)};var T=function(hT){if(!hJ._isOpen){return}if(hJ._paths.length>0){hT=window.event||hT;var hO=hT.pageX||hT.clientX||0;var hM=hT.pageY||hT.clientY||0;if(typeof hJ._bind.initX==="undefined"){hJ._bind.x=hT.offsetX||hT.layerX||0;hJ._bind.y=hT.offsetY||hT.layerY||0;hJ._bind.initX=hO;hJ._bind.initY=hM}var hV=hJ._bind.x+hO-hJ._bind.initX;var hU=hJ._bind.y+hM-hJ._bind.initY;var h1=hJ._paths[hJ._paths.length-1];var hQ=hJ._map.pixelToPointIn(new eb(hV,hU));if(!hJ._isPointValid(hQ)){hJ.followTitle&&hJ.followTitle.hide();h1.hide()}else{hJ.followTitle&&hJ.followTitle.show();h1.setPointAt(1,hQ);if(!hJ._mapMoving){h1.show()}}var h2=0;var hY=0;if(hV<10){h2=8}else{if(hV>hJ._map.width-10){h2=-8}}if(hU<10){hY=8}else{if(hU>hJ._map.height-10){hY=-8}}if(h2!==0||hY!==0){if(!T._movingTimerId){var hP=hJ._map.offsetX;var hN=hJ._map.offsetY;var hX=hP+h2;var hW=hN+hY;hJ._mapMoving=true;hJ._map.panBy(h2,hY,{noAnimation:true});hJ._bind.i=0;hJ._bind.j=0;T._movingTimerId=setInterval(function(){hJ._map.panBy(h2,hY,{noAnimation:true})},30);hJ._movingTimerId=T._movingTimerId;h1.hide();hJ.followTitle&&hJ.followTitle.hide()}}else{if(T._movingTimerId){clearInterval(T._movingTimerId);delete T._movingTimerId;delete hJ._movingTimerId;var h0=hJ._paths[hJ._paths.length-1];var hZ=hJ._map.pixelToPointIn(new eb(hV,hU));if(!h0){return}if(hJ._isPointValid(hZ)){h0.setPointAt(1,hZ);h0.show()}else{h0.hide()}if(hJ.followTitle){if(hJ._isPointValid(hZ)){hJ.followTitle.setPoint(hZ);hJ.followTitle.show()}else{hJ.followTitle.hide()}}hJ._bind.i=0;hJ._bind.j=0;delete hJ._mapMoving}}if(hJ._opts.showResult&&hJ.followTitle){var hS=hJ.getTotalDistance();var hR=hJ._map.getDistanceIn(hJ._points[hJ._points.length-1],hQ);hJ._updateInstDis(hJ.followTitle.getDom(),hS+hR)}}};var i=function(hM){if(!hJ._isOpen){return}C.un(d9.getDom(hJ._map),"click",hI);C.un(document,"mousemove",T);C.un(d9.getDom(hJ._map),"dblclick",i);setTimeout(function(){hJ.close()},50)};var hL=function(hM){hM=window.event||hM;if(hM.keyCode===27){hJ._clearThis();setTimeout(function(){hJ.close()},50)}};var e=function(hM){hM=window.event||hM;if(hM.keyCode===27){hJ._clearThis();setTimeout(function(){hJ.close()},50)}};var hK=function(hM){hM=window.event||hM;if(hM.button===2){hJ.close()}};hJ._initArrays();if(this._opts.showResult){this._formatTitle()}d9.show(this._map);this.setCursor(this._opts.cursor);C.on(d9.getDom(this._map),"click",hI);C.on(document,"mousemove",T);C.on(d9.getDom(this._map),"dblclick",i);C.on(document,"keydown",hL);C.on(document,"keyup",e);C.on(d9.getDom(this._map),"mouseup",hK);this.bindFunc=[{elem:d9.getDom(this._map),type:"click",func:hI},{elem:d9.getDom(this._map),type:"dblclick",func:i},{elem:document,type:"mousemove",func:T},{elem:document,type:"keydown",func:hL},{elem:document,type:"keyup",func:e},{elem:d9.getDom(this._map),type:"mouseup",func:hK}];return true},_dispatchLastEvent:function(){var e=new a6("ondrawend");e.points=this._points?this._points.slice(0):[];e.overlays=this._paths?this._paths.slice(0,this._paths.length-1):[];if(this._opts.showResult){e.distance=this.getTotalDistance().toFixed(0)}this.dispatchEvent(e)},close:function(){if(this._isOpen===false){return}this._isOpen=false;this._map._toolInUse=false;if(this._mapMoving){delete this._mapMoving}var hI=this;hI._dispatchLastEvent();if(hI._points.length<2){hI._clearThis()}else{hI._map.removeOverlay(hI._paths[hI._paths.length-1]);hI._paths[hI._paths.length-1]=null;hI._paths.length=hI._paths.length-1;var hJ=hI._points[hI._points.length-1];if(hJ.disLabel){hI._map.removeOverlay(hJ.disLabel)}hI._processLastOp()}d9.hide();for(var T=0,e=this.bindFunc.length;T<e;T++){C.un(this.bindFunc[T].elem,this.bindFunc[T].type,this.bindFunc[T].func)}if(hI._movingTimerId){clearInterval(hI._movingTimerId);hI._movingTimerId=null}if(this.followTitle){this.followTitle.hide()}},_bind:function(){fT.prototype._bind.call(this);var e=this;C.on(d9.getDom(e._map),"mousedown",function(i){if(e._map.config.enableKeyboard===true){e._map.temp.canKeyboard=true;h(i)}})},_clearThis:function(){for(var T=0,e=this._points.length;T<e;T++){if(this._points[T].disLabel){this._map.removeOverlay(this._points[T].disLabel)}}for(var T=0,e=this._paths.length;T<e;T++){this._map.removeOverlay(this._paths[T])}for(var T=0,e=this._dots.length;T<e;T++){this._map.removeOverlay(this._dots[T])}this._initArrays()},_initArrays:function(){this._points.length=0;this._paths.length=0;this._segDistance.length=0;this._dots.length=0},_setSegDistance:function(T,i){if(!T||!i){return}var e=this._map.getDistanceIn(T,i);this._segDistance.push(e);return e},getTotalDistance:function(){var hI=0;for(var T=0,e=this._segDistance.length;T<e;T++){hI+=this._segDistance[T]}return hI},_convertUnit:function(e,i){i=i||"metric";if(this._units[i]){return e*this._units[i].conv}return e},_addSectionMarker:function(hI){var T=new g2(eV.imgPath+"distance-tools-1x.png",new bj.Size(12,12),{imageOffset:new bj.Size(0,12),srcSet:{"2x":eV.imgPath+"distance-tools-2x.png"}});var i=new dk(hI,{icon:T,clickable:true,baseZIndex:3500000,zIndexFixed:true,enableDragging:true,enableMassClear:this._opts.enableMassClear});i._stCode=this._opts.styleCodes.spCode;i.disIndex=this._dots.length;var e=this;i.addEventListener("mouseover",function(){e.followTitle.show();e.followTitle.setPoint(this.getPoint());e.followTitle.setContent(e._sectionMarkerTip);e.followTitle.setOffset(e._followTextOffsetNormal);var hJ=e._totalDis[this.disHashCode];if(this.disIndex===hJ.dots.length-1&&hJ.points[hJ.points.length-1].disLabel.getOffset().height>0){e.followTitle.setOffset(e._followTextOffsetUpper)}});i.addEventListener("mouseout",function(){e.followTitle.hide()});i.addEventListener("click",function(){var hR=this.disIndex;var hL=e._totalDis[this.disHashCode];if(!hL){return}var hJ=hL.points.length;if(hJ===2){e._clearDistanceResultByHash(this.disHashCode);e.followTitle.hide();return}var hU=hL.points[hR].disLabel;if(hU){e._map.removeOverlay(hU)}e._map.removeOverlay(this);var hS=null;var hK=null;if(hR>0){hS=hL.paths[hR-1]}if(hR<hL.dots.length-1){hK=hL.paths[hR]}var hO=this.disHashCode;if(hR===0){e._map.removeOverlay(hK);hL.paths.splice(hR,1);e._formatSegLabel(hL.points[1].disLabel,"起点")}else{if(hR===hL.dots.length-1){e._map.removeOverlay(hS);hL.paths.splice(hR-1,1);hL.closeBtn.setPoint(hL.points[hR-1])}else{e._map.removeOverlay(hS);hL.paths.splice(hR-1,1);hK.setPointAt(0,hL.points[hR-1])}}hO=hL.paths[0].hashCode;if(hO!==this.disHashCode){e._totalDis[hO]=hL;delete e._totalDis[this.disHashCode]}hL.dots.splice(hR,1);hL.points.splice(hR,1);e.followTitle.hide();e._segDistance.length=0;for(var hM=0;hM<hL.points.length-1;hM++){e._setSegDistance(hL.points[hM],hL.points[hM+1]);hL.dots[hM].disIndex=hM;hL.dots[hM].disHashCode=hO;if(hM===hL.points.length-2){hL.dots[hM+1].disIndex=hM+1;hL.dots[hM+1].disHashCode=hO}var hQ=e.getTotalDistance();var hP=e._formatDisStr(hQ);var hN=hL.points[hM+1].disLabel;if(hN){hN.setContent(hP);if(hM===hL.points.length-2){e._map.removeOverlay(hN);var hT=[0,0];e._addLastLabel(hL,hT);hL.closeBtn.setOffset(new d1(hT[0],hT[1]))}else{e._formatSegLabel(hN,hP)}}}hL.segDis=e._segDistance.slice(0)});i.addEventListener("dragging",function(hN){var hQ=this.disIndex;var hK=e._totalDis[this.disHashCode];if(!hK){return}var hS=hK.points[hQ].disLabel;if(hS){hK.points[hQ].lng=hN.point.lng;hK.points[hQ].lat=hN.point.lat;hS.setPoint(hN.point)}var hR=null;var hJ=null;if(hQ>0){hR=hK.paths[hQ-1]}if(hQ<hK.dots.length-1){hJ=hK.paths[hQ]}if(hQ===hK.dots.length-1){hK.closeBtn.setPoint(hN.point)}e.followTitle.hide();if(hR){hR.setPointAt(1,hN.point)}if(hJ){hJ.setPointAt(0,hN.point)}e._segDistance.length=0;for(var hL=0;hL<hK.points.length-1;hL++){e._setSegDistance(hK.points[hL],hK.points[hL+1]);var hP=e.getTotalDistance();var hO=e._formatDisStr(hP);var hM=hK.points[hL+1].disLabel;if(hM){hM.setContent(hO);if(hL===hK.points.length-2){e._formatTitle(2,"","",hM)}else{e._formatSegLabel(hM,hO)}}}hK.segDis=e._segDistance.slice(0)});this._map.addOverlay(i);this._dots.push(i)},_formatDisStr:function(hI){var i=this._opts.unit;var T=this._units[i].u1;var e=this._convertUnit(hI,i);if(e>this._units[i].incon){e=e/this._units[i].incon;T=this._units[i].u2;e=e.toFixed(1)}else{e=e.toFixed(0)}return e+T},setCursor:function(e){if(this._opts.showResult===true){d9.setCursor(this._dCursor)}else{this._opts.cursor=e;d9.setCursor(this._opts.cursor)}},_formatSegLabel:function(e,T){var i=e.getDom();i.style.border="none";i.style.padding="0";i.innerHTML=\'<span class="BMap_diso"><span class="BMap_disi">\'+T+"</span></span>"},_processLastOp:function(){var hK=this;delete hK._bind.x;delete hK._bind.y;delete hK._bind.initX;delete hK._bind.initY;if(hK._paths.length>hK._points.length-1){var e=hK._paths.length-1;hK._map.removeOverlay(hK._paths[e]);hK._paths[e]=null;hK._paths.length=e}if(!hK._opts.showResult){return}var T=hK._paths[0].getHashCode();for(var hJ=0;hJ<hK._dots.length;hJ++){hK._dots[hJ].disHashCode=T}var hI=hK._totalDis[hK._paths[0].getHashCode()]={};hI.points=hK._points.slice(0);hI.paths=hK._paths.slice(0);hI.dots=hK._dots.slice(0);hI.segDis=hK._segDistance.slice(0);var hM=[0,0];hK._addLastLabel(hI,hM);var hL=new g2(eV.imgPath+"distance-tools-1x.png",new bj.Size(12,12),{imageOffset:new bj.Size(0,0),srcSet:{"2x":eV.imgPath+"distance-tools-2x.png"}});hI.closeBtn=new dk(hI.points[hI.points.length-1],{icon:hL,offset:new bj.Size(hM[0],hM[1]),baseZIndex:3600000,enableMassClear:hK._opts.enableMassClear});hK._map.addOverlay(hI.closeBtn);hI.closeBtn.getDom().title="清除本次测距";hI.closeBtn.addEventListener("mouseover",function(){this.__zIndex=this.getDom().style.zIndex;if(this.getDom()){this.getDom().style.zIndex=99999999}if(this.siblingElement){this.siblingElement.style.zIndex=99999999}});hI.closeBtn.addEventListener("mouseout",function(){if(this.getDom()){this.getDom().style.zIndex=this.__zIndex}if(this.siblingElement){this.siblingElement.style.zIndex=this.__zIndex}});hI.closeBtn.addEventListener("click",function(hN){var i=hI.paths[0].getHashCode();hK._clearDistanceResultByHash(i);h(hN)});hK._initArrays()},_addLastLabel:function(i,hK){var hJ=this._map.pointToPixelIn(i.points[i.points.length-1]);var hI=this._map.pointToPixelIn(i.points[i.points.length-2]);var e=[0,0];if(hJ.y-hI.y>=0){e=[-5,11]}else{e=[-5,-35]}if(hJ.x-hI.x>=0){hK[0]=14}else{hK[0]=-14}var T=i.points[i.points.length-1];T.disLabel=new aI("",{offset:new bj.Size(-15,-40),enableMassClear:this._opts.enableMassClear});T.disLabel.setStyles({color:"#333",borderColor:"#ff0103"});T.disLabel._stCode=this._opts.styleCodes.tlCode;T.disLabel.addEventListener("mouseover",function(){this.__zIndex=this.getDom().style.zIndex;this.getDom().style.zIndex=99999999});T.disLabel.addEventListener("mouseout",function(){this.getDom().style.zIndex=this.__zIndex});this._map.addOverlay(T.disLabel);T.disLabel.setOffset(new bj.Size(e[0],e[1]));T.disLabel.setPoint(T);this._formatTitle(2,"","",T.disLabel)},_clearDistanceResultByHash:function(T){var hJ=this._totalDis[T];if(!hJ){return}for(var hI=0,e=hJ.points.length;hI<e;hI++){this._map.removeOverlay(hJ.points[hI].disLabel);hJ.points[hI].disLabel=null}for(var hI=0,e=hJ.paths.length;hI<e;hI++){this._map.removeOverlay(hJ.paths[hI]);hJ.paths[hI]=null}for(var hI=0,e=hJ.dots.length;hI<e;hI++){this._map.removeOverlay(hJ.dots[hI]);hJ.dots[hI]=null}this._map.removeOverlay(hJ.closeBtn);hJ.closeBtn=null;delete this._totalDis[T]},_formatTitle:function(hI,hO,e,hK){var hJ=hK||this.followTitle;if(!hJ){return}var T=hJ.getDom();if(!T){return}C.ac(T,"BMap_disLabel");var hQ=T.style;var hP=hJ.content;hQ.zIndex="85";hQ.padding="3px 5px";var hM=[];if(hI===1){hJ.setOffset(0,25);var hN=this._opts.unit;var hL=this._units[hN].u1;var i=this._convertUnit(e,hN);if(i>this._units[hN].incon){i=i/this._units[hN].incon;hL=this._units[hN].u2;i=i.toFixed(1)}else{i=i.toFixed(0)}hM.push(\'<span>总长：<span class="BMap_disBoxDis">\'+i+"</span>"+hL+"</span><br />");hM.push(\'<span style="color:#7a7a7a">\'+hO+"</span>")}else{if(hI===2){var hN=this._opts.unit;var hL=this._units[hN].u1;var i=this._convertUnit(this.getTotalDistance(),hN);if(i>this._units[hN].incon){i=i/this._units[hN].incon;hL=this._units[hN].u2;i=i.toFixed(1)}else{i=i.toFixed(0)}hM.push(\'总长：<span class="BMap_disBoxDis">\'+i+"</span>"+hL);hJ.content="总长："+i+hL}else{hJ.setOffset(0,25);hM.push(hP)}}T.innerHTML=hM.join("")},_updateInstDis:function(hI,e){var i=this._opts.unit;var T=this._units[i].u1;if(e>this._units[i].incon){e=e/this._units[i].incon;T=this._units[i].u2;e=e.toFixed(1)}else{e=e.toFixed(0)}if(hI){hI.children[0].innerHTML=\'总长：<span class="BMap_disBoxDis">\'+e+"</span>"+T}},_hideCurrent:function(){if(!this._isOpen){return}if(this._paths.length>0){var e=this._paths[this._paths.length-1];e.hide()}this.followTitle&&this.followTitle.hide()}});');
