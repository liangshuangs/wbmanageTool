/**/ï»¿_jsload&&_jsload('earth', 'function b(T,e){this._initStartTime=Date.now();d5.call(this);this.radius=500;this._map=T;e=e||{};this._zoom=1;this._center=new cX(0,0);this._heading=0;this._tilt=0;this._minZoom=1;this._maxZoom=T.getMaxZoom()-2;this._guid=bj.getGUID("earth_");this._enableTiltZoom=7;this._enableHeadingZoom=0;this._showRealSunlight=true;this._showMilkyway=true;this._earthBackground=null;this.zoomEventStatus="idle";this._preMoveendFired=true;this._animationInfo={};for(var i in e){if(typeof e[i]!=="undefined"){this["_"+i]=e[i]}}this._mProjection=ef;this._hotspots={length:0};this._layers=[];this._notLoadThumb=false;this._notLoadHigh=false;this.temp={};this._panes={};this._ratio=a1();this.zoomForNight=1;if(this._showRealSunlight===false){this.zoomForNight=0}this._streetLayerVisible=T._isHybridShow;if(this._zoom>15){this._calcRotationInfo()}this._init();this._initFinishTime=Date.now()}bj.Earth=b;b.MIN_TILT=0;b.MAX_CENTER_LAT=90;b.MIN_CENTER_LAT=-90;b.RADIUS=6370996.81;b.NORTH_POLE_LATLNG=new cX(90,0);b.SOUTH_POLE_LATLNG=new cX(-90,0);b.inherits(d5,"Earth");C.extend(b.prototype,{_init:function(){this._sphere=new q(this,this.radius);this._createEarthCanvas();this._bootEarth();this._bindEvent();dt.earth=this;dt.initFPS();var e=this;setTimeout(function(){var hI=dt.getAverageFPS();var T=dt.getHigherAverageFPS();var i=new a6("onfpsdata_ready");i.fps=hI;i.fpsH=T;e.fire(i);dt.clearFPSData()},10000);setTimeout(function(){var hI=dt.getAverageFPS();var T=dt.getHigherAverageFPS();var i=new a6("onfpsdata_ready");i.fps=hI;i.fpsH=T;e.fire(i);dt.stopFPS()},30000)},_createEarthCanvas:function(){var hK=this._map;var hI=hK.getSize();var T=hI.width;var e=hI.height;var i=hK.container;var hL=S("canvas");var hJ=hL.style;hJ.zIndex=1;hJ.position="absolute";hJ.background="#000";hJ.left=hJ.top=0;hJ.width=T+"px";hJ.height=e+"px";hL.width=T*this._ratio;hL.height=e*this._ratio;hq(hL,hK.platform);this._container=i;this._containerSize=new d1(T,e);this._canvas=hL},_bootEarth:function(){this.scene=new gv(this);if(this._showMilkyway&&!this._earthBackground){this.scene.addRenderer(new cf(this))}if(this._earthBackground){this.scene.addRenderer(new ax(this))}this._atmosphereRenderer=new gH(this);this.scene.addRenderer(this._atmosphereRenderer);this.addLayer(new aW(this));if(this._streetLayerVisible===true){this._streetLayer=new gl(this);this.addLayer(this._streetLayer);this.scene.addRenderer(new l(this));this._labelLayer=new dj(this);this.addLayer(this._labelLayer)}else{var e=this._map._hideStreetLayerOptions;if(e.hideStreet===false){this._streetLayer=new gl(this);this.addLayer(this._streetLayer)}this.scene.addRenderer(new l(this));if(e.hideLabels===false){this._labelLayer=new dj(this);this.addLayer(this._labelLayer)}}this.scene.addRenderer(new dn(this));this._map._mouse.setEarthDrag(new ev(this._map,this));this._map._mouse.setEarthWheel(new ar(this._map,this))},_bindEvent:function(){var e=this;var i=e._map;i.on("resize",function(hI){e._containerSize=hI.size;e._imageZoom=null;e._imageRawZoom=null;var T=new a6("onsize_changed");T.size=hI.size;e.fire(T)});this.on("statuschange",function(T){if(T.changedStatus.onzoom_changed){e._calcDragLatLimit();if(e._center.lat>b.MAX_CENTER_LAT||e._center.lat<b.MIN_CENTER_LAT){e.setCenter(e._center.clone(),{noAnimation:true})}}});this.on("ontilt_changed",function(){e._calcDragLatLimit();if(e._center.lat>b.MAX_CENTER_LAT||e._center.lat<b.MIN_CENTER_LAT){e.setCenter(e._center.clone(),{noAnimation:true})}})},setZoom:function(T,e){e=e||{};T=fx(T,this._minZoom,this._maxZoom);if(this._zoom===T){e.callback&&e.callback();return}var i=this;if(this.zoomEventStatus==="idle"){this.fire(new a6("onzoomstart"));this.zoomEventStatus="zooming"}if(e.noAnimation){this._setValue("zoom",T);if(e.renderCallback){e.renderCallback()}this._checkFireZoomend();return}this._animationInfo.zoom={current:this._zoom,diff:T-this._zoom,target:T};var i=this;e.callback=function(){i._checkFireZoomend()};if(e.opMethod==="mouseWheel"){this._startInfiniteZoomAnimation(e);return}this._startAnimation(e)},_checkFireZoomend:function(){var e=this;if(e.fireZoomendTimer){clearTimeout(e.fireZoomendTimer)}e.fireZoomendTimer=setTimeout(function(){if(e.zoomEventStatus==="zooming"){e.fire(new a6("onzoomend"));e.zoomEventStatus="idle"}e.fireZoomendTimer=null},50)},setImageZoom:function(i,e){this.setZoom(this._getEarthZoomByImgZoom(i),e)},_setValue:function(e,i){if(e==="zoom"){this._preZoom=this._zoom;this._imageZoom=null;this._imageRawZoom=null}this["_"+e]=i;if((e==="center"||e==="zoom")&&this._zoom>15){this._calcRotationInfo()}this.fire(new a6("on"+e+"_changed"))},_setValueTick:function(e,hJ,hI,i){if(e==="center"){var T=new cX(hJ.lat+hI.lat*i,hJ.lng+hI.lng*i);this._setValue(e,T);return}this._setValue(e,hJ+hI*i)},setCenter:function(e,i){i=i||{};e.lat=fx(e.lat,b.MIN_CENTER_LAT,b.MAX_CENTER_LAT);if(this._center.equals(e)){return}var T=this;if(!i.noFireEvent){if(this._preMoveendFired){T.fire(new a6("onmovestart"));this._preMoveendFired=false}i.mapNeedCbk=function(){T.fire(new a6("onmoveend"))}}if(i.stopCurrentAnimation&&this._ani){this._ani.stop(false,{stopCurrentAnimation:true})}if(i.noAnimation){this._center=e;if(this._zoom>15){this._calcRotationInfo()}this.fire(new a6("oncenter_changed"));if(!i.noFireEvent){this.fire(new a6("onmoving"));if(this._moveendTimer){clearTimeout(this._moveendTimer)}var T=this;this._moveendTimer=setTimeout(function(){T.fire(new a6("onmoveend"));T._preMoveendFired=true;T._moveendTimer=null},60)}if(i.callback){i.callback()}return}this._animationInfo.center={current:this._center,diff:e.sub(this._center)};this._startAnimation(i)},_calcRotationInfo:function(){var T=this._center;var hJ=Math.sin(dE(T.lat));var hI=Math.cos(dE(T.lat));var i=Math.sin(dE(-T.lng-180));var e=Math.cos(dE(-T.lng-180));this.rotationInfo=[hJ,hI,i,e]},setViewportIn:function(i,T){var e;if(i&&i.center){e=i}else{e=this.getViewportIn(i,T)}var hI=e.earthZoom||e.zoom;T=T||{};if(this._ani){this._ani.stop(false,{stopCurrentAnimation:T.stopCurrentAnimation})}this.centerAndZoomIn(e.center,hI,T.callback)},setHeading:function(hI,i){i=i||{};if(hI===this._heading){i.callback&&i.callback();return}var T=fR(this._heading,360);var e=fR(hI,360);if(e===T){this._heading=hI;return}if(i&&i.noAnimation){this._setValue("heading",hI);i.callback&&i.callback();return}this._animationInfo.heading={current:this._heading,diff:hI-this._heading};this._startAnimation(i)},resetHeading:function(e){var i=this._heading;while(i<0){i+=360}i=i%360;if(i>180){i-=360}this._heading=i;this.setHeading(0,e)},setTilt:function(e,i){i=i||{};if(e===this._tilt){i.callback&&i.callback();return}e=fx(e,b.MIN_TILT,this._map.getCurrentMaxTilt());if(i.noAnimation){this._setValue("tilt",e);i.callback&&i.callback();return}this._animationInfo.tilt={current:this._tilt,diff:e-this._tilt};this._startAnimation(i)},centerAndZoomIn:function(e,hI,hJ){hI=fx(hI,this._minZoom,this._maxZoom);e.lat=fx(e.lat,b.MIN_CENTER_LAT,b.MAX_CENTER_LAT);var i=bj.EarthAnimation.start(this,e,hI,hJ);if(i===false){var T={noAnimation:true};this.setCenter(e,T);this.setZoom(hI,T);hJ&&hJ()}},mathLog2:function(e){return Math.log(e)/Math.log(2)},getViewportIn:function(hW,hL){var hQ;if(hW.length>0){hQ=new ey();for(var hX=0,hU=hW.length;hX<hU;hX++){hQ.extend(hW[hX])}}else{if(hW instanceof ey){hQ=hW}else{return{center:this.getCenter(),zoom:this.getZoom(),imageZoom:this.getImageZoom()}}}hL=hL||{};var e=hL.margins||[10,10,10,10];var hM=hL.zoomFactor||0;var hY=e[1]+e[3];var hJ=e[0]+e[2];var hT=hQ.getSouthWest();var hO=hQ.getNorthEast();var hS=hO.lat-hT.lat;var h1=ef.convertLL2MC(hT);var T=ef.convertLL2MC(hO);var hP=new dM(h1,T);var hZ;if(hL.mapCenter){hZ=ef.convertMC2LL(hL.mapCenter)}else{hZ=hQ.getCenter()}var hK=hP.toSpan();var hI=hK.width/(this._containerSize.width-hY);var hN=hK.height/(this._containerSize.height-hJ);var hR=hI>hN?hI:hN;var hV=18-this.mathLog2(hR);var h0=Math.floor(hV);h0+=hM;return{center:hZ,zoom:h0}},getZoom:function(){return this._zoom},zoomIn:function(e){this.setZoom(this.getZoom()+1,e)},zoomOut:function(e){this.setZoom(this.getZoom()-1,e)},getCenter:function(){return this._center},getHeading:function(){return this._heading},getTilt:function(){return this._tilt},getContainerSize:function(){return this._containerSize},getContainer:function(){return this._container},fromPixelToLatLng:function(i,e){return this.scene.fromPixelToLatLng(i,e)},fromLatLngToPixel:function(T,i){i=i||{};var e=this.scene.fromLatLngToPixel(T,i);if(!i.useRound){return e}e.x=Math.round(e.x);e.y=Math.round(e.y);return e},ifLatLngInView:function(i){var e=this.scene.fromLatLngToXYZ(i);return this.scene.ifXYZInView(e[0],e[1],e[2])},saveMatrixInfo:function(){this.scene.saveMatrixInfo()},getBounds:function(){return this.scene.getBounds()},getCustomBounds:function(){return this.scene.getCustomBounds()},getProjection:function(){return this._mProjection},getSunZenith:function(){return this.scene._camera.getSunZenith()},_startAnimation:function(i){var hI=this._animationInfo;var T=this;i=i||{};if(T._ani){T._ani.stop(!!i.goToEnd,{stopCurrentAnimation:i.stopCurrentAnimation})}if(T._infiniteAni){T._infiniteAni.stop();T._infiniteAni=null}var hJ=i.duration||500;var hK=i.transition||ci.easeOutQuad;var e=new a6("onanimation_start");this.fire(e);T._ani=new o({duration:hJ,transition:hK,render:function(hN,hM){for(var hL in hI){var hP=hI[hL].current;var hO=hI[hL].diff;T._setValueTick(hL,hP,hO,hN)}if(i.renderCallback){i.renderCallback()}},finish:function(){T.fire(new a6("onanimation_end"));T._animationInfo={};T._ani=null;if(i.mapNeedCbk){i.mapNeedCbk()}if(i.callback){i.callback()}},onStop:function(hL){hL=hL||{};T.fire(new a6("onanimation_end"));if(hL.stopCurrentAnimation){T._animationInfo={}}T._ani=null;if(hL.mapNeedCbk){hL.mapNeedCbk()}if(hL.callback){hL.callback()}}})},_startInfiniteZoomAnimation:function(i){var hI=this._animationInfo;var T=this;i=i||{};if(T._ani){T._ani.stop(!!i.goToEnd,{stopCurrentAnimation:i.stopCurrentAnimation})}if(T._infiniteAni){return}var e=new a6("onanimation_start");this.fire(e);T._infiniteAni=new o({duration:10000,transition:ci.linear,render:function(hL,hK){var hJ=T._animationInfo.zoom;if(Math.abs(hJ.current-hJ.target)<0.001){T._setValue("zoom",hJ.target);T._infiniteAni.stop();return}hJ.current+=(hJ.target-hJ.current)*0.35;T._setValue("zoom",hJ.current);if(i.renderCallback){i.renderCallback()}},finish:function(){T._infiniteAni=null;T._animationInfo={};T.fire(new a6("onanimation_end"));if(i.callback){i.callback()}},onStop:function(){T._infiniteAni=null;T._animationInfo={};T.fire(new a6("onanimation_end"));if(i.callback){i.callback()}}})},_generateTmpPMatrix:function(i){var hI=mat4.create(Float64Array);mat4.identity(hI);var T=this.getContainerSize();this._widthHeightRatio=T.width/T.height;i=i||this.getZoom();var e;if(i<=3){e=70-10*i}else{e=40}mat4.perspective(hI,dE(e),this._widthHeightRatio,0.01,6000);return hI},_generateTmpMVMatrix:function(e,hL,hM,hN){var T=mat4.create(Float64Array);mat4.identity(T);hL=hL||this.getZoom();var i;if(hL<=3){i=3.4*this.radius-0.8*this.radius*hL}else{i=this.radius/Math.pow(2,hL-3)}mat4.translate(T,T,[0,0,-i]);if(typeof hM!=="number"){hM=this.getTilt()}if(hM!==0&&hL<6){if(hL>=4){hM=(1-(6-hL)/2)*hM}else{hM=0}}if(hM!==0){mat4.rotate(T,T,dE(hM),[-1,0,0])}if(typeof hN!=="number"){hN=this.getHeading()%360}else{hN=hN%360}mat4.translate(T,T,[0,0,-this.radius]);if(hN!==0){mat4.rotate(T,T,dE(hN),[0,0,-1])}e=e||this.getCenter();var hJ=e.lat;mat4.rotate(T,T,dE(hJ),[1,0,0]);var hI=180;var hK=e.lng;mat4.rotate(T,T,dE(hI+hK),[0,-1,0]);return T},addLayer:function(hI){var hJ=new a6("onlayer_add");hJ.layer=hI;for(var T=0;T<this._layers.length;T++){if(this._layers[T]===hI){return}}this._layers.push(hI);this.fire(hJ)},removeLayer:function(hI){var hJ=new a6("onlayer_remove");hJ.layer=hI;for(var T=0;T<this._layers.length;T++){if(this._layers[T]===hI){this._layers.splice(T,1);this.fire(hJ);return}}},addHotspot:function(e){if(!this._hotspots[e.guid]){this._hotspots[e.guid]=e;this._hotspots.length++}e.initialize(this);this.fire(new a6("onhotspot_add"))},removeHotspot:function(e){if(this._hotspots[e.guid]){delete this._hotspots[e.guid];this._hotspots.length--}this.fire(new a6("onhotspot_remove"))},setNotLoadThumb:function(e){this._notLoadThumb=e},setNotLoadHigh:function(e){this._notLoadHigh=e},getDistance:function(hK,e){var T=dE(hK.lng);var hJ=dE(hK.lat);var i=dE(e.lng);var hI=dE(e.lat);return b.RADIUS*Math.acos((Math.sin(hJ)*Math.sin(hI)+Math.cos(hJ)*Math.cos(hI)*Math.cos(i-T)))},getImageZoom:function(hM){if(hM!==true&&this._imageZoom){return this._imageZoom}var i=this._containerSize.width;var hR=this._containerSize.height;var hL=hR/6;var hO=null;var e=new cX(39,116);if(this._zoom<=3){e=new cX(0,0);hO=this._generateTmpPMatrix(this._zoom)}var hI=this._generateTmpMVMatrix(e,this.getZoom(),0,0);var hP=this.fromPixelToLatLng(new eb(i/2,hR/2-hL),{matrixInfo:{modelViewMatrix:hI,projectionMatrix:hO}});var T=this.fromPixelToLatLng(new eb(i/2,hR/2+hL),{matrixInfo:{modelViewMatrix:hI,projectionMatrix:hO}});var hK=ef.convertLL2MC(hP);var hQ=ef.convertLL2MC(T);var hJ=Math.abs(hK.lat-hQ.lat);var hS=this._imageRawZoom=18-this.mathLog2(hJ/hR*3);if(hM===true){return hS}var hN=(hS*10)%10>=7?Math.ceil(hS):Math.floor(hS);if(hN-this._zoom>2.5){hN=Math.floor(this._zoom+2)}this._imageZoom=hN;if(this._imageZoom>19){this._imageZoom=19}if(this._imageZoom<3){this._imageZoom=3}return this._imageZoom},getMapZoom:function(){return this.getImageZoom(this._map._renderType==="webgl")},_getEarthZoomByImgZoom:function(hT,hV,hL){var hR=this._containerSize.width;var hQ=this._containerSize.height;hV=hV||this._center;if(!hL){var hO=ef.convertLL2MC(hV);var hN=hQ/3*Math.pow(2,18-hT);var hX=new hj(hO.lng,hO.lat-hN/2);var i=new hj(hO.lng,hO.lat+hN/2);hL=ef.convertMC2LL(i).lat-ef.convertMC2LL(hX).lat}var hI;var hU=180;var e=hQ/3;var T=2/3*hQ;for(var hJ=hT;hJ>=hT-3;hJ-=0.1){var hK=null;if(hJ<3&&this._zoom>=3||hJ>=3&&this._zoom<3){this._generateTmpPMatrix(hJ)}var hM=this._generateTmpMVMatrix(hV,hJ,0,0);var hW=this.fromPixelToLatLng(new eb(hR/2,e),{matrixInfo:{modelViewMatrix:hM,projectionMatrix:hK}});var hS=this.fromPixelToLatLng(new eb(hR/2,T),{matrixInfo:{modelViewMatrix:hM,projectionMatrix:hK}});var hP=Math.abs((hW.lat-hS.lat)-hL);if(hP<hU){hU=hP}else{break}}hJ+=0.1;if(hJ<1){hJ=1}else{if(hJ>this._maxZoom){hJ=this._maxZoom}}return hJ},getEarthCanvas:function(){return this._canvas},getMap:function(){return this._map},showStreetLayer:function(){if(this._streetLayerVisible===true){return}this._streetLayerVisible=true;this.addLayer(this._streetLayer);this.addLayer(this._labelLayer);this._map.fire(new a6("onstreetlayer_show"))},hideStreetLayer:function(e){if(this._streetLayerVisible===false){return}this._streetLayerVisible=false;e=e||{hideLabels:true,hideStreet:true};if(e.hideLabels){this.removeLayer(this._labelLayer)}if(e.hideStreet){this.removeLayer(this._streetLayer)}this._map.fire(new a6("onstreetlayer_hide"))},startSunLightAnimation:function(){bj.EarthAnimation.startSunLightAnimation(this)},stopSunLightAnimation:function(e){bj.EarthAnimation.stopSunLightAnimation(this,e)},setTimeForSunLight:function(i,T){if(i===null){this._timeForSunLight=null;this.fire(new a6("onsunlighttime_clear"));return}this._timeForSunLight={hour:i,minute:T};var e=new a6("onsunlighttime_change");e.timeForSunLight=this._timeForSunLight;this.fire(e)},getDeviceInfo:function(){return this._deviceInfo},setLock:function(e){this._lock=e},getLock:function(){return this._lock},_calcDragLatLimit:function(){var hJ=this.scene._camera.getEarthRadiusOnScreen();var i=this.getContainerSize().height/2;var hI;if(hJ>i){hI=30}else{b.MAX_CENTER_LAT=46;b.MIN_CENTER_LAT=-46;return}var e=new cX(0,0);var T=this._generateTmpMVMatrix(e,0,0,0);var hM=null;if(this._zoom<=3){hM=this._generateTmpPMatrix(this._zoom)}var hL=this.fromPixelToLatLng(new eb(this.getContainerSize().width/2,hI),{matrixInfo:{modelViewMatrix:T,projectionMatrix:hM}});if(!hL){return}var hK=hL.sub(e);b.MAX_CENTER_LAT=90-Math.abs(hK.lat);b.MIN_CENTER_LAT=-90+Math.abs(hK.lat)},zoomWithMousePosFix:function(hI,hM,hN){if(hI<1.3&&hN&&hN.opMethod==="mouseWheel"){hI=1}var e=this.fromPixelToLatLng(hM);var hJ={from:"mouse"};hN=hN||{};C.extend(hJ,hN);if(!e){this.setZoom(hI,hJ);return}var i=this.getCenter().clone();var hK=this;var hL=null;if(hI<=3){hL=hK._generateTmpPMatrix(hI)}var T=hK.fromPixelToLatLng(hM,{matrixInfo:{modelViewMatrix:hK._generateTmpMVMatrix(i,hI),projectionMatrix:hL}});if(!T){this.setZoom(hI,hJ);return}hJ.renderCallback=function(){var hS=null;var hQ=hK.getZoom();if(hQ<=3){hS=hK._generateTmpPMatrix(hQ)}var hR=hK.fromPixelToLatLng(hM,{matrixInfo:{modelViewMatrix:hK._generateTmpMVMatrix(i,hQ),projectionMatrix:hS}});if(hR){var hP=hR.sub(e);var hO=new cX(i.lat-hP.lat,i.lng-hP.lng);hK.setCenter(hO,{noAnimation:true,from:"mouse",noFireEvent:true})}};this.setZoom(hI,hJ)}});function ei(){}bj.EarthView=ei;C.extend(ei.prototype,{centerAndZoomIn:function(e,hI){if(!e&&!hI){return}e=e||this.centerPoint;hI=hI||this.zoomLevel;hI=this._getProperZoom(hI).zoom;var i=ef.convertMC2LL(e);var T=this._earth._getEarthZoomByImgZoom(hI,i);this._earth.centerAndZoomIn(i,T)},zoomTo:function(hJ,i){var hI=i;if(!hI&&this.temp.infoWin&&this.temp.infoWin.isOpen()){hI=this.getInfoWindow().getPoint()}if(hI){var e=this.pointToPixelIn(hI);var T=this._earth._getEarthZoomByImgZoom(hJ);this._earth.zoomWithMousePosFix(T,e)}else{this._earth.setImageZoom(hJ)}},deepZoomMedia:function(e){var i=this;if(!i.temp.isStdCtrlBusy){i.temp.isStdCtrlBusy=true;i.deepZoomTo(i.zoomLevel+e);setTimeout(function(){i.temp.isStdCtrlBusy=false},400)}},deepZoomTo:function(e){this.zoomTo(e)},flyToIn:function(e,hI){if(!hI||hI===this.zoomLevel){this.panToIn(e);return}var T=ef.convertMC2LL(e);var i=this._earth._getEarthZoomByImgZoom(hI,T);this._earth.centerAndZoomIn(T,i)},panToIn:function(e,hI){if(!e||e.toString()!=="Point"){return}if(e.equals(this.centerPoint)){return}var i=new eb(this.width/2,this.height/2);var T=ef.convertMC2LL(e);e._llPt=T;var hJ=this.pointToPixelIn(e);hI=hI||{};if(Math.abs(i.x-hJ.x)>this.width||Math.abs(i.y-hJ.y)>this.height||hI.noAnimation===true){this._earth.setCenter(T,{noAnimation:true,callback:hI.callback})}else{this._earth.setCenter(T,hI)}},panBy:function(hQ,hM,hP){var hK=this._earth.getCenter();var hO=this.getSize();hP=hP||{};var hI;if(!hP.point){hI=new eb(hO.width/2+hQ,hO.height/2+hM)}else{var hJ=ef.convertMC2LL(hP.point);var hN=this._earth.fromLatLngToPixel(hJ);hI=new eb(hN.x+hQ,hN.y+hM);hK=new cX(hJ.lat,hJ.lng)}var hL=this._earth.fromPixelToLatLng(hI);var T=hL.sub(hK);var e=this._earth.getCenter();var i=new cX(e.lat-T.lat,e.lng-T.lng);this._earth.setCenter(i,hP)},getCenterIn:function(){var e=this._earth.getCenter();return ef.convertLL2MC(e)},getZoom:function(){if(this._renderType==="webgl"){return this._earth.getImageZoom(true)}return this._earth.getImageZoom()}});var eQ={_zoomAni:null,_zoomAni2:null,_posAni:null,start:function(hI,i,hS,hO){var hU=hI.getCenter();var T=hI.getZoom();if(i.equals(hI.getCenter())&&hS!==hI.getZoom()){hI.setZoom(hS,{callback:hO});return{}}var hM=hI.getDistance(i,hU)/1000;if(hM<100&&hS!==hI.getZoom()){return false}if(hM<100&&hS===hI.getZoom()){hI.setCenter(i,{callback:hO});return{}}if(i.equals(hI.getCenter())&&hS===hI.getZoom()){return false}hI.setLock(true);var hV=null;var hP=null;var hJ=new cX((hU.lat+i.lat)/2,(hU.lng+i.lng)/2);hV=hI._generateTmpMVMatrix(hJ,hS);if(hS<=3){hP=hI._generateTmpPMatrix(hS)}var hK={matrixInfo:{modelViewMatrix:hV,projectionMatrix:hP}};var hY=hI.fromLatLngToPixel(hU,hK);var hQ=hI.fromLatLngToPixel(i,hK);var hL=Math.sqrt(Math.pow(hY.x-hQ.x,2)+Math.pow(hY.y-hQ.y,2));var hN=hS;while(hL>350){hN-=1;hL/=2}hN=hN<1.1?1.1:hN;hN=hN>17?17:hN;var hT=Math.min(Math.min(hN,T),hS);var hX=hT-T;var hZ=hS-hT;var h0=i.sub(hU);var hW=1100;var e=1200;var hR=2000;hI.setNotLoadHigh(true);if(eQ._zoomAni){eQ._zoomAni.stop()}eQ._zoomAni=new o({duration:hW,transition:ci.easeOutCubic,render:function(h2,h1){if(h1>0.8){hI.setNotLoadThumb(false)}if(T+hX*h2<1){throw"error"}hI._setValue("zoom",T+hX*h2)},finish:function(){eQ._zoomAni=null},onStop:function(h1){eQ._zoomAni=null}}).append(function(){eQ._zoomAni2=new o({duration:e,delay:1100,transition:ci.easeInCubic,render:function(h2,h1){if(h1>0.8){hI.setNotLoadThumb(false)}if(hT+hZ*h2<1){throw"error"}hI._setValue("zoom",hT+hZ*h2)},finish:function(){hI.setNotLoadHigh(false);hI._setValue("zoom",hS);eQ._zoomAni2=null;hO&&hO();hI.setLock(false);hI.fire(new a6("oncenterandzoom"))},onStop:function(h1){eQ._zoomAni2=null;hO&&hO();hI.setLock(false);hI.fire(new a6("oncenterandzoom"))}})});if(eQ._posAni){eQ._posAni.stop()}eQ._posAni=new o({duration:hR,delay:500,transition:ci.easeInOutQuad,render:function(h2,h1){hI._setValue("center",new cX(hU.lat+h0.lat*h2,hU.lng+h0.lng*h2))},finish:function(){eQ._posAni=null},onStop:function(h1){eQ._posAni=null}});return{zoomAniStart:eQ._zoomAni,zoomAniEnd:eQ._zoomAni2,posAni:eQ._posAni}},stop:function(){eQ._zoomAni&&eQ._zoomAni.stop();eQ._zoomAni2&&eQ._zoomAni2.stop();eQ._posAni&&eQ._posAni.stop();eQ._zoomAni=eQ._zoomAni2=eQ._posAni=null},startFirstAnimation:function(hQ){var hP=false;try{hP=!!window.localStorage.getItem("show_first_earth_ani")}catch(hM){hP=true}if(hP){return false}var hI=hQ.getCenter();var hS=hQ.getZoom();var T=hQ.getSunZenith();var i=new cX(-T.lat,T.lng+180);var hR=hI.sub(i);hQ._firstAni=true;hQ.setLock(true);hQ.setZoom(hQ.zoomForNight,{noAnimation:true});hQ.setCenter(i,{noAnimation:true});var hJ=6000;var hO=3000;var hN=hJ+1700;var hK=new o({duration:hJ,delay:1600,transition:ci.easeInOutQuad,render:function(e){hQ.setCenter(new cX(i.lat+hR.lat*e,i.lng+hR.lng*e),{noAnimation:true})}});var hL=new o({duration:hO,delay:hN,transition:ci.easeInOutQuad,render:function(e){if(e>0.2&&e<0.4){hQ.setNotLoadHigh(true)}hQ.setZoom(hQ.zoomForNight+(hS-hQ.zoomForNight)*e,{noAnimation:true})},finish:function(){hQ.setNotLoadHigh(false);hQ._firstAni=false;hQ.zoomForNight=1;hQ.setLock(false)},onStop:function(){hQ.setNotLoadHigh(false);hQ._firstAni=false;hQ.zoomForNight=1;hQ.setLock(false)}});try{window.localStorage.setItem("show_first_earth_ani",true)}catch(hM){}return{firstCenterAni:hK,firstZoomAni:hL}},startSunLightAnimation:function(hL){if(this._sunLightAni){return}if(hL.getLock()){return}this._originCenter=new cX(hL.getCenter().lat,hL.getCenter().lng);this._originZoom=hL.getZoom();var T=hL.getSunZenith();var hK=new cX(T.lat,T.lng-90);var hI=this;var i=new Date();var e=i.getHours();var hJ=i.getMinutes()-0.5;if(hJ<0){hJ+=60;e--}hL.setLock(true);hL.centerAndZoomIn(hK,hL.zoomForNight,function(){hL.setLock(false);if(hI._sunLightAni){return}hI._sunLightAni=new o({duration:9999999,render:function(hM){hJ+=0.5;if(hJ===60){hJ=0;e++}hL.setTimeForSunLight(e,hJ);hK.lng=hL.getSunZenith().lng-90;hL.setCenter(new cX(hK.lat,hK.lng),{noAnimation:true});if(hL._zoom!==hL.zoomForNight){hI.stopSunLightAnimation(hL,true)}}})})},stopSunLightAnimation:function(i,e){if(!this._sunLightAni){return}if(i.getLock()){return}this._sunLightAni.stop();this._sunLightAni=null;if(e){i.setTimeForSunLight(null);return}i.setLock(true);i.centerAndZoomIn(this._originCenter,this._originZoom,function(){i.setLock(false);i.setTimeForSunLight(null)})}};bj.EarthAnimation=eQ;function bl(T){var i=T.getExtension("WEBGL_debug_renderer_info");if(!i){return null}var hI=T.getParameter(i.UNMASKED_VENDOR_WEBGL);var e=T.getParameter(i.UNMASKED_RENDERER_WEBGL);return{vendor:hI,renderer:e}}var dt={_fps:0,fps:0,currentTime:null,preFrameTimeStamp:Date.now(),fpsArr:[],averageFPS:0,higherAverageFPS:0,averageTimeInterval:30,initFPS:function(){dt._fps++;dt.currentTime=Date.now();if(dt.currentTime-dt.preFrameTimeStamp>=1000){dt.fps=dt._fps;dt.fpsArr.push(dt.fps);if(dt.fpsArr.length===dt.averageTimeInterval){dt._calcAverageFPS()}dt._fps=0;dt.preFrameTimeStamp=dt.currentTime;var e=new a6("onfpstick");e.fps=dt.fps;dt.earth._map.fire(e)}dt.timer=requestAnimationFrame(dt.initFPS)},_calcAverageFPS:function(){var hI=0;var e=0;dt.fpsArr.sort(function(hK,i){return i-hK});var hJ=dt.fpsArr.length*0.8;for(var T=0;T<dt.fpsArr.length;T++){if(T===hJ){e=hI}hI+=dt.fpsArr[T]}dt.averageFPS=Math.round(hI/dt.fpsArr.length);dt.higherAverageFPS=Math.round(e/hJ);dt.fpsArr=[]},getAverageFPS:function(){if(dt.averageFPS===0){dt._calcAverageFPS()}return dt.averageFPS},getHigherAverageFPS:function(){if(dt.higherAverageFPS===0){dt._calcAverageFPS()}return dt.higherAverageFPS},stopFPS:function(){if(dt.timer){cancelAnimationFrame(dt.timer);dt.timer=null}},clearFPSData:function(){dt.averageFPS=0;dt.higherAverageFPS=0}};function q(hI,e,T){this._earth=hI;var i=this._mcPrj=hI.getProjection();this._radius=e;this._options={};T=T||{};C.extend(this._options,T);this._rowPrecisionPerTile=1;this._colPrecisionPerTile=1;this._mc180Pt=i.convertLL2MC(new cX(0,180));this._mcM180Pt=i.convertLL2MC(new cX(0,-180));this._mcMergeY=8388608;this._mcNorthLat=74;this._mcSouthLat=-60;this._polarModelsCache={1:{n:null,s:null},2:{n:null,s:null},3:{n:null,s:null}};this._ERTileModelInfo=null;this._mergedTilesCache={}}q.totalTileCount=0;q.cachedTileCount=0;q._tileModelInfoCache=new fC(1000,{removeOldCallback:function(){if(window.map&&window.map._earth){var i=new a6("ontilemodelcache_full");i.cacheUsage=q.cachedTileCount/q.totalTileCount;window.map._earth.dispatchEvent(i)}}});q.getMergedKey=function(e,hI,i){var T=q.getMergedColRow(i,e,hI);return["key_merge",T[0],T[1],i].join("_")};q.getMergedColRow=function(i,e,T){return[Math.floor(e/2),Math.floor(T/2)]};q.getMergedTextureOffset=function(e,T){var i=[];i[0]=(Math.abs(e)%2)/2;i[1]=(Math.abs(T)%2)/2;return i};C.extend(q.prototype,{getCurViewModels:function(i,hL,hP){var hN=this._earth.getImageZoom();var hK=this.getTileModels(i,hL,hP,hN);var hI=hK[0];var hJ=hK[1];if(i._addBounds){hK=this.getTileModels(i._addBounds,hL,hP,hN);hI=hI.concat(hK[0])}var hM=this.removeExtraTiles(hI)||[];var hO=this.mergeTiles(hM)||[];if(hP<this._earth.zoomForNight+1){var e=this.getERTileModels();this._sortByImgZoom(hO);var T=hO.concat(e);this._generateNormalModels(hM);return T}if(hO.length>300){hO=hO.slice(0,300)}this._sortByImgZoom(hO);this._sortByImgZoom(hM);this._generateNormalModels(hM,hJ);return hO},_generateNormalModels:function(hJ,T){var e=hJ.slice(0);for(var hI=e.length-1;hI>=0;hI--){if(e[hI].key&&e[hI].key.indexOf("_er_")>0){e.splice(hI,1);continue}}this._curViewNormalModels=e;this._curViewNormalNAModels=T},getCurViewNormalModels:function(e){if(!e||e.getName()==="web"){return this._curViewNormalModels}return this._curViewNormalNAModels},removeExtraTiles:function(hY){var hW=hY.slice(0);var T=this._earth;var ia=T.getBounds();var e=T.getZoom();var hI=T.getContainerSize();var hK=T.getImageZoom();var hO=this._mcPrj;if(e>2&&e<6&&ia.holeAtTopLeft||hW.length>90){var h8=250;var h0=230;for(var h7=hW.length-1;h7>=0;h7--){if(!hW[h7].bounds){continue}hW[h7].atEdge=false;var h5=hW[h7].bounds[0];var h1=hW[h7].bounds[1];var hS=new hj(h1.lng,h5.lat);var h3=new hj(h5.lng,h1.lat);var h9=new hj((h5.lng+h1.lng)/2,(h5.lat+h1.lat)/2);var hT=hO.convertMC2LL(h9);var hQ=T.scene.fromLatLngToXYZ(hT);var hP=T.scene.fromLatLngToPixel(hT);var hL=T.scene.ifXYZOnBack(hQ.x,hQ.y,hQ.z,h8);if(hL){hW.splice(h7,1);continue}hL=T.scene.ifXYZOnBack(hQ.x,hQ.y,hQ.z,-50);if(hL){if(hW[h7].imgZoom===hK){hW[h7].atEdge=true}continue}if(hP.x<0-h0||hP.x>hI.width+h0||hP.y<0-h0||hP.y>hI.height+h0){hW.splice(h7,1);continue}if(hP.x<50||hP.x>hI.width-50||hP.y<50||hP.y>hI.height-50){if(hW[h7].imgZoom===hK){hW[h7].atEdge=true}}}return hW}if((T.getTilt()===0&&T.getHeading()%90===0)||T.getZoom()<5){return hW}var hJ=ia.pointBottomLeft;var h4=ia.pointTopRight;var hV=ia.pointTopLeft;var hR=ia.pointBottomRight;if(!hJ||!h4||!hV||!hR){return hW}for(var h7=hW.length-1;h7>=0;h7--){if(!hW[h7].bounds){continue}var h5=hW[h7].bounds[0];var h1=hW[h7].bounds[1];var hS=new hj(h1.lng,h5.lat);var h3=new hj(h5.lng,h1.lat);var h9=new hj((h5.lng+h1.lng)/2,(h5.lat+h1.lat)/2);var hT=hO.convertMC2LL(h9);var hQ=T.scene.fromLatLngToXYZ(hT);var hN=T.scene.ifXYZInView(hQ.x,hQ.y,hQ.z);var hX=[h3,h1,hS,h5];if(!hN){var hM=false;for(var h2=0,hU=hX.length;h2<hU;h2++){var hZ=h2+1;if(hZ===hU){hZ=0}var h6=h2;var ib=go(hX[hZ],hX[h6],hV,hJ);if(ib){hM=true;break}ib=go(hX[hZ],hX[h6],hR,h4);if(ib){hM=true;break}ib=go(hX[hZ],hX[h6],h4,hV);if(ib){hM=true;break}ib=go(hX[hZ],hX[h6],hJ,hR);if(ib){hM=true;break}}if(hM===true){continue}hW.splice(h7,1)}}return hW},mergeTiles:function(T){var e=this._mergedTilesCache;var hK=[];for(var hO=T.length-1;hO>=0;hO--){var hP=T[hO];var hR=hP.imgZoom;if(hR>5||hP.projType==="er"){continue}var hJ=hP.col;var hT=hP.row;var hN=q.getMergedKey(hJ,hT,hR);if(!e[hN]){var hL=q.getMergedColRow(hR,hJ,hT);e[hN]={key:hN,vertex:[],index:[],texture:null,textureCoord:[],mergedTile:true,col:hL[0],row:hL[1],imgZoom:hR,useZoom:hP.useZoom,tileCount:0,mergeInfo:[]}}var hI=e[hN];if(!hI.mergeInfo[hJ+"_"+hT]){var hM=this.addOffsetToIndex(hP.index,hI.vertex.length);hI.vertex=hI.vertex.concat(hP.vertex);hI.index=hI.index.concat(hM);var hQ=q.getMergedTextureOffset(hJ,hT);var hS=this.addOffsetToTexCoords(hP.textureCoord,hQ);hI.textureCoord=hI.textureCoord.concat(hS);hI.tileCount++;hI.mergeInfo[hJ+"_"+hT]=true;hI.textureCoord._dir=hP.textureCoord._dir}if(!hK[hN]){hK.push(hI);hK[hN]=true}hP.loadTextureOnly=true;hP.mergedKey=hN;hP.mergedCol=hI.col;hP.mergedRow=hI.row;hP.textureOffset=hQ}return T.concat(hK)},addOffsetToIndex:function(e,hK){var hI=[];hK=hK/3;for(var T=0,hJ=e.length/3;T<hJ;T++){hI[T*3]=e[T*3]+hK;hI[T*3+1]=e[T*3+1]+hK;hI[T*3+2]=e[T*3+2]+hK}return hI},addOffsetToTexCoords:function(T,hJ){var hI=[];for(var e=0;e<T.length;e+=2){hI[e]=T[e]/2+hJ[0];hI[e+1]=T[e+1]/2+hJ[1]}return hI},getTileModels:function(i,hL,hU,hN){var hQ=this._earth;var hK=i.getSouthWest();var hP=i.getNorthEast();var T=hU>3?3:hU;var hJ=[];if(hP.lat>this._mcNorthLat||hL==="n"){hJ=this.getPolarTileModels(T,"n")}var hS=Math.max(Math.min(this._mcNorthLat,hP.lat),this._mcSouthLat);var hR=Math.min(Math.max(this._mcSouthLat,hK.lat),this._mcNorthLat);var hT=new ey(new cX(hR,hK.lng),new cX(hS,hP.lng));var e;if(i.useLOD){e=this.getLODTileModels(hT,hL,hU,hN)}else{e=this._getTileModels(hT,hL,hU,hN)}var hI=e[0];var hM=e[1];var hO=[];if(hK.lat<this._mcSouthLat||hL==="s"){hO=this.getPolarTileModels(T,"s")}return[hI.concat(hJ).concat(hO),hM]},_getTileModels:function(hP,hO,T,h3){var hU=hP.getSouthWest();var hK=hP.getNorthEast();var h1=this._earth.getCenter();var h0=this._mcPrj.convertLL2MC(h1);var hI=Math.pow(2,18-h3);var hJ={col:Math.floor(h0.lng/hI/256),row:Math.floor(h0.lat/hI/256)};var hN=cF.getInstance("na");var hX=hN.getDataZoom(h3);var hY=hN.getMercatorSize(h3,hX);var e={col:Math.floor(h0.lng/hY),row:Math.floor(h0.lat/hY)};var hZ=cF.getInstance("web");var hN=cF.getInstance("na");if(hU.lng>hK.lng){var hS=new ey(new cX(hU.lat,hU.lng),new cX(hK.lat,180));var hV=new ey(new cX(hU.lat,-180),new cX(hK.lat,hK.lng));var hT=this.__getTileModels(hS,hO,T,h3,"left",hZ);var hR=this.__getTileModels(hV,hO,T,h3,"right",hZ);var hM=hT.concat(hR);hM=this._sortByCenter(hM,hJ);var hL=this.__getTileModels(hS,hO,T,h3,"left",hN);var hQ=this.__getTileModels(hV,hO,T,h3,"right",hN);var hW=hL.concat(hQ);hW=this._sortByCenter(hW,e);return[hM,hW]}var h2=this.__getTileModels(hP,hO,T,h3,null,hZ);h2=this._sortByCenter(h2,hJ);var i=this.__getTileModels(hP,hO,T,h3,null,hN);i=this._sortByCenter(i,e);return[h2,i]},_sortByImgZoom:function(e){e.sort(function(T,i){if(T.projType==="er"){return 1}if(i.projType==="er"){return -1}return T.imgZoom-i.imgZoom});return e},_sortByCenter:function(e,hP){if(e.length===0){return e}var hN=e[0].col;var hQ=e[0].col;var hK=e[0].row;var hM=e[0].row;for(var hI=0,T=e.length;hI<T;hI++){var hJ=e[hI];if(hJ.col<hN){hN=hJ.col}if(hJ.col>hQ){hQ=hJ.col}if(hJ.row<hK){hK=hJ.row}if(hJ.row>hM){hM=hJ.row}}var hO=hP.col;var hL=hP.row;e.sort(function(hR,i){var hT=Math.pow((hR.col-hO),2)+Math.pow((hR.row-hL),2);var hS=Math.pow((i.col-hO),2)+Math.pow((i.row-hL),2);return hT-hS});return e},__getTileModels:function(h6,hV,ig,hI,hQ,hS){var hU=this;var T=hU._earth;var hO=this._mcPrj;var h1=h6.getSouthWest();var hR=h6.getNorthEast();var hM=hS.getDataZoom(hI);var h2=hS.getTileSize(hI);var h8=hS.getMercatorSize(hI,hM);if(ig>4){hV=false}var im=hO.convertLL2MC(h1);var ic=hO.convertLL2MC(hR);var ib=im.lng;var hZ=ic.lng;var ia=im.lat;var hY=ic.lat;var h4=Math.floor(ib/h8);var ie=Math.floor(hZ/h8);var h7=Math.floor(ia/h8);var iq=Math.floor(hY/h8);var hJ=hO.convertLL2MC(h6.getCenter());var hX=Math.floor(hJ.lat/h8);var ik=h7;var hP=iq;if(hV){var h0=hO.convertLL2MC(new cX(this._mcSouthLat,-180));var h9=hO.convertLL2MC(new cX(this._mcNorthLat,180));var io=Math.floor(h0.lng/h8);var il=Math.floor(h0.lat/h8);var ih=Math.floor(h9.lng/h8);var hT=Math.floor(h9.lat/h8);if(hV==="n"){hP=hT}else{if(hV==="s"){ik=il}}}var ip=[];var hN=hU._colPrecisionPerTile;var h3=hU._rowPrecisionPerTile;if(hI<=7){hN=h3=Math.pow(2,7-hI)}var h5=this._mcMergeY;for(var ij=ik;ij<=hP;ij++){var id=h4;var hK=ie;if((hV==="n"&&ij>=Math.min(h7,hX))||(hV==="s"&&ij<=Math.max(iq,hX))){if(hQ==="left"){id=io;hK=-1}else{if(hQ==="right"){id=0;hK=ih}else{id=io;hK=ih}}}for(var ii=id;ii<=hK;ii++){var e=ij*h8;var hW="key_"+hS.getName()+"_"+ii+"_"+ij+"_"+hI+"_"+hM;var hL;if((e>=h5||e+h8<-h5)&&hI>3){hL=this._createTileModel(hW,ij,ii,hI,hM,h8,hS,hN,h3)}else{hL=this._createTileModel(hW,ij,ii,hI,hM,h8,hS,hN,h3)}if(!ip[hL.key]){ip.push(hL);ip[hL.key]=true}}}return ip},_createTileModel:function(h4,hV,hU,h1,hO,e,T,hZ,hX){var hW=null,hN=this._mc180Pt,hJ=this._mcM180Pt;var hP=h1/hZ;var hT=h4+"_"+hP;q.totalTileCount++;if(!q._tileModelInfoCache.getData(hT)){var hM=hU*e,hL=hV*e;var hI=e,hR=e,h0=0,hS="";var h2=hM+e;if(h2>hN.lng){hI=hN.lng-hM;hS="left"}if(hM<hJ.lng){h0=hJ.lng-hM;hI=e-h0;hM=hJ.lng;hS="right"}var h3=[null,null,null];if(T.getName()==="web"){h3=this._genTileVertexInfo(hM,hL,hI,hR,hS,h0,e,hZ,hX)}var hQ=new hj(hM,hL),hK=new hj(hM+hI,hL+hR),hY=[hQ,hK];hW={key:h4,col:hU,row:hV,imgZoom:hO,useZoom:h1,vertex:h3[0],index:h3[1],textureCoord:h3[2],bounds:hY};q._tileModelInfoCache.setData(hT,hW)}else{q.cachedTileCount++;hW=q._tileModelInfoCache.getData(hT)}return hW},_genTileVertexInfo:function(hU,hT,hJ,h0,h1,ic,e,h8,h5){var hV=[];var hL=[];var hR=[];var h6=this._mcPrj;var h9=this._earth.scene;var hZ=hJ/h8;var hM=h0/h5;var hN=this._radius;var id=[];for(var h3=0;h3<=h8;h3++){var hI=hU+h3*hZ;var T=hT;var h2=h6.convertMC2LL(new hj(hI,T));id[h3]=h2}var hY=[];for(var h4=0;h4<=h5;h4++){var hI=hU;var T=hT+h4*hM;var h2=h6.convertMC2LL(new hj(hI,T));hY[h4]=h2}for(var h4=0;h4<=h5;h4++){for(var h3=0;h3<=h8;h3++){var h2=new cX(hY[h4].lat,id[h3].lng);var hO=h9.fromLatLngToXYZ(h2,hN);hV.push(hO[0],hO[1],hO[2]);if(h4<h5&&h3<h8){var hQ=h4*(h8+1)+h3;var ib=hQ+1;var h7=(h4+1)*(h8+1)+h3+1;hL.push(hQ,ib,h7);var ia=hQ;var hP=h7;var hS=(h4+1)*(h8+1)+h3;hL.push(ia,hP,hS)}var hX;var hW=h4*hM/e;if(!h1){hX=h3*hZ/e}else{var hK=0.01;if(h1=="left"){hX=h3*hZ/e-hK}else{if(h1=="right"){hX=(h3*hZ+ic)/e+hK}}}hR.push(hX,hW)}}hR._dir=h1;return[hV,hL,hR]},getPolarTileModels:function(e,hV){if(this._polarModelsCache[e][hV]){return this._polarModelsCache[e][hV]}var hR=[];var hI=[];var hP=[];var h4=this._earth.scene;var hK=this._radius;var hX=Math.floor(e);var h7=e+2;var T=11.25;var ia=5.625;var hL=360/T;var hJ=22.5/ia;var hZ;var hW;if(hV==="n"){hZ=67.5;hW=90}else{hZ=-90;hW=-45;hJ=45/ia}var h1=0;var h0=0;for(var hN=hZ;hN<=hW;hN+=ia){for(var h9=-180;h9<=180;h9+=T){var hU=new cX(hN,h9);var hY=h4.fromLatLngToXYZ(hU,hK);hR.push(hY[0],hY[1],hY[2]);if(hN<hW&&h9<180){var hO=h1*(hL+1)+h0;var h6=hO+1;var h3=(h1+1)*(hL+1)+h0+1;hI.push(hO,h6,h3);var h5=hO;var hM=h3;var hQ=(h1+1)*(hL+1)+h0;hI.push(h5,hM,hQ)}var hT=h0/hL;var hS=h1/hJ;hP.push(hT,hS);h0++}h0=0;h1++}var h8="key_er_"+(hV==="n"?"north":"south")+"_"+h7;var h2={key:h8,imgZoom:h7,vertex:hR,index:hI,textureCoord:hP,projType:"er",polar:true};this._polarModelsCache[e][hV]=h2;return h2},getERTileModels:function(){if(this._ERTileModelInfo){return this._ERTileModelInfo}var hQ=[];var T=[];var hO=[];var hZ=this._earth.scene;var hJ=this._radius;var e=11.25/2;var h4=5.625;var hK=360/e;var hI=180/h4;var hW=0;var hV=0;for(var hM=-90;hM<=90;hM+=h4){for(var h3=-180;h3<=180;h3+=e){var hT=new cX(hM,h3);var hU=hZ.fromLatLngToXYZ(hT,hJ);hQ.push(hU[0],hU[1],hU[2]);if(hM<90&&h3<180){var hN=hW*(hK+1)+hV;var h1=hN+1;var hY=(hW+1)*(hK+1)+hV+1;T.push(hN,h1,hY);var h0=hN;var hL=hY;var hP=(hW+1)*(hK+1)+hV;T.push(h0,hL,hP)}var hS=hV/hK;var hR=hW/hI;hO.push(hS,hR);hV++}hV=0;hW++}var h2="key_er_1";var hX={key:h2,vertex:hQ,index:T,textureCoord:hO,projType:"er",world:true};this._ERTileModelInfo=hX;return hX},getLODTileModels:function(ip,ia,iG,hJ){var hV=ip.getSouthWest();var hL=ip.getNorthEast();if(hV.lat===-90||hV.lat===hL.lat){return[]}var T=this._earth;var iu=this._mcPrj;var iF=Math.pow(2,18-hJ);var ij=256;var ir=iF*ij;var iK=iu.convertLL2MC(hV);var ix=iu.convertLL2MC(hL);var h8=iK.lat;var ie=iK.lng;var hK=ix.lat;var il=ix.lng;var i=T.getCenter();var h0=iu.convertLL2MC(i);var ik=Math.abs(h0.lat-ix.lat);var h4=Math.abs(h0.lng-ix.lng);var iB=Math.abs(h0.lat-iK.lat);var hW=Math.abs(h0.lng-iK.lng);var hM=Math.min(ik,h4,iB,hW);var io=h0.lat-hM;var ic=h0.lng-hM;var h6=h0.lat+hM;var ih=h0.lng+hM;var iJ=ir*2;var iC=Math.floor(io/iJ);var iL=Math.floor(h6/iJ);var hY=Math.floor(ic/iJ);var ib=Math.floor(ih/iJ);var hO=iC*iJ;var h3=iL*iJ+iJ;var hT=hY*iJ;var ig=ib*iJ+iJ;var iw=ir*0.1;var h7=new hj(hT+iw,hO+iw);var iz=new hj(ig-iw,h3-iw);var hN=iu.convertMC2LL(h7);var im=iu.convertMC2LL(iz);var iI=new ey(hN,im);var hR=this._getTileModels(iI,ia,iG,hJ);var e=hR[0];var hP=hR[1];var id=hO,hQ=h3,it=hT,iA=ig,hS=iJ,h9=hS*2,h2=hJ;while(hQ<hK||id>h8||it>ie||iA<il){var iM=hQ,hX=id,iq=it,iy=iA;h2-=1;if(hQ<hK){hQ+=hS;if(hQ%h9!==0){hQ+=hS}}if(id>h8){id-=hS;if(id%h9!==0){id-=hS}}if(iA<il){iA+=hS;if(iA%h9!==0){iA+=hS}}if(it>ie){it-=hS;if(it%h9!==0){it-=hS}}var hU;var hI;var ii;var h5;var iH;var iD=hS*0.1;var hZ=[];if(hQ>iM){hU=new hj(it+iD,iM+iD);hI=new hj(iA-iD,hQ-iD);ii=iu.convertMC2LL(hU);h5=iu.convertMC2LL(hI);iH=new ey(ii,h5);hZ=this._getTileModels(iH,ia,iG,h2)[0]}var iv=[];if(hX>id){hU=new hj(it+iD,id+iD);hI=new hj(iA-iD,hX-iD);ii=iu.convertMC2LL(hU);h5=iu.convertMC2LL(hI);iH=new ey(ii,h5);iv=this._getTileModels(iH,ia,iG,h2)[0]}var iE=[];if(iA>iy){hU=new hj(iy+iD,hX+iD);hI=new hj(iA-iD,iM-iD);ii=iu.convertMC2LL(hU);h5=iu.convertMC2LL(hI);iH=new ey(ii,h5);iE=this._getTileModels(iH,ia,iG,h2)[0]}var h1=[];if(iq>it){hU=new hj(it+iD,hX+iD);hI=new hj(iq-iD,iM-iD);ii=iu.convertMC2LL(hU);h5=iu.convertMC2LL(hI);iH=new ey(ii,h5);h1=this._getTileModels(iH,ia,iG,h2)[0]}this.mergeArray(e,hZ);this.mergeArray(e,iv);this.mergeArray(e,iE);this.mergeArray(e,h1);hS=iJ*2;h9=hS*2}return[e,hP]},mergeArray:function(hJ,T){for(var hI=0,e=T.length;hI<e;hI++){hJ.push(T[hI])}return hJ}});function el(e,i){this._radius=e;this._options={colSegs:64,rowSegs:32,latSpan:180};i=i||{};C.extend(this._options,i);this._sphereVerticesOriginal=null;this._facesVertex=[];this._facesVertexIndiceMiddle=[]}C.extend(el.prototype,{generateAllVertex:function(){this.initSphereVertexAll();this.initSphereAllFacesIndices();return{vertex:this._sphereVerticesOriginal,indice:this._facesVertexIndiceMiddle}},initSphereVertexAll:function(){if(this._sphereVerticesOriginal){return}var T=this._options.colSegs;var hO=this._options.rowSegs;var hN=this._radius;var hI=360/T;var hM=this._options.latSpan;var e=hM/2;var hQ=hM/hO;var hU=[];for(var hK=hO;hK>=0;hK--){var hS=dE(hK*hQ-e);var hL=Math.cos(hS)*hN;var hP=Math.sin(hS)*hN;for(var hJ=0;hJ<T;hJ++){var hT=Math.sin(dE(hJ*hI))*hL;var hR=Math.cos(dE(hJ*hI))*hL;hU.push(hT,hR,hP)}}this._sphereVerticesOriginal=hU},initSphereAllFacesIndices:function(){var T=this._options.colSegs;var hO=this._options.rowSegs;for(var hJ=0;hJ<hO;hJ++){for(var hI=0;hI<T;hI++){var hP=hJ*T;var hK=hP+hI;var e=hK+T;if(hI<T-1){var hL=hK+1;var hN=hL+T;this._facesVertexIndiceMiddle.push(hK,hL,hN);this._facesVertexIndiceMiddle.push(hK,hN,e)}else{var hM=(hJ+1)*T;this._facesVertexIndiceMiddle.push(hK,hP,hM);this._facesVertexIndiceMiddle.push(hK,hM,e)}}}return this._facesVertexIndiceMiddle},setSegments:function(i,e){this._options.colSegs=i;this._options.rowSegs=e}});function Z(e,hI,T){this._radius=e;this._cols=hI||Math.pow(2,4-1);this._rows=T||this._cols/2;this._sphereVerticesOriginal=null;this._facesVertex=[];this._facesVertexIndiceMiddle=[];this._textureCoords=[];var i=360/this._cols;this._x1=Math.cos(dE(i*2))*this._radius;this.initSphereVertex()}Z.H_SEGS=16;Z.V_SEGS=9;C.extend(Z.prototype,{initSphereVertex:function(){if(this._facesVertex.length>0){return}var T=Z.H_SEGS;var hZ=Z.V_SEGS;var hI=this._radius;var hX=360/T;var hT=180/(hZ-1);var hV=[];var hY=T/this._cols;var hQ=T/hY;var hS=[];var hK=0;var hJ=0;var hL;for(var hW=0;hW<hZ;hW++){var hR=Math.cos(dE(hW*hT-90))*hI;hR=Math.round(hR*100)/100;var hO=Math.sin(dE(hW*hT-90))*hI;hO=Math.round(hO*100)/100;hK=Math.floor(hW/hY);for(var hU=0;hU<T;hU++){var hP=Math.cos(dE(hU*hX))*hR;var hN=Math.sin(dE(hU*hX))*hR;hP=Math.round(hP*100)/100;hN=Math.round(hN*100)/100;hV.push(hP,hO,hN);hJ=Math.floor(hU/hY);hL=hJ+hK*hQ;if(hK<this._rows){if(!this._facesVertex[hL]){this._facesVertex[hL]=[]}this._facesVertex[hL].push(hP,hO,hN)}if(hK>0&&hW%hY===0){var e=hJ+(hK-1)*hQ;var hM=this._facesVertex[e].length-3*(hY+1);this._facesVertex[e].push(hP,hO,hN);if(hU>0&&hU%hY===0){if(this._facesVertex[e-1]){this._facesVertex[e-1].push(hP,hO,hN)}}if(hU==T-1){this._facesVertex[e].push(hS[0],hS[1],hS[2])}}if(hJ===0&&hU===0){hS=[hP,hO,hN]}if(hU>0&&hU%hY===0){if(this._facesVertex[hL-1]){this._facesVertex[hL-1].push(hP,hO,hN)}}if(hK<this._rows){if(hU===T-1){this._facesVertex[hL].push(hS[0],hS[1],hS[2])}}}}this._sphereVerticesOriginal=hV},initSphereFacesIndices:function(){var hM;var e=Z.H_SEGS;var hP=Z.V_SEGS;var hS=e/this._cols;var hL=e/hS;var hR=(hP-1)/this._rows;var hK=hS+1;var hJ;hM=this._facesVertex[this._facesVertex.length/2];for(var hI=0;hI<hS;hI++){for(var T=0;T<hS;T++){var hQ=hI*hK;var hN=hQ+T+1;var hO=hQ+T+1+hK;this._facesVertexIndiceMiddle.push(hQ+T,hN,hO);hN=hQ+T+1+hK;this._facesVertexIndiceMiddle.push(hQ+T,hN,hQ+hK+T)}}return this._facesVertexIndiceMiddle},generateTextureCoord:function(hQ,hJ,hT){var hP=this._facesVertex[Math.round(this._facesVertex.length/2)];if(!hP){return}var hU=[];var hS=Math.pow(2,2-hQ);var hM=hJ%hS;var T=hT%hS;var e=hM+T*hS;var hO=Z.H_SEGS/this._cols;var hI=1/hO;var hK=1/((Z.V_SEGS-1)/this._rows);for(var hN=0;hN<hP.length/3;hN++){var hL=hN%(hO+1)*hI;var hR=Math.floor(hN/(hO+1))*hK;hL=hL/hS+hM*1/hS;hR=hR/hS+T*1/hS;if(hQ===1){hR*=2}hU.push(hL,hR)}return hU},getFaceIndex:function(hK){var i=0;var hO=0;var hL=hK[0];var hJ=hK[1];var hI=hK[2];var hN=Math.round(Math.atan(Math.abs(hI)/Math.abs(hL))*180/Math.PI);if(hL>0){if(hI<0){hN=360-hN}}else{if(hI>0){hN=180-hN}else{hN=180+hN}}if(hJ>this._x1){hO=3}else{if(hJ>0){hO=2}else{if(hJ>-this._x1){hO=1}else{hO=0}}}var i=Math.floor(hN/(360/this._cols));var e=Z.H_SEGS;var hM=e/this._cols;var T=e/hM;return[i,hO,i+hO*T]}});function f2(e){this._earth=e;this._pMatrix=mat4.create();this._pMatrixInverse=mat4.create();this._pMatrix64=mat4.create(Float64Array);this._pMatrixInverse64=mat4.create(Float64Array);this._cMatrix=mat4.create();this._mvMatrix=mat4.create();this._mvMatrixForCamera=mat4.create();this._mvMatrixForCameraInverse=mat4.create();this._mvMatrixForAt=mat4.create();this._mvMatrixInverse=mat4.create();this._mvMatrix64=mat4.create(Float64Array);this._mvMatrixInverse64=mat4.create(Float64Array);this._mvMatrixForAtInverse=mat4.create();this._mvMatrixWithNoHeading=mat4.create();this._mvMatrixWithNoHeadingInverse=mat4.create();this._near=0.001;this._far=8000;this._guid=f2.guid++;this._lightMatrix=mat4.create();this._lightMatrixInverse=mat4.create();this._lightMatrixForAt=mat4.create();this._lightMatrixForAtInverse=mat4.create();this._lightPosition=null;this._date=new Date();this._ray=new b6.Ray();this._calculateSunLightPos();this._tempV4=vec4.create(Float64Array);this._tempRes=vec4.create();this._tempNdc=vec4.create()}f2.guid=0;C.extend(f2.prototype,{updateProjectionMatrix:function(){var i=this._earth.getContainerSize();this._widthHeightRatio=i.width/i.height;var e=this._earth.getZoom();if(e<=3){this._fovy=70-10*e}else{this._fovy=40}mat4.perspective(this._pMatrix64,dE(this._fovy),this._widthHeightRatio,this._near,this._far);mat4.invert(this._pMatrixInverse64,this._pMatrix64);this._pMatrix=mat4.clone(this._pMatrix64);this._pMatrixInverse=mat4.clone(this._pMatrixInverse64)},updateModelViewMatrix:function(){var hI=this._mvMatrix64;var hN=this._mvMatrixForCamera;mat4.identity(hI);mat4.identity(hN);var hP=this._earth;var hR=hP.getZoom();var hJ=180;var hS=hP.radius;var i;if(hR<=3){i=3.4*hS-0.8*hS*hR}else{i=hS/Math.pow(2,hR-3)}mat4.translate(hI,hI,[0,0,-i]);mat4.translate(hN,hN,[0,0,-i]);var hO=this._mvMatrixWithNoHeading;mat4.copy(hO,hI);var hQ=hP.getTilt();if(hQ!==0&&hR<hP._enableTiltZoom){if(hR>=hP._enableTiltZoom-2){hQ=(1-(hP._enableTiltZoom-hR)/2)*hQ}else{hQ=0}}if(hQ!==0){mat4.rotate(hI,hI,dE(hQ),[-1,0,0]);mat4.rotate(hN,hN,dE(hQ),[-1,0,0])}var hT=hP.getHeading();while(hT<0){hT+=360}hT%=360;if(hT>=315||hT<45){mat4.rotate(hO,hO,dE(hQ),[-1,0,0])}else{if(hT<135){mat4.rotate(hO,hO,dE(hQ),[0,-1,0])}else{if(hT<225){mat4.rotate(hO,hO,dE(hQ),[1,0,0])}else{mat4.rotate(hO,hO,dE(hQ),[0,1,0])}}}mat4.translate(hO,hO,[0,0,-hS]);mat4.translate(hI,hI,[0,0,-hS]);mat4.translate(hN,hN,[0,0,-hS]);var e=hP.getCenter();var hL=e.lat;var hM=e.lng;if(hR<=6){mat4.copy(this._mvMatrixForAt,hI);mat4.invert(this._mvMatrixForAtInverse,this._mvMatrixForAt);mat4.copy(this._lightMatrix,hI);var hK=this._lightMatrix;mat4.rotate(hK,hK,dE(this._sunLightLat),[1,0,0]);mat4.rotate(hK,hK,dE(-hJ+this._sunLightLng),[0,-1,0]);mat4.invert(this._lightMatrixInverse,this._lightMatrix);mat4.copy(this._lightMatrixForAt,this._mvMatrixForAt);var T=this._lightMatrixForAt;mat4.rotate(T,T,dE(this._sunLightLat),[1,0,0]);mat4.rotate(T,T,dE(hM-this._sunLightLng),[0,1,0]);mat4.rotate(T,T,dE(-hL),[1,0,0]);if(hT!==0){mat4.rotate(T,T,dE(hT),[0,0,1])}mat4.invert(this._lightMatrixForAtInverse,T)}if(hT!==0){mat4.rotate(hI,hI,dE(hT),[0,0,-1]);mat4.rotate(hN,hN,dE(hT),[0,0,-1])}mat4.rotate(hI,hI,dE(hL),[1,0,0]);mat4.rotate(hO,hO,dE(hL),[1,0,0]);mat4.rotate(hI,hI,dE(hJ+hM),[0,-1,0]);mat4.rotate(hO,hO,dE(hJ+hM),[0,-1,0]);mat4.invert(this._mvMatrixInverse64,hI);this._mvMatrix=mat4.clone(hI);this._mvMatrixInverse=mat4.clone(this._mvMatrixInverse64);mat4.invert(this._mvMatrixForCameraInverse,hN);mat4.invert(this._mvMatrixWithNoHeadingInverse,hO);this._cameraPosition=null;this._cameraPositionForAt=null;this._distanceToSphereEdge=null;this._earthRadius=null;this._lightPosition=null;this._lightPositionForAt=null},_calculateSunLightPos:function(){var e=bu(this._date);this._sunLightLng=e[0];this._sunLightLat=e[1];var i=this;this._earth.on("sunlighttime_change",function(hI){var T=bu(i._date);i._sunLightLng=T[0];i._sunLightLat=T[1]});this._earth.on("sunlighttime_clear",function(hI){var T=bu(i._date);i._sunLightLng=T[0];i._sunLightLat=T[1]})},getSunZenith:function(){return new cX(this._sunLightLat,this._sunLightLng)},saveMatrixInfo:function(){this._savePMatrixInverse=mat4.clone(this._pMatrixInverse);this._saveMVMatrixInverse=mat4.clone(this._mvMatrixInverse)},getProjectionMatrix:function(){return this._pMatrix},getModelViewMatrix:function(){return this._mvMatrix},getModelViewMatrixForAt:function(){return this._mvMatrixForAt},getInverseProjectionMatrix:function(){return this._pMatrixInverse},getInverseModelViewMatrix:function(){return this._mvMatrixInverse},fromXYZToNDC:function(hL,hJ,T,hN){var hI=vec4.set(this._tempV4,hL,hJ,T,1);var i=this._tempRes;hN=hN||{};var e=this._mvMatrix;var hK=this._pMatrix;if(hN.matrixInfo){e=hN.matrixInfo.modelViewMatrix||e;hK=hN.matrixInfo.projectionMatrix||hK}mat4.multiply(i,e,hI);mat4.multiply(i,hK,i);var hM=vec4.set(this._tempNdc,i[0]/i[3],i[1]/i[3],i[2]/i[3],1);hM.w=i[3];return hM},getPosition:function(){if(this._cameraPosition){return this._cameraPosition}this._cameraPosition=vec3.transformMat4(vec3.create(),vec3.fromValues(0,0,0),this._mvMatrixInverse);return this._cameraPosition},getPositionForAt:function(){if(this._cameraPositionForAt){return this._cameraPositionForAt}this._cameraPositionForAt=vec3.transformMat4(vec3.create(),vec3.fromValues(0,0,0),this._mvMatrixForAtInverse);return this._cameraPositionForAt},getDistanceToSphereEdge:function(){if(this._distanceToSphereEdge){return this._distanceToSphereEdge}var i=vec3.len(this.getPosition());var e=this._earth.radius;this._distanceToSphereEdge=(Math.pow(i,2)-e*e)/i;return this._distanceToSphereEdge},getLength:function(){return vec3.len(this.getPosition())},castRay:function(T,hJ){var i=this._ray;var e=T.x;var hM=T.y;var hI=vec3.create(Float64Array);var hK=vec4.set(this._tempV4,e,hM,-1,1);this._calcV4InCastRay(hK,hJ);vec3.scale(hI,hK,1/hK[3]);var hL=vec3.create(Float64Array);hK=vec4.fromValues(e,hM,1,1);this._calcV4InCastRay(hK,hJ);vec3.scale(hK,hK,1/hK[3]);vec3.sub(hL,hK,hI);vec3.normalize(hL,hL);i.set(hI,hL);return i},_calcV4InCastRay:function(hK,T){if(!T){mat4.multiply(hK,this._pMatrixInverse64,hK);mat4.multiply(hK,this._mvMatrixInverse64,hK)}else{if(T.useOld){mat4.multiply(hK,this._savePMatrixInverse,hK);mat4.multiply(hK,this._saveMVMatrixInverse,hK)}else{if(T.useNoHeading){mat4.multiply(hK,this._pMatrixInverse,hK);mat4.multiply(hK,this._mvMatrixWithNoHeadingInverse,hK)}else{if(T.matrixInfo){var e=T.matrixInfo.projectionMatrix;var hI=mat4.create(Float64Array);if(e){mat4.invert(hI,e)}else{hI=this._pMatrixInverse}var i=T.matrixInfo.modelViewMatrix;var hJ=mat4.create(Float64Array);if(i){mat4.invert(hJ,i)}else{hJ=this._mvMatrixInverse}mat4.multiply(hK,hI,hK);mat4.multiply(hK,hJ,hK)}}}}},getLightPosition:function(){if(this._lightPosition){return this._lightPosition}this._lightPosition=vec3.transformMat4(vec3.create(),vec3.fromValues(0,0,0),this._lightMatrixInverse);return this._lightPosition},getLightPositionForAt:function(){if(this._lightPositionForAt){return this._lightPositionForAt}this._lightPositionForAt=vec3.transformMat4(vec3.create(),vec3.fromValues(0,0,0),this._lightMatrixForAtInverse);return this._lightPositionForAt},getEarthRadiusOnScreen:function(){if(this._earthRadius){return this._earthRadius}var hI=vec3.len(this.getPosition());var T=Math.tan(dE(this._fovy/2))*this._near;var i=this._earth.radius;var e=this._near*i/Math.sqrt(Math.pow(hI,2)-i*i)/T;this._earthRadius=Math.round(e*this._earth.getContainerSize().height/2);return this._earthRadius}});function gv(i){this._earth=i;this._canvas=i._canvas;this._gl=null;this._renderers=[];this._camera=new f2(i);var e=i.getContainerSize();this._width=e.width;this._height=e.height;this._enableTiltZoom=i._enableTiltZoom;this._changedStatus={};this._ratio=i._ratio;this._radius=i.radius;this._onEachFrame=(function(T){return function(){T._renderFrame()}})(this);this._init()}C.extend(gv.prototype,{_init:function(){this._gl=a0(this._canvas);this._handleContextStatus();this._setupWebGL();this._bind();this.onStatusChange();this.startRenderThread();var T=new a6("onearthload");var i=bl(this._gl);if(!i){i={renderer:"",vendor:""}}T.hardwareInfo=i;T.earth=this._earth;this._earth._deviceInfo={hardwareInfo:i};this._earth._map._earth=this._earth;this._earth._map.dispatchEvent(T)},_handleContextStatus:function(){var e=this._canvas;var i=this;e.addEventListener("webglcontextlost",function(T){T.preventDefault();cancelAnimationFrame(i.renderTimer);i._earth.fire(new a6("onwebglcontextlost"));setTimeout(function(){window.location.reload()},200)},false);e.addEventListener("webglcontextrestored",function(T){i._earth.fire(new a6("onwebglcontextrestored"))},false)},_setupWebGL:function(){var i=this._gl;var e=this._canvas;i.clearColor(0,0,0,1);i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT);i.viewport(0,0,e.width,e.height)},_bind:function(){var hI=this._earth;var T=this;function hJ(hK){T._renderOptions={event:hK};T._changedStatus[hK.type]=true;T._needToChangeStatus=true;T.startRenderThread()}hI.on("zoom_changed",hJ);hI.on("center_changed",hJ);hI.on("heading_changed",hJ);hI.on("tilt_changed",hJ);hI.on("forcerefresh",hJ);hI.on("size_changed",hJ);hI.on("displayoptions_changed",hJ);hI.on("animation_end",hJ);hI.on("layer_add",function e(hK){if(hK.layer.renderer){T.addRenderer(hK.layer.renderer)}});hI.on("layer_remove",function i(hK){if(hK.layer.renderer){T.removeRenderer(hK.layer.renderer)}});hI.on("idle",function(){cancelAnimationFrame(T.renderTimer);hI.fire(new a6("onrenderthreadstop"));T.renderTimer=null});hI.on("refresh",function(){T.startRenderThread()})},startRenderThread:function(){var e=this;if(e.idleTimer){clearTimeout(e.idleTimer)}e.idleTimer=setTimeout(function(){e._earth.fire(new a6("onidle"));e.idleTimer=null},100);if(this.renderTimer){return}this.renderTimer=requestAnimationFrame(this._onEachFrame)},_renderFrame:function(){this.renderTimer=requestAnimationFrame(this._onEachFrame);if(this._needToChangeStatus){this.onStatusChange();this._changedStatus={};this._needToChangeStatus=false}var hI=this._gl;hI.clear(hI.COLOR_BUFFER_BIT|hI.DEPTH_BUFFER_BIT);for(var T=0,e=this._renderers.length;T<e;T++){this._renderers[T].renderFrame(this._renderOptions)}this._earth._map.insertRender&&this._earth._map.insertRender()},onStatusChange:function(){var hJ=this;if(hJ._changedStatus.onsize_changed){hJ.resize()}hJ._curBounds=null;hJ._camera.updateProjectionMatrix();hJ._camera.updateModelViewMatrix();for(var hI=0,T=hJ._renderers.length;hI<T;hI++){hJ._renderers[hI].onStatusChange(hJ._camera)}hJ._statusChangeTimer=null;var hK=new a6("onstatuschange");hK.changedStatus=hJ._changedStatus;hJ._earth.fire(hK);var e=new a6("onearthstatuschange");e.changedStatus=hJ._changedStatus;hJ._earth.getMap().fire(e)},resize:function(){var hK=this._earth.getContainerSize();var T=this._width=hK.width;var hL=this._height=hK.height;var hI=this._canvas;hI.style.width=T+"px";hI.style.height=hL+"px";hI.width=T*this._ratio;hI.height=hL*this._ratio;this._gl.viewport(0,0,hI.width,hI.height);for(var hJ=0,e=this._renderers.length;hJ<e;hJ++){this._renderers[hJ].resize&&this._renderers[hJ].resize()}},saveMatrixInfo:function(){this._camera.saveMatrixInfo()},addRenderer:function(e){this._renderers.push(e);this._renderers.sort(function(T,i){return T.zIndex-i.zIndex});this.startRenderThread()},removeRenderer:function(T){for(var e=0;e<this._renderers.length;e++){if(this._renderers[e]===T){this._renderers.splice(e,1)}}this.startRenderThread()},fromPixelToXYZ:function(hM,hK){var hX=this._width;var hW=this._height;var hR=hM.x*2/hX-1;var hQ=1-hM.y*2/hW;var hU=this._camera.castRay(new eb(hR,hQ),hK);var hL=this._radius;var hZ=hU.direction;var T=hU.origin;var e=vec3.fromValues(0,0,0,Float64Array);var hV=vec3.create(Float64Array);vec3.sub(hV,T,e);var hP=vec3.dot(hZ,hZ);var hO=2*vec3.dot(hZ,T);var hN=vec3.dot(T,T)-hL*hL;var hS=hO*hO-4*hP*hN;var hY=vec3.create(Float64Array);if(hS<0){return null}else{if(hS===0){var hT=-hO/(2*hP);return vec3.scaleAndAdd(hY,T,hZ,hT)}}var hJ=(-hO+Math.sqrt(hS))/(2*hP);var hI=(-hO-Math.sqrt(hS))/(2*hP);vec3.scaleAndAdd(hY,T,hZ,hJ);var i=vec3.create(Float64Array);vec3.scaleAndAdd(i,T,hZ,hI);if(Math.abs(hY[2]-hU.origin[2])<Math.abs(i[2]-hU.origin[2])){return hY}return i},fromXYZToPixel:function(i,hM,hL,hJ){var T=this._camera.fromXYZToNDC(i,hM,hL,hJ);if(!T){return null}var hK=this._width;var e=this._height;var hI=new eb(((T[0]+1)*hK*0.5),((1-T[1])*e*0.5));hI.depth=(T[2]+1)*0.5;hI.w=T.w;return hI},fromLatLngToXYZ:function(hJ,T){T=T||this._radius;var hI=Math.cos(hJ.lat*Math.PI/180)*T;var hL=Math.sin(hJ.lat*Math.PI/180)*T;var i=Math.sin((hJ.lng+180)*Math.PI/180)*hI;var hK=Math.cos((hJ.lng+180)*Math.PI/180)*hI;var e=[i,hL,hK];e.x=i;e.y=hL;e.z=hK;return e},fromXYZToLatLng:function(i,hK,hJ){var hI=c8(Math.asin(hK/this._radius));var T;var e=Math.cos(dE(hI))*this._radius;if(i>=0){if(hJ<0){T=-c8(Math.asin(fx(i/e,-1,1)))}else{T=-(c8(Math.asin(fx(hJ/e,-1,1)))+90)}}if(i<0){if(hJ<0){T=c8(Math.asin(fx(-i/e,-1,1)))}else{T=c8(Math.asin(fx(hJ/e,-1,1)))+90}}return new cX(hI,T)},fromPixelToLatLng:function(T,i){var e=this.fromPixelToXYZ(T,i);if(!e){return null}return this.fromXYZToLatLng(e[0],e[1],e[2])},fromLatLngToPixel:function(i,hO){var hL=this.fromLatLngToXYZ(i);hO=hO||{};var e=this.fromXYZToPixel(hL[0],hL[1],hL[2],hO);if(hO.isCalcOnBack){var hK=this._camera;var hN=hK.getLength();var T=hK._fovy;var hJ=this._radius;var hM=Math.sqrt(hN*hN-hJ*hJ);var hI=Math.cos(dE(T/2))*hM;if(e.w>hI){e.onBack=true}}return e},ifXYZInView:function(hK,hJ,hI){var i=this.fromXYZToPixel(hK,hJ,hI);var e=this._width;var hM=this._height;var hL=this._camera.getLength();if(this._earth.getZoom()>3){var hN=this.fromLatLngToPixel(this._earth.getCenter());var T=hN.w;if(Math.abs(i.w-T)>50){return false}}if(i.x>0&&i.x<e&&i.y>0&&i.y<hM&&i.w<=hL){return true}return false},ifXYZOnBack:function(i,hK,hJ,hI){hI=hI||0;var T=this.fromXYZToPixel(i,hK,hJ);var e=this._camera.getDistanceToSphereEdge();if(T.w>e+hI){return true}return false},getBounds:function(){if(this._curBounds){return this._curBounds}var T=this._earth;var hJ=T.getZoom();if(hJ<3){return this._getBoundsForSmallZoom()}var h7=T.getHeading();var hN=T.getContainerSize();var hZ=[0,0,hN.width,hN.height];if(h7!==0){hZ=K(h7,new d1(hN.width,hN.height))}var h8=hZ[0];var h6=hZ[1];var hT=hZ[2];var hS=hZ[3];var hQ=-1;var hP=-1;var hM=-1;var hL=-1;var hR=-1;var e=this._width;var hK=this._height;var ig;var id;var h1;var ia;var i=T.getCenter();var hY=false;var hU;var h9=this._hasHoleInfoCache;var h0=this.fromPixelToLatLng(new eb(h8,h6),{useNoHeading:true});if(h0){ig=h0.lat;ia=h0.lng}hU=!ig?true:false;var h5;var ih=this._earth.getTilt();if(hU&&(ih===0||ih>0&&hJ<5)){var hX=null;if(i.lat>50){h5=new ey(new cX(i.lat-70,i.lng-90),new cX(40,i.lng+90));hX=new ey(new cX(40,i.lng-120),new cX(90,i.lng+120))}else{if(i.lat<-50){h5=new ey(new cX(-40,i.lng-90),new cX(i.lat+70,i.lng+90));hX=new ey(new cX(-90,i.lng-120),new cX(-40,i.lng+120))}else{h5=new ey(new cX(i.lat-70,i.lng-90),new cX(i.lat+70,i.lng+90))}}h5._addBounds=hX;h5.holeAtTopLeft=!!hU;this._curBounds=h5;if(ih>0&&hJ>=this._enableTiltZoom){h5.useLOD=true}return h5}var ic=this.fromPixelToLatLng(new eb(0,0));h0=this.fromPixelToLatLng(new eb((hT+h8)/2,h6),{useNoHeading:true});if(h0){if(!ig||h0.lat>ig){ig=h0.lat}if(h9){hQ=this._holeInfoCache.topX;h0=this.fromPixelToLatLng(new eb(hQ,h6),{useNoHeading:true})}else{if(hU){for(var h4=h8+1;h4<=hT;h4++){h0=this.fromPixelToLatLng(new eb(h4,h6),{useNoHeading:true});if(h0!==null){break}}if(h0!==null){hQ=h4;ia=h0.lng}}}}else{}if(!hU&&hQ===-1){h0=this.fromPixelToLatLng(new eb(hT,h6),{useNoHeading:true})}else{h0=this.fromPixelToLatLng(new eb(hT-hQ,h6),{useNoHeading:true});if(!h0){if(h9){hR=this._holeInfoCache.topXRight;h0=this.fromPixelToLatLng(new eb(hR,h6),{useNoHeading:true})}else{for(var h4=hT-1;h4>=h8;h4--){h0=this.fromPixelToLatLng(new eb(h4,h6),{useNoHeading:true});if(h0!==null){break}}hR=h4}}}if(h0){h1=h0.lng;if(h0.lat>ig){ig=h0.lat}}var h3=this.fromPixelToLatLng(new eb(e,0));h0=this.fromPixelToLatLng(new eb(h8,(hS+h6)/2),{useNoHeading:true});if(h0){hY=true;if(hU){if(h9){hP=this._holeInfoCache.topY;h0=this.fromPixelToLatLng(new eb(h8,hP),{useNoHeading:true})}else{for(var h2=h6+1;h2<=hS;h2++){h0=this.fromPixelToLatLng(new eb(h8,h2),{useNoHeading:true});if(h0!==null){break}}hP=h2}if(h0){ia=h0.lng}if(h0&&(!ig||h0.lat>ig)){ig=h0.lat}}if(!ia||i.getLngSpan(h0.lng)>i.getLngSpan(ia)){ia=h0.lng}}if(!ig){ig=90}h0=this.fromPixelToLatLng(new eb(hT,(hS+h6)/2),{useNoHeading:true});if(h0){if(hU&&hP!==-1){for(var h2=h6+hP-1;h2<=hS;h2++){h0=this.fromPixelToLatLng(new eb(hT,h2),{useNoHeading:true});if(h0!==null){break}}if(h0){h1=h0.lng}}if(i.getLngSpan(h0.lng)>i.getLngSpan(h1)){h1=h0.lng}}h0=this.fromPixelToLatLng(new eb(h8,hS),{useNoHeading:true});if(h0){id=h0.lat;if(i.getLngSpan(h0.lng)>i.getLngSpan(ia)){ia=h0.lng}}else{if(hY){if(h9){hL=this._holeInfoCache.bottomY;h0=this.fromPixelToLatLng(new eb(h8,hL),{useNoHeading:true})}else{for(var h2=hS-1;h2>=h6;h2--){h0=this.fromPixelToLatLng(new eb(h8,h2),{useNoHeading:true});if(h0!==null){break}}hL=h2}if(h0&&i.getLngSpan(h0.lng)>i.getLngSpan(ia)){ia=h0.lng}}}var hW=this.fromPixelToLatLng(new eb(0,hK+0));h0=this.fromPixelToLatLng(new eb((hT+h8)/2,hS),{useNoHeading:true});if(h0){var ib=!id?true:false;if(h0.lat<id||!id){id=h0.lat}if(ib){for(var h4=h8+1;h4<=hT;h4++){h0=this.fromPixelToLatLng(new eb(h4,hS),{useNoHeading:true});if(h0!==null){break}}if(h0){hM=h4;if(h0.lat<id){id=h0.lat}if(i.getLngSpan(h0.lng)>i.getLngSpan(ia)){ia=h0.lng}}}}else{if(!id){id=-90}}if(hM===-1){h0=this.fromPixelToLatLng(new eb(hT,hS),{useNoHeading:true})}else{h0=this.fromPixelToLatLng(new eb(hT-hM,hS),{useNoHeading:true});if(!h0){for(var h4=hT-1;h4>=h8;h4--){h0=this.fromPixelToLatLng(new eb(h4,hS),{useNoHeading:true});if(h0!==null){break}}}}if(h0){if(i.getLngSpan(h0.lng)>i.getLngSpan(h1)){h1=h0.lng}if(h0.lat<id){id=h0.lat}}var hV=this.fromPixelToLatLng(new eb(e,hK));if(!ia){var hO;var hI;if(hJ<4){hO=new cX(0,i.lng-90);hI=new cX(0,i.lng+90)}else{hO=new cX(0,i.lng-15);hI=new cX(0,i.lng+15)}ia=hO.lng;h1=hI.lng}h5=new ey(new cX(id,ia),new cX(ig,h1));this._curBounds=h5;this._curBounds.holeAtTopLeft=!!hU;if(ih>0&&hJ<5){if(!ic){ic=new cX(ig,ia);h3=new cX(ig,h1)}var ie=T.getProjection();h5.pointTopLeft=ie.convertLL2MC(ic);h5.pointTopRight=ie.convertLL2MC(h3);h5.pointBottomRight=ie.convertLL2MC(hV);h5.pointBottomLeft=ie.convertLL2MC(hW)}if(ih>0&&hJ>=this._enableTiltZoom){h5.useLOD=true}return h5},getCustomBounds:function(){var T=this._earth;if(T.getZoom()<3){return this._getBoundsForSmallZoom()}var hI=T.getHeading();var hY=T.getContainerSize();var hK=[0,0,hY.width,hY.height];if(hI!==0){hK=K(hI,new d1(hY.width,hY.height))}var h4=hK[0];var h2=hK[1];var h3=hK[2];var h1=hK[3];var h8=-1;var h6=-1;var hL=-1;var hJ=-1;var hQ=-1;var hW=this._width;var hT=this._height;var h7;var hP;var hZ;var hX;var h5=T.getCenter();var i=false;var ib;var e=this._hasHoleInfoCache;var h0=this._earth._generateTmpMVMatrix(T.getCenter(),T.getZoom(),0,0);var ia=this.fromPixelToLatLng(new eb(h4,h2),{matrixInfo:{modelViewMatrix:h0}});if(ia){h7=ia.lat;hX=ia.lng}ib=!h7?true:false;var h9;if(ib){var hO=this.fromPixelToLatLng(new eb((h3+h4)/2,h2),{matrixInfo:{modelViewMatrix:h0}});if(hO){var hM=this.fromPixelToLatLng(new eb((h3+h4)/2,h1),{matrixInfo:{modelViewMatrix:h0}});h9=new ey(new cX(hM.lat-20,h5.lng-90),new cX(hO.lat+20,h5.lng+90))}return h9}ia=this.fromPixelToLatLng(new eb((h3+h4)/2,h2),{matrixInfo:{modelViewMatrix:h0}});if(ia){if(!h7||ia.lat>h7){h7=ia.lat}if(e){h8=this._holeInfoCache.topX;ia=this.fromPixelToLatLng(new eb(h8,h2),{matrixInfo:{modelViewMatrix:h0}})}else{if(ib){for(var hS=h4+1;hS<=h3;hS++){ia=this.fromPixelToLatLng(new eb(hS,h2),{matrixInfo:{modelViewMatrix:h0}});if(ia!==null){break}}if(ia!==null){h8=hS;hX=ia.lng}}}}else{}if(!ib&&h8===-1){ia=this.fromPixelToLatLng(new eb(h3,h2),{matrixInfo:{modelViewMatrix:h0}})}else{ia=this.fromPixelToLatLng(new eb(h3-h8,h2),{matrixInfo:{modelViewMatrix:h0}});if(!ia){if(e){hQ=this._holeInfoCache.topXRight;ia=this.fromPixelToLatLng(new eb(hQ,h2),{matrixInfo:{modelViewMatrix:h0}})}else{for(var hS=h3-1;hS>=h4;hS--){ia=this.fromPixelToLatLng(new eb(hS,h2),{matrixInfo:{modelViewMatrix:h0}});if(ia!==null){break}}hQ=hS}}}if(ia){hZ=ia.lng;if(ia.lat>h7){h7=ia.lat}}ia=this.fromPixelToLatLng(new eb(h4,(h1+h2)/2),{matrixInfo:{modelViewMatrix:h0}});if(ia){i=true;if(ib){if(e){h6=this._holeInfoCache.topY;ia=this.fromPixelToLatLng(new eb(h4,h6),{matrixInfo:{modelViewMatrix:h0}})}else{for(var hR=h2+1;hR<=h1;hR++){ia=this.fromPixelToLatLng(new eb(h4,hR),{matrixInfo:{modelViewMatrix:h0}});if(ia!==null){break}}h6=hR}if(ia){hX=ia.lng}if(ia&&(!h7||ia.lat>h7)){h7=ia.lat}}if(!hX||h5.getLngSpan(ia.lng)>h5.getLngSpan(hX)){hX=ia.lng}}if(!h7){h7=90}ia=this.fromPixelToLatLng(new eb(h3,(h1+h2)/2),{matrixInfo:{modelViewMatrix:h0}});if(ia){if(ib&&h6!==-1){for(var hR=h2+h6-1;hR<=h1;hR++){ia=this.fromPixelToLatLng(new eb(h3,hR),{matrixInfo:{modelViewMatrix:h0}});if(ia!==null){break}}if(ia){hZ=ia.lng}}if(h5.getLngSpan(ia.lng)>h5.getLngSpan(hZ)){hZ=ia.lng}}ia=this.fromPixelToLatLng(new eb(h4,h1),{matrixInfo:{modelViewMatrix:h0}});if(ia){hP=ia.lat;if(h5.getLngSpan(ia.lng)>h5.getLngSpan(hX)){hX=ia.lng}}else{if(i){if(e){hJ=this._holeInfoCache.bottomY;ia=this.fromPixelToLatLng(new eb(h4,hJ),{matrixInfo:{modelViewMatrix:h0}})}else{for(var hR=h1-1;hR>=h2;hR--){ia=this.fromPixelToLatLng(new eb(h4,hR),{matrixInfo:{modelViewMatrix:h0}});if(ia!==null){break}}hJ=hR}if(ia&&h5.getLngSpan(ia.lng)>h5.getLngSpan(hX)){hX=ia.lng}}}ia=this.fromPixelToLatLng(new eb((h3+h4)/2,h1),{matrixInfo:{modelViewMatrix:h0}});if(ia){var hV=!hP?true:false;if(ia.lat<hP||!hP){hP=ia.lat}if(hV){for(var hS=h4+1;hS<=h3;hS++){ia=this.fromPixelToLatLng(new eb(hS,h1),{matrixInfo:{modelViewMatrix:h0}});if(ia!==null){break}}if(ia){hL=hS;if(ia.lat<hP){hP=ia.lat}if(h5.getLngSpan(ia.lng)>h5.getLngSpan(hX)){hX=ia.lng}}}}else{if(!hP){hP=-90}}if(hL===-1){ia=this.fromPixelToLatLng(new eb(h3,h1),{matrixInfo:{modelViewMatrix:h0}})}else{ia=this.fromPixelToLatLng(new eb(h3-hL,h1),{matrixInfo:{modelViewMatrix:h0}});if(!ia){for(var hS=h3-1;hS>=h4;hS--){ia=this.fromPixelToLatLng(new eb(hS,h1),{matrixInfo:{modelViewMatrix:h0}});if(ia!==null){break}}}}if(ia){if(h5.getLngSpan(ia.lng)>h5.getLngSpan(hZ)){hZ=ia.lng}if(ia.lat<hP){hP=ia.lat}}if(!hX){var hU;var hN;if(T.getZoom()<4){hU=new cX(0,h5.lng-90);hN=new cX(0,h5.lng+90)}else{hU=new cX(0,h5.lng-15);hN=new cX(0,h5.lng+15)}hX=hU.lng;hZ=hN.lng}h9=new ey(new cX(hP,hX),new cX(h7,hZ));return h9},_getBoundsForSmallZoom:function(){var e=this._earth.getCenter();var i=new ey(new cX(e.lat-90,e.lng-120),new cX(e.lat+90,e.lng+120));this._curBounds=i;this._curBounds.holeAtTopLeft=true;return this._curBounds}});function d(hJ,hI){this._earth=hJ;this._layer=hI;this._canvas=hJ._canvas;var hK=this._gl=hJ.scene._gl;this._webglState=b6.WebGLState.get(hK,hJ._guid);this._glProgram=null;this._glProgram1=null;this._glProgram2=null;this._imgPool=new ge("img");this._textureInfoPool=new fC(1000,{clearCallback:function(hL){if(hL){hK.deleteTexture(hL)}}});this._mergedTextureCache=new fC(200);this._tileNeedToLoadCount=0;this._tileLoadedCount=0;this._thumbToLoad=0;this._thumbLoaded=0;this._nightLoaded=false;this._cloudTextureImage=null;this._radius=hJ.radius;this._width=this._canvas.width;this._height=this._canvas.height;this._mvMatrix=mat4.create();this._mvMatrixCamera=mat4.create();this._pMatrix=mat4.create();this._nMatrix=mat4.create();this._vertexPositionAttribute=null;this._vertexTexCoordAttribute=null;this._trianglesVerticeBuffer=hK.createBuffer();this._triangleVerticesIndexBuffer=hK.createBuffer();this._atmosphereRenderer=this._earth._atmosphereRenderer;this._float32Array=new Float32Array(30000);this._uint16Array=new Uint16Array(30000);var T=this._canvasForMergedTile=document.createElement("canvas");var i=T.getContext("2d");T.width=T.height=512;i.fillStyle="#040728";i.fillRect(0,0,512,512);this._atmosphereData={Kr:0.0076,Km:0.0057,ESun:16,g:-0.95,innerRadius:hJ.radius,outerRadius:1.02*hJ.radius,wavelength:[0.65,0.57,0.475],scaleDepth:0.24,mieScaleDepth:0.1};var e=this._atmosphereData;this._atUniformsCommon=this._atmosphereRenderer._uniformsCommon;this._atUniformsGround=this._atmosphereRenderer._atUniformsGround;this._atUniforms={fInnerRadius:{type:"f",value:e.innerRadius},fInnerRadius2:{type:"f",value:e.innerRadius*e.innerRadius},fOuterRadius:{type:"f",value:e.outerRadius},fOuterRadius2:{type:"f",value:e.outerRadius*e.outerRadius},fKrESun:{type:"f",value:e.Kr*e.ESun},fKmESun:{type:"f",value:e.Km*e.ESun},fKr4PI:{type:"f",value:e.Kr*4*Math.PI},fKm4PI:{type:"f",value:e.Km*4*Math.PI},fScale:{type:"f",value:1/(e.outerRadius-e.innerRadius)},fScaleDepth:{type:"f",value:e.scaleDepth},fScaleOverScaleDepth:{type:"f",value:1/(e.outerRadius-e.innerRadius)/e.scaleDepth},g:{type:"f",value:e.g},g2:{type:"f",value:e.g*e.g},fNightScale:{type:"f",value:3}};this._init();this.zIndex=10}d.VS_SHADER_TEXT=["precision highp float;","attribute vec3 aVertexPosition;","attribute vec2 aVertexTextureCoord;","attribute vec2 aCloudTextureCoord;","uniform vec3 cameraPositionGround;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 uMVMatrix;","uniform mat4 uPMatrix;","uniform mat4 uNMatrix;","uniform vec3 v3LightPositionGround;","uniform vec3 v3InvWavelength;","uniform float fCameraHeightGround;","uniform float fCameraHeight2Ground;","uniform float fOuterRadius;","uniform float fOuterRadius2;","uniform float fInnerRadius;","uniform float fInnerRadius2;","uniform float fKrESun;","uniform float fKmESun;","uniform float fKr4PI;","uniform float fKm4PI;","uniform float fScale;","uniform float fScaleDepth;","uniform float fScaleOverScaleDepth;","varying vec3 v3Direction;","varying vec3 c0;","varying vec3 c1;","const int nSamples = 3;","const float fSamples = 3.0;","varying vec2 vTextureCoord;","varying vec2 vCloudTextureCoord;","float scale(float fCos) {","    float x = 1.0 - fCos;","    return fScaleDepth * exp(-0.00287 + x*(0.459 + x*(3.83 + x*(-6.80 + x*5.25))));","}","void main(void) {","vec3 v3Ray = aVertexPosition - cameraPositionGround;","float fFar = length(v3Ray);","v3Ray /= fFar;","float B = 2.0 * dot(cameraPositionGround, v3Ray);","float C = fCameraHeight2Ground - fOuterRadius2;","float fDet = max(0.0, B*B - 4.0 * C);","float fNear = 0.5 * (-B - sqrt(fDet));","vec3 v3Start = cameraPositionGround + v3Ray * fNear;","fFar -= fNear;","float fDepth = exp((fInnerRadius - fOuterRadius) / fScaleDepth);","float fCameraAngle = dot(-v3Ray, aVertexPosition) / length(aVertexPosition);","float fLightAngle = dot(v3LightPositionGround, aVertexPosition) / length(aVertexPosition);","float fCameraScale = scale(fCameraAngle);","float fLightScale = scale(fLightAngle);","float fCameraOffset = fDepth * fCameraScale;","float fTemp = (fLightScale + fCameraScale);","float fSampleLength = fFar / fSamples;","float fScaledLength = fSampleLength * fScale;","vec3 v3SampleRay = v3Ray * fSampleLength;","vec3 v3SamplePoint = v3Start + v3SampleRay * 0.5;","vec3 v3FrontColor = vec3(0.0, 0.0, 0.0);","vec3 v3Attenuate;","for(int i = 0; i < nSamples; i ++)","{","    float fHeight = length(v3SamplePoint);","    float fDepth = exp(fScaleOverScaleDepth * (fInnerRadius - fHeight));","    float fScatter = fDepth * fTemp - fCameraOffset;","    v3Attenuate = exp(-fScatter * (v3InvWavelength * fKr4PI + fKm4PI));","    v3FrontColor += v3Attenuate * (fDepth * fScaledLength);","    v3SamplePoint += v3SampleRay;","}","c0 = v3Attenuate;","c1 = v3FrontColor * (v3InvWavelength * fKrESun + fKmESun);","gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);","vTextureCoord = aVertexTextureCoord;","vCloudTextureCoord = aCloudTextureCoord;","}"].join("\\n");d.FS_SHADER_TEXT=["precision highp float;","varying vec2 vTextureCoord;","varying vec2 vCloudTextureCoord;","uniform sampler2D uSampler;","uniform sampler2D uSamplerCloud;","uniform sampler2D uSamplerNight;","uniform bool uDrawCloud;","uniform float uEarthZoom;","uniform float uEarthZoomForNight;","uniform bool uUseColor;","uniform float fNightScale;","varying vec3 c0;","varying vec3 c1;","void main(void) {","    if (uUseColor == true) {","        gl_FragColor = vec4(c1, 1.0) + vec4(.01, .02, .15, 1.0);","        return;","    }","    vec4 cloudDiffuse = vec4(0, 0, 0, 0);","    float cloudAlpha = 0.0;","    if (uDrawCloud) {","        cloudDiffuse = texture2D(uSamplerCloud, vCloudTextureCoord);","        float grayValue = (cloudDiffuse.r + cloudDiffuse.g + cloudDiffuse.b) / 3.0;","        if (grayValue < 0.3) {","            cloudAlpha = 0.0;","        } else {","            cloudAlpha = grayValue;","        }","    }","    float atmosphereAlpha = 1.0;","    if (uEarthZoom > 5.0 && uEarthZoom < 6.0){","        atmosphereAlpha = 6.0 - uEarthZoom;","    }","    float cloudDisplayAlpha = 1.0;","    if (uEarthZoom > 1.0 && uEarthZoom < 2.0){","        cloudDisplayAlpha = 2.0 - uEarthZoom;","    }","    vec3 diffuseDay = (cloudDiffuse * cloudAlpha * cloudDisplayAlpha + ","        texture2D(uSampler, vTextureCoord) * (1.0 - cloudAlpha * cloudDisplayAlpha)).rgb;","    vec3 diffuseNight = texture2D( uSamplerNight, vTextureCoord ).rgb;","    vec3 day = diffuseDay * c0;","    vec3 night = 1.3 * diffuseNight * (1.0 - c0);","    if (uEarthZoom > uEarthZoomForNight) {","        gl_FragColor = vec4(c1, 1.0) * atmosphereAlpha + vec4(day, 1.0);","    }","    else {","        gl_FragColor = vec4(c1, 1.0) + vec4(day + night, 1.0);","    }","}"].join("\\n");d.VS_SHADER_HIGH_LEVEL_TEXT=["precision highp float;","attribute vec3 aVertexPosition;","attribute vec2 aVertexTextureCoord;","varying vec2 vTextureCoord;","uniform mat4 uMVMatrix;","uniform mat4 uPMatrix;","void main(void) {","    gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);","    vTextureCoord = aVertexTextureCoord;","}"].join("\\n");d.FS_SHADER_HIGH_LEVEL_TEXT=["precision highp float;","varying vec2 vTextureCoord;","uniform sampler2D uSampler;","uniform bool uUseColor;","void main(void) {","    if (uUseColor == true) {","        gl_FragColor = vec4(.11, .13, .23, 1.0);","        return;","    }","    gl_FragColor = texture2D(uSampler, vTextureCoord);","}"].join("\\n");C.extend(d.prototype,{_init:function(){this._initShaders();this._getAllUniforms();this._getAttribLocation();this._initShaders(true);this._getAllUniforms(true);this._getAttribLocation(true);this._sphere=this._earth._sphere},_initShaders:function(hL){var hJ=this._gl;var e;var T;if(!hL){e=d.VS_SHADER_TEXT;T=d.FS_SHADER_TEXT;this._glProgram1=hJ.createProgram();this._glProgram=this._glProgram1}else{e=d.VS_SHADER_HIGH_LEVEL_TEXT;T=d.FS_SHADER_HIGH_LEVEL_TEXT;this._glProgram2=hJ.createProgram();this._glProgram=this._glProgram2}var hK=this._glProgram;var hI=this._makeShader(e,hJ.VERTEX_SHADER);var i=this._makeShader(T,hJ.FRAGMENT_SHADER);hJ.attachShader(hK,hI);hJ.attachShader(hK,i);hJ.bindAttribLocation(hK,0,"aVertexPosition");hJ.linkProgram(hK);hJ.useProgram(hK)},_makeShader:function(hI,e){var T=this._gl;var i=T.createShader(e);T.shaderSource(i,hI);T.compileShader(i);return i},_getAllUniforms:function(hJ){var hI=this._glProgram;var T=this._gl;hI.pMatrixUniform=T.getUniformLocation(hI,"uPMatrix");hI.mvMatrixUniform=T.getUniformLocation(hI,"uMVMatrix");hI.sampler=T.getUniformLocation(hI,"uSampler");if(!hJ){hI.samplerCloud=T.getUniformLocation(hI,"uSamplerCloud");hI.samplerNight=T.getUniformLocation(hI,"uSamplerNight");hI.drawCloud=T.getUniformLocation(hI,"uDrawCloud");hI.nMatrixUniform=T.getUniformLocation(hI,"uNMatrix");hI.earthZoom=T.getUniformLocation(hI,"uEarthZoom");hI.earthZoomForNight=T.getUniformLocation(hI,"uEarthZoomForNight");var i=this._atUniformsCommon;for(var e in i){hH(T,hI,e)}i=this._atUniformsGround;for(e in i){hH(T,hI,e)}i=this._atUniforms;for(e in i){hH(T,hI,e)}}hI.useColor=T.getUniformLocation(hI,"uUseColor")},_setUniforms:function(){var hJ=this._glProgram;var hI=this._gl;var T=this._earth.getZoom();hI.uniformMatrix4fv(hJ.pMatrixUniform,false,this._pMatrix);if(T>15){hI.uniformMatrix4fv(hJ.mvMatrixUniform,false,this._mvMatrixCamera)}else{hI.uniformMatrix4fv(hJ.mvMatrixUniform,false,this._mvMatrix)}if(T<6){mat4.invert(this._nMatrix,this._mvMatrix);mat4.transpose(this._nMatrix,this._nMatrix);hI.uniformMatrix4fv(hJ.nMatrixUniform,false,this._nMatrix);hI.uniform1f(hJ.earthZoom,Math.round(T*1000)/1000);hI.uniform1f(hJ.earthZoomForNight,this._earth.zoomForNight);var i=this._atUniformsCommon;for(var e in i){eT(hI,hJ,e,i[e].value,i[e].type)}i=this._atUniformsGround;for(e in i){eT(hI,hJ,e,i[e].value,i[e].type)}i=this._atUniforms;for(e in i){eT(hI,hJ,e,i[e].value,i[e].type)}}},_getAttribLocation:function(T){var e=this._gl;var i=this._glProgram;i.vertexPositionAttribute=e.getAttribLocation(i,"aVertexPosition");i.vertexTexCoordAttribute=e.getAttribLocation(i,"aVertexTextureCoord");if(!T){i.cloudTexCoordAttribute=e.getAttribLocation(i,"aCloudTextureCoord")}},onStatusChange:function(i){this._camera=i;this._pMatrix=i.getProjectionMatrix();this._mvMatrix=i.getModelViewMatrix();var e=this._earth.getZoom();if(e>15){this._mvMatrixCamera=i._mvMatrixForCamera}this._arrCurViewTileModels=this._getCurViewTileModels();if(e<3){this._loadCloudTexture()}if(e<2){this._loadHighResTextures(true);return}var T=this;if(T.ThumbLoadTimer){clearTimeout(T.ThumbLoadTimer)}T.ThumbLoadTimer=setTimeout(function(){T._loadThumbTextures(3);T._loadThumbTextures();T._loadHighResTextures()},10)},_loadCloudTexture:function(){if(this._cloudTextureImage!==null||this._textureInfoPool.getData("cloud")){return}this._cloudTextureImage=new Image();this._cloudTextureImage.crossOrigin="anonymous";var hI=this;var hJ=this._gl;this._cloudTextureImage.onload=function(){var hK=b6.utils.createTexture(hJ,this);hI._textureInfoPool.setData("cloud",hK);hI._cloudTextureImage=null;hI._earth.fire(new a6("onrefresh"))};var e=this._earth.getContainerSize().height;var T=a1();var i="";if(e>800||T>=1.5){i=eV.imgPath+"tiles/clouds-2k.jpg?20170702"}else{i=eV.imgPath+"tiles/clouds.jpg?20170702"}this._cloudTextureImage.src=i},_loadHighResTextures:function(i){var e=this;if(!i&&e.loadTimer){clearTimeout(e.loadTimer)}if(i&&e.loadTimer){return}e.loadTimer=setTimeout(function(){e._loadTextures();e.loadTimer=null;if(e._earth.getZoom()<5&&e._earth._showRealSunlight){e._loadNightTextures()}},200)},_getCurViewTileModels:function(){var hK=this._earth;var hJ=hK.scene;var i=hK.getBounds();var hI=false;if(hJ.ifXYZInView(0,this._radius,0)){hI="n"}else{if(hJ.ifXYZInView(0,-this._radius,0)){hI="s"}}var e=this._sphere;var T=Math.floor(hK.getZoom());var hL=e.getCurViewModels(i,hI,T);return hL},_loadThumbTextures:function(hT){if(this._earth._notLoadThumb){return}var hQ=this._arrCurViewTileModels;var T={};var hW=this;function hM(){hW._thumbLoaded++;hW._earth.fire(new a6("onrefresh"))}for(var hR=0,hP=hQ.length;hR<hP;hR++){var hS=hQ[hR];var hJ=hS.col;var hL=hS.row;var hV=hS.imgZoom;if(hS.projType==="er"&&!hS.polar){continue}var hI;var hK;var hX;var e;var hU=hT||hV-2;var hN=Math.pow(2,hV-hU);if(hS.polar===true){hX=hS.key.replace("_"+hV,"_"+hU)}else{hI=Math.floor(hJ/hN);hK=Math.floor(hL/hN);if(hU<=5){e=q.getMergedKey(hI,hK,hU)}hX="key_"+(hS.projType==="er"?"er_":"")+hI+"_"+hK+"_"+hU}var hO;if(e){hO=this._mergedTextureCache.getData(e);if(!T[hX]&&(!hO||!hO[hI+"_"+hK])){T[hX]=true;this._thumbToLoad++;this._loadTexture(hI,hK,hU,hS.projType,hX,hM,e)}}else{hO=this._textureInfoPool.getData(hX);if(!hO&&!T[hX]){T[hX]=true;this._thumbToLoad++;this._loadTexture(hI,hK,hU,hS.projType,hX,hM)}}}},_loadTexture:function(i,hQ,hK,hM,hN,hP,hI){var hL=this;var hJ=this._gl;var T=this._imgPool.get();T.crossOrigin="anonymous";T.setAttribute("data-retry-count",0);T.onload=function hO(){var hR=false;if(hM!=="er"&&hM!=="night"&&hM!=="world"&&hK<=5){hL._mergeTileTexture(hJ,i,hQ,hI,this,hK);hR=true}else{var hS=b6.utils.createTexture(hJ,this,{format:hJ.RGB});hL._textureInfoPool.setData(hN,hS)}hL._imgPool.free(this);if(hP){hP.call(hL,hN,hS,hR)}};T.onerror=function e(){var hR=this;var hU=this.src;var hT=parseInt(this.getAttribute("data-retry-count"),10);if(hT===5){return}hT++;this.setAttribute("data-retry-count",hT);hL._earth.fire(new a6("onsatelayerloaderror"));setTimeout(function hS(){hR.src=hU},3000)};T.src=this._layer.getTilesUrl(i,hQ,hK,hM,hN)},_mergeTileTexture:function(hM,T,hL,hK,i,hJ){var e=this._mergedTextureCache.getData(hK);if(!e){e=b6.utils.createTexture(hM,this._canvasForMergedTile,{format:hM.RGB});e.tileCount=0;e.totalCount=4;if((hJ===3&&(T===2||T===-3))||(hJ===4&&(T===4||T===-5))){e.totalCount/=2;if(hJ===4&&hL===-3){e.totalCount/=2}}this._mergedTextureCache.setData(hK,e)}if(!e[T+"_"+hL]){hM.bindTexture(hM.TEXTURE_2D,e);e[T+"_"+hL]=true;e.tileCount++;var hI=q.getMergedTextureOffset(T,hL);hM.texSubImage2D(hM.TEXTURE_2D,0,hI[0]*512,hI[1]*512,hM.RGB,hM.UNSIGNED_BYTE,i)}},_loadNightTextures:function(){var i="key_er_1";var hI=this._textureInfoPool.getData(i);if(!hI){this._loadTexture(0,0,1,"world","key_er_1",this._onNightTextureLoad)}var e="night_key_er_1";var T=this._textureInfoPool.getData(e);if(!T){this._loadTexture(0,0,1,"night","night_key_er_1",this._onNightTextureLoad)}this._nightLoaded=!!(hI&&T)},_onNightTextureLoad:function(){var i="key_er_1";var hI=this._textureInfoPool.getData(i);var e="night_key_er_1";var T=this._textureInfoPool.getData(e);if(hI&&T){this._nightLoaded=true;this._earth.fire(new a6("onrefresh"))}},_loadTextures:function(){if(this._earth._notLoadHigh){return}var hQ=this;var hR=this._arrCurViewTileModels;for(var hM=0,hK=hR.length;hM<hK;hM++){var hI=hR[hM];if(hI.mergedTile){continue}var hJ=hI.col;var hT=hI.row;var hO=hI.imgZoom;var hS=hI.key;var hL=hI.mergedKey||"";if(hI.projType==="er"){if(hI.polar===true&&hO<=5){var T=hQ._textureInfoPool.getData(hS);if(!T){this._tileNeedToLoadCount++;this._loadTexture(0,0,hO,hI.projType,hS,this._onTexturesLoad)}}continue}if(hI.mergedKey){var e=hQ._mergedTextureCache.getData(hI.mergedKey);if(e&&e[hJ+"_"+hT]){continue}}var hN=hQ._textureInfoPool.getData(hS);var hP=hI.projType;if(!hN){this._tileNeedToLoadCount++;this._loadTexture(hJ,hT,hO,hP,hS,this._onTexturesLoad,hL)}}hQ._earth.fire(new a6("onrefresh"))},_onTexturesLoad:function(T,hI,i){this._tileLoadedCount++;var hJ=this._earth;if(this._tileNeedToLoadCount===this._tileLoadedCount){this._tileNeedToLoadCount=this._tileLoadedCount=0;if(!hJ._firstTilesLoadedTime){var e=new a6("onearthtilesloaded");e.initTime=hJ._initFinishTime-hJ._initStartTime;e.loadTime=hJ._firstTilesLoadedTime=Date.now()-hJ._initStartTime;hJ.fire(e)}this._earth.fire(new a6("ontilesloaded"))}if(!i){this._textureInfoPool.setData(T,hI)}hJ.fire(new a6("onrefresh"))},renderFrame:function(){var T=this._gl;var e=this._earth.getZoom();if(e<6){this._glProgram=this._glProgram1}else{this._glProgram=this._glProgram2}T.useProgram(this._glProgram);var i=this._webglState;i.disableCap("depthTest");i.enableCap("blend");i.enableCap("cullFace");i.cullFace(T.BACK);i.blendFunc(T.SRC_ALPHA,T.ONE_MINUS_SRC_ALPHA);i.depthMask(true);this.updateAt();this._setUniforms();i.initAttribute();this._renderFrame()},_renderFrame:function(){var h2=this._gl;var hJ=this._earth;var hI=hJ.getZoom();var hP=this._glProgram;var h1=this._arrCurViewTileModels;var hN=this._webglState;hN.enableAttribute(hP.vertexPositionAttribute);hN.enableAttribute(hP.vertexTexCoordAttribute);var hQ=false;var hY=this._textureInfoPool.getData("cloud");if(hY&&hI<2){hQ=true;hN.enableAttribute(hP.cloudTexCoordAttribute)}hN.disableUnusedAttributes();if(!h1||h1.length===0){return}var hV=this._earth.zoomForNight;var hS=this._float32Array;var hT=this._uint16Array;var e=[];var hX=0;if(hI>=hV+1){var hL=[];var hK=[];var hU=0;for(var h3=0,hZ=h1.length;h3<hZ;h3++){var h4=h1[h3];if(h4.loadTextureOnly){continue}if(h4.projType==="er"&&!h4.polar){continue}e.push(h4);var h6=h4.vertex;var hO=h4.index;var T=h4.textureCoord;var h9=h4.key;var hW=null;if(h4.atEdge!==true){if(h4.mergedTile){hW=this._mergedTextureCache.getData(h9)}else{hW=this._textureInfoPool.getData(h9)}}if(!hW||h4.mergedTile&&hW.totalCount!==hW.tileCount){var h8=this._getThumbTextureInfo(h4);if(h8){hW=h8[0];T=h8[1]}}h4.texture=hW;if(hI>15){for(var h0=0,hR=h6.length/3;h0<hR;h0++){var h7=[h6[h0*3],h6[h0*3+1],h6[h0*3+2]];h7=cD(h7,hJ.rotationInfo);hL.push(h7[0],h7[1],h7[2],T[h0*2],T[h0*2+1])}}else{for(var h0=0,hR=h6.length/3;h0<hR;h0++){hL.push(h6[h0*3],h6[h0*3+1],h6[h0*3+2],T[h0*2],T[h0*2+1])}}if(hX>0){hU=hU+e[hX-1].vertex.length/3}for(h0=0,hR=hO.length/3;h0<hR;h0++){hK.push(hO[h0*3]+hU,hO[h0*3+1]+hU,hO[h0*3+2]+hU)}hX++}h2.bindBuffer(h2.ARRAY_BUFFER,this._trianglesVerticeBuffer);if(hL.length<hS.length){hS.set(hL)}else{hS=new Float32Array(hL)}h2.bufferData(h2.ARRAY_BUFFER,hS,h2.STREAM_DRAW);h2.vertexAttribPointer(hP.vertexPositionAttribute,3,h2.FLOAT,false,20,0);h2.vertexAttribPointer(hP.vertexTexCoordAttribute,2,h2.FLOAT,false,20,12);if(hP.cloudTexCoordAttribute){h2.vertexAttribPointer(hP.cloudTexCoordAttribute,2,h2.FLOAT,false,20,12)}h2.bindBuffer(h2.ELEMENT_ARRAY_BUFFER,this._triangleVerticesIndexBuffer);if(hK.length<hT.length){hT.set(hK)}else{hT=new Uint16Array(hK)}h2.bufferData(h2.ELEMENT_ARRAY_BUFFER,hT,h2.STATIC_DRAW);var hM=0;h2.uniform1i(hP.drawCloud,hQ);hN.activeTexture(h2.TEXTURE0);for(h3=0,hZ=e.length;h3<hZ;h3++){var h4=e[h3];var hO=h4.index;var hW=h4.texture;if(!hW){if(h4.projType!=="er"||h4.polar===true){h2.uniform1i(hP.useColor,true)}}else{h2.uniform1i(hP.useColor,false);h2.bindTexture(h2.TEXTURE_2D,hW)}h2.uniform1i(hP.sampler,0);if(h3>0){hM=hM+e[h3-1].index.length*2}h2.drawElements(h2.TRIANGLES,hO.length,h2.UNSIGNED_SHORT,hM)}}if(hI<hV+1){var h4=h1[h1.length-1];var h6=h4.vertex;var hO=h4.index;var T=h4.textureCoord;var h9=h4.key;var hW=this._textureInfoPool.getData(h9);var hL=[];for(var h0=0,hR=h6.length/3;h0<hR;h0++){hL.push(h6[h0*3],h6[h0*3+1],h6[h0*3+2],T[h0*2],T[h0*2+1])}h2.bindBuffer(h2.ARRAY_BUFFER,this._trianglesVerticeBuffer);hS.set(hL);h2.bufferData(h2.ARRAY_BUFFER,hS,h2.STREAM_DRAW);h2.vertexAttribPointer(hP.vertexPositionAttribute,3,h2.FLOAT,false,20,0);h2.vertexAttribPointer(hP.vertexTexCoordAttribute,2,h2.FLOAT,false,20,12);h2.vertexAttribPointer(hP.cloudTexCoordAttribute,2,h2.FLOAT,false,20,12);h2.bindBuffer(h2.ELEMENT_ARRAY_BUFFER,this._triangleVerticesIndexBuffer);hT.set(hO);h2.bufferData(h2.ELEMENT_ARRAY_BUFFER,hT,h2.STREAM_DRAW);h2.uniform1i(hP.useColor,true);if(hW){hN.activeTexture(h2.TEXTURE0);h2.uniform1i(hP.useColor,false);h2.bindTexture(h2.TEXTURE_2D,hW);h2.uniform1i(hP.sampler,0)}if(hY){h2.uniform1i(hP.drawCloud,true);h2.activeTexture(h2.TEXTURE2);h2.bindTexture(h2.TEXTURE_2D,hY);h2.uniform1i(hP.samplerCloud,2)}if(this._earth._showRealSunlight){var h5=this._textureInfoPool.getData("night_"+h9);if(h5){hN.activeTexture(h2.TEXTURE1);h2.bindTexture(h2.TEXTURE_2D,h5);h2.uniform1i(hP.samplerNight,1)}}h2.drawElements(h2.TRIANGLES,hO.length,h2.UNSIGNED_SHORT,0)}},_getThumbTextureInfo:function(hZ){var hL=hZ.col;var hO=hZ.row;var h1=hZ.imgZoom;var hT=null;var hQ=h1-1;var hS=1;while(!hT&&hQ>=hS){var hR=Math.pow(2,h1-hQ);var hK=Math.floor(hL/hR);var hN=Math.floor(hO/hR);var h3;var h0=false;if(hZ.projType==="er"){if(hZ.polar===true){h3=hZ.key.replace("_"+h1,"_"+hQ);hT=this._textureInfoPool.getData(h3);if(hT){return[hT,hZ.textureCoord]}}}else{if(hQ<=5){h0=true;if(h1<=5){h3="key_merge_"+hK+"_"+hN+"_"+hQ}else{h3=q.getMergedKey(hK,hN,hQ)}}else{h3="key_"+hK+"_"+hN+"_"+hQ}}if(h0){hT=this._mergedTextureCache.getData(h3)}else{hT=this._textureInfoPool.getData(h3)}if(hT){var T=hK*hR;var hJ=hN*hR;var hW=hL-T;var hY=hO-hJ;var hU=hR;var h2=hW/hU;var hP=hY/hU;var e=hZ.textureCoord.slice(0);var hI=0;if(hZ.textureCoord._dir){hI=hZ.textureCoord._dir==="left"?-0.01:0.01;if(h0){hI/=2}}for(var hX=0,hV=e.length;hX<hV;hX+=2){e[hX]=h2+(e[hX]-hI)/hR+hI;e[hX+1]=hP+e[hX+1]/hR;if(h1>5&&h0){var hM=q.getMergedTextureOffset(hK,hN);e[hX]=e[hX]/2+hM[0];e[hX+1]=e[hX+1]/2+hM[1]}}return[hT,e]}hQ--}return null},updateAt:function(){var e=this._atmosphereData;var T=this._earth.getZoom();if(T>1){var i=T-1;i=i>1.2?1.2:i;e.Kr=0.0075-i*0.0005;e.ESun=16-i*1;e.scaleDepth=0.25-i/20;this._atUniforms.fKrESun.value=e.Kr*e.ESun;this._atUniforms.fKmESun.value=e.Km*e.ESun;this._atUniforms.fScaleDepth.value=e.scaleDepth;this._atUniforms.fScaleOverScaleDepth.value=1/(e.outerRadius-e.innerRadius)/e.scaleDepth}}});function eD(e){this._earth=e;var i=this._gl=a0(e._canvas);this._overlayManagerGL=new ds(e);this._layers=e._layers;this._textureInfoPool=new fC(200,{clearCallback:function(T){if(T&&T.texture){i.deleteTexture(T.texture)}}});this._overlayTextureInfo={texture:null,opacity:0,width:0,height:0};this._overlayTextureInfoLOD={texture:null,opacity:0,width:0,height:0};this._imgCache=new fC(150);this._imgToLoad=0;this._preModels={};this.bind()}C.extend(eD.prototype,{bind:function(){var T=this;function i(hI){T._textureInfoPool.forEach(function(hJ){hJ.texture=null});T.loadTiles()}function e(hI){if(hI.layer&&!hI.layer.renderer){T._textureInfoPool.clear();T.loadTiles()}}this._earth.on("layer_add",e);this._earth.on("layer_remove",e);this._earth.on("overlaylayer_status_change",i)},prepareData:function(){if(this._tileModels){var hJ={};for(var hI=0,e=this._tileModels.length;hI<e;hI++){var T=this._tileModels[hI].key;hJ[T]=true}}},savePreModels:function(){this._preModels={};if(this._tileModels){for(var hI=0,e=this._tileModels.length;hI<e;hI++){var T=this._tileModels[hI].key;this._preModels[T]=true}}},loadTiles:function(){var hN=this._tileModels;if(!hN){return}this.prepareData();this.processOverlayCanvas();if(this._loadTimer){clearTimeout(this._loadTimer)}var hM=this;this._loadTimer=setTimeout(function(){if(hM._imgToLoad>0){hM._clearWaiting();hM._startAlphaAnimation()}this._loadTimer=null},1500);for(var hK=0,hI=hN.length;hK<hI;hK++){var e=hN[hK];var T=e.col;var hP=e.row;var hL=e.imgZoom;var hO=e.key;var hJ=this._textureInfoPool.getData(hO);if(!hJ){hJ={imageLoad:false,texture:null,opacity:0};this._textureInfoPool.setData(hO,hJ)}this.loadTile(T,hP,hL,hO)}if(this._imgToLoad===0){clearTimeout(this._loadTimer);this._earth.fire(new a6("onlayertilesload"));this._startAlphaAnimation()}},processOverlayCanvas:function(){this._overlayManagerGL.generateOverlayTile();var e=this._overlayManagerGL.getOverlayCanvas();this._prepareOverlayTexture(e);if(this._earth.getTilt()>0&&this._earth.getImageZoom()>3||this._earth.getZoom()<6){this._overlayManagerGL.generateOverlayTile(this._earth.getImageZoom()-1);var i=this._overlayManagerGL.getOverlayCanvas(true);this._prepareOverlayTexture(i,true)}},loadTile:function(i,hL,hK,T){var hJ=this._textureInfoPool.getData(T);if(hJ.imageLoad&&hJ.texture!==null){if(this._preModels[T]){hJ.opacity=1}return}if(this._layers.length<2||!this._layers[1].getTilesUrl){hJ.imageLoad=true;clearTimeout(this._loadTimer);return}var hI=this;var e=this._imgCache.getData(T);if(e){hJ.imageLoad=true;hI._prepareImgTexture(e,i,hL,hK,T);if(hI._imgToLoad===0){clearTimeout(hI._loadTimer);hI._clearWaiting();hI._startAlphaAnimation()}return}e=new Image();e.crossOrigin="anonymous";this._imgToLoad++;e.onload=function(){hJ.imageLoad=true;hI._prepareImgTexture(this,i,hL,hK,T);hI._imgToLoad--;hI._imgCache.setData(T,this);if(hI._imgToLoad===0){clearTimeout(hI._loadTimer);hI._clearWaiting();hI._startAlphaAnimation();if(!hI._earth._firstLayerTilesLoadedTime){var hM=new a6("onlayertilesload");hM.layersLoadTime=hI._earth._firstLayerTilesLoadedTime=Date.now()-hI._earth._initStartTime;hI._earth.fire(hM)}}};e.onerror=function(){hI._earth.fire(new a6("onstreetlayerloaderror"))};e.src=hI._layers[1].getTilesUrl(i,hL,hK)},_prepareImgTexture:function(e,i,hL,hK,T){var hJ=this._createTexture(e);var hI=this._textureInfoPool.getData(T);if(hI){hI.texture=hJ;hI.waitForOthers=true}},_prepareOverlayTexture:function(T,i){if(!T){return}var hI=this._createTexture(T);var e;if(!i){e=this._overlayTextureInfo}else{e=this._overlayTextureInfoLOD}e.texture=hI;e.waitForOthers=false;e.width=T.width;e.height=T.height;e.fromCol=T.fromCol;e.fromRow=T.fromRow;e.toCol=T.toCol;e.toRow=T.toRow;e.cols=T.cols;e.rows=T.rows},_startAlphaAnimation:function(){var e=this;if(e._ani){e._ani.stop()}e._ani=new o({duration:400,transition:ci.easeOutQuad,render:function(T,i){e._setTextureOpacity(T)},finish:function(){e._setTextureOpacity(1);e._ani=null},onStop:function(i){e._setTextureOpacity(1);e._ani=null}})},_createTexture:function(T){var i=this._gl;var e=i.createTexture();i.bindTexture(i.TEXTURE_2D,e);i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,true);i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,T);i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE);i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE);i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR);i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR);return e},_clearWaiting:function(){var T=this._tileModels;for(var hJ=0,e=T.length;hJ<e;hJ++){var hI=T[hJ].key;var hK=this._textureInfoPool.getData(hI);if(hK){hK.waitForOthers=false;if(hK.opacity!==1){hK.opacity=0}}}},_setTextureOpacity:function(hL){var T=this._tileModels;var hK=1;for(var hJ=0,e=T.length;hJ<e;hJ++){var hI=T[hJ].key;var hM=this._textureInfoPool.getData(hI);if(hM&&hM.opacity!==hK){hM.opacity=hL*hK}}this._earth.fire(new a6("onrefresh"))},getTextureInfo:function(e){return this._textureInfoPool.getData(e)},getOverlayTextureInfo:function(e){if(e){return this._overlayTextureInfoLOD}return this._overlayTextureInfo}});function l(e){this._earth=e;this._canvas=e._canvas;var i=this._gl=e.scene._gl;this._webglState=b6.WebGLState.get(i,e._guid);this._glProgram=null;this._radius=e.radius;this._blankTileCanvas=S("canvas");this._blankTileCanvas.width=this._blankTileCanvas.height=256;this._blankTileCanvas.getContext("2d").clearRect(0,0,256,256);this._blankTileTexture=null;this._mvMatrix=mat4.create();this._pMatrix=mat4.create();this._mvMatrixCamera=mat4.create();this._trianglesVerticeBuffer=i.createBuffer();this._triangleVerticesIndexBuffer=i.createBuffer();this._float32Array=new Float32Array(3000);this._uint16Array=new Uint16Array(3000);this.zIndex=11;this._init()}l.VS_SHADER_TEXT=["precision highp float;","attribute vec3 aVertexPosition;","attribute vec2 aVertexTextureCoord;","attribute vec2 aOverlayTextureCoord;","varying vec2 vTextureCoord;","varying vec2 vOverlayTextureCoord;","uniform mat4 uMVMatrix;","uniform mat4 uPMatrix;","void main(void) {","    gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);","    vTextureCoord = aVertexTextureCoord;","    vOverlayTextureCoord = aOverlayTextureCoord;","}"].join("\\n");l.FS_SHADER_TEXT=["precision highp float;","varying vec2 vTextureCoord;","varying vec2 vOverlayTextureCoord;","uniform sampler2D uSampler;","uniform sampler2D uOverlaySampler;","uniform float uAlpha;","","vec4 getBlendColor(in vec4 source, in vec4 back, in float alphaSource, in float alphaBack) {","    vec4 finalColor = (1.0 - alphaSource / 1.0) * back +","                      (alphaSource / 1.0) * ((1.0 - alphaBack) * source + alphaBack * source);","    return finalColor;","}","","void main(void) {","    vec4 layer = texture2D(uSampler, vTextureCoord);","    vec4 overlay = texture2D(uOverlaySampler, vOverlayTextureCoord);","    vec4 finalColor = getBlendColor(overlay, layer * uAlpha, overlay.a, layer.a);","    if (finalColor.a == 0.0) {","        discard;","    }","    gl_FragColor = vec4(finalColor.rgb, finalColor.a);","}"].join("\\n");C.extend(l.prototype,{_init:function(){this._gl=a0(this._canvas);this._initShaders();this._getAllUniforms();this._getAttribLocation();this._createBlankTileTexture();this._layerTextureManager=new eD(this._earth);this._sphere=this._earth._sphere},_initShaders:function(){var e=l.VS_SHADER_TEXT;var T=l.FS_SHADER_TEXT;var hJ=this._gl;var hK=this._glProgram=hJ.createProgram();var hI=this._makeShader(e,hJ.VERTEX_SHADER);var i=this._makeShader(T,hJ.FRAGMENT_SHADER);hJ.attachShader(hK,hI);hJ.attachShader(hK,i);hJ.linkProgram(hK);hJ.useProgram(hK)},_makeShader:function(hI,e){var T=this._gl;var i=T.createShader(e);T.shaderSource(i,hI);T.compileShader(i);return i},_getAllUniforms:function(){var i=this._glProgram;var e=this._gl;i.pMatrixUniform=e.getUniformLocation(i,"uPMatrix");i.mvMatrixUniform=e.getUniformLocation(i,"uMVMatrix");i.sampler=e.getUniformLocation(i,"uSampler");i.overlaySampler=e.getUniformLocation(i,"uOverlaySampler");i.alpha=e.getUniformLocation(i,"uAlpha")},_setUniforms:function(){var i=this._glProgram;var e=this._gl;e.uniformMatrix4fv(i.pMatrixUniform,false,this._pMatrix);if(this._earth.getZoom()>15){e.uniformMatrix4fv(i.mvMatrixUniform,false,this._mvMatrixCamera)}else{e.uniformMatrix4fv(i.mvMatrixUniform,false,this._mvMatrix)}},_getAttribLocation:function(){var e=this._gl;var i=this._glProgram;i.vertexPositionAttribute=e.getAttribLocation(i,"aVertexPosition");i.vertexTexCoordAttribute=e.getAttribLocation(i,"aVertexTextureCoord");i.overlayTexCoordAttribute=e.getAttribLocation(i,"aOverlayTextureCoord")},_createBlankTileTexture:function(){var i=this._gl;var e=this._blankTileTexture=i.createTexture();i.bindTexture(i.TEXTURE_2D,e);i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,this._blankTileCanvas);i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE);i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE);i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR);i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR)},onStatusChange:function(i){this._camera=i;this._pMatrix=i.getProjectionMatrix();this._mvMatrix=i.getModelViewMatrix();var e=this._earth.getZoom();var hI=Math.floor(e);if(e>15){this._mvMatrixCamera=i._mvMatrixForCamera}if(hI>=this._earth.zoomForNight+1){var T=this;if(T.loadTimer){clearTimeout(T.loadTimer)}T.loadTimer=setTimeout(function(){if(T._earth.getZoom()<T._earth.zoomForNight+1){return}var hJ=T._arrCurViewTileModels=T._sphere.getCurViewNormalModels();T._layerTextureManager.savePreModels();T._layerTextureManager._tileModels=hJ;if(T._earth._notLoadHigh){return}if(!hJ){return}T._layerTextureManager.loadTiles()},200)}else{this._arrCurViewTileModels=null}},renderFrame:function(){if(this._earth.getZoom()<this._earth.zoomForNight+1){return}var T=this._gl;T.useProgram(this._glProgram);var i=this._webglState;i.disableCap("depthTest");i.enableCap("blend");i.enableCap("cullFace");i.cullFace(T.BACK);i.blendFunc(T.SRC_ALPHA,T.ONE_MINUS_SRC_ALPHA);this._setUniforms();var e=this._arrCurViewTileModels;if(e){this._renderFrame(e)}},_renderFrame:function(h8){if(h8.length===0){return}var h2=this._earth._map;var hO=h2._displayOptions.street;var hP=h2._displayOptions.overlay;if(!hO&&!hP){return}var hQ=this._gl;var hR=this._glProgram;var hI=h8[0].imgZoom;var e=this._earth;var hS=e.getImageZoom();if(Math.abs(hI-hS)>2){return}var ig=this._webglState;ig.initAttribute();ig.enableAttribute(hR.vertexPositionAttribute);ig.enableAttribute(hR.vertexTexCoordAttribute);ig.enableAttribute(hR.overlayTexCoordAttribute);ig.disableUnusedAttributes();var h1=this._layerTextureManager.getOverlayTextureInfo();var h0=h1?h1.texture:null;var id=this._layerTextureManager.getOverlayTextureInfo(true);var hM=id?id.texture:null;var h7=h1;var ic=h1.cols;var hJ=h1.rows;var ie=e.getTilt();if(ie===0&&hP){ig.activeTexture(hQ.TEXTURE1);hQ.bindTexture(hQ.TEXTURE_2D,h0||this._blankTileTexture);hQ.uniform1i(hR.overlaySampler,1)}for(var ib=0,h9=h8.length;ib<h9;ib++){var hK=h8[ib];var hZ=hK.vertex;var h4=hK.index;var h5=hK.textureCoord;var hV=hK.key;var hN=hK.col;var hT=hK.row;var T=hK.imgZoom;var hL=this._layerTextureManager.getTextureInfo(hV);var hX=hL?hL.texture:null;hQ.uniform1f(hR.alpha,hL?hL.opacity:0);if(ie>0&&hP){ig.activeTexture(hQ.TEXTURE1);if(T===hS){h7=h1;hQ.bindTexture(hQ.TEXTURE_2D,h0)}else{h7=id;hQ.bindTexture(hQ.TEXTURE_2D,hM)}hQ.uniform1i(hR.overlaySampler,1);ic=h7.cols;hJ=h7.rows}var h6=[];for(var ia=0,h3=hZ.length/3;ia<h3;ia++){if(e.getZoom()>15){var hU=[hZ[ia*3],hZ[ia*3+1],hZ[ia*3+2]];hU=cD(hU,e.rotationInfo);h6.push(hU[0],hU[1],hU[2],h5[ia*2],h5[ia*2+1])}else{h6.push(hZ[ia*3],hZ[ia*3+1],hZ[ia*3+2],h5[ia*2],h5[ia*2+1])}var hW=hN-h7.fromCol;var hY=hT-h7.fromRow;if(hN<=h7.toCol&&hT<=h7.toRow&&hW>=0&&hY>=0&&hP){h6.push(h5[ia*2]/ic+hW/ic,h5[ia*2+1]/hJ+hY/hJ)}else{h6.push(0,0)}}hQ.bindBuffer(hQ.ARRAY_BUFFER,this._trianglesVerticeBuffer);if(h6.length>this._float32Array.length){continue}this._float32Array.set(h6);hQ.bufferData(hQ.ARRAY_BUFFER,this._float32Array,hQ.STREAM_DRAW);hQ.vertexAttribPointer(hR.vertexPositionAttribute,3,hQ.FLOAT,false,28,0);hQ.vertexAttribPointer(hR.vertexTexCoordAttribute,2,hQ.FLOAT,false,28,12);hQ.vertexAttribPointer(hR.overlayTexCoordAttribute,2,hQ.FLOAT,false,28,20);hQ.bindBuffer(hQ.ELEMENT_ARRAY_BUFFER,this._triangleVerticesIndexBuffer);if(h4.length>this._uint16Array.length){continue}this._uint16Array.set(h4);hQ.bufferData(hQ.ELEMENT_ARRAY_BUFFER,this._uint16Array,hQ.STREAM_DRAW);ig.activeTexture(hQ.TEXTURE0);if(hX&&hL.waitForOthers===false&&hO){hQ.bindTexture(hQ.TEXTURE_2D,hX)}else{hQ.bindTexture(hQ.TEXTURE_2D,this._blankTileTexture)}hQ.uniform1i(hR.sampler,0);hQ.drawElements(hQ.TRIANGLES,h4.length,hQ.UNSIGNED_SHORT,0)}}});function gH(T){this._earth=T;this._canvas=T._canvas;var hI=this._gl=T.scene._gl;this._webglState=b6.WebGLState.get(this._gl,T._guid);this._glProgram=null;this._trianglesVerticeBuffer=hI.createBuffer();this._triangleVerticesIndexBuffer=hI.createBuffer();this._float32Array=new Float32Array(120600);this._uint16Array=new Uint16Array(240000);this._atmosphereData={Kr:0.0015,Km:0.00001,ESun:16,g:-0.95,innerRadius:0.992*T.radius,outerRadius:1.02*T.radius,wavelength:[0.65,0.57,0.475],scaleDepth:0.25,mieScaleDepth:0.1};var e=this._atmosphereData;this._uniformsCommon={modelViewMatrix:{type:"mat4",value:mat4.create()},projectionMatrix:{type:"mat4",value:mat4.create()},cameraPosition:{type:"v3",value:vec3.fromValues(0,0,4.4*T.radius)},v3LightPosition:{type:"v3",value:vec3.normalize(vec3.create(),vec3.fromValues(100000000,0,100000000))},v3InvWavelength:{type:"v3",value:vec3.fromValues(1/Math.pow(e.wavelength[0],4),1/Math.pow(e.wavelength[1],4),1/Math.pow(e.wavelength[2],4))},v3LightDirection:{type:"v3",value:vec3.fromValues(0,0,1)},fCameraHeight:{type:"f",value:0},fCameraHeight2:{type:"f",value:0},nSamples:{type:"i",value:3},fSamples:{type:"f",value:3}};this._uniforms={fInnerRadius:{type:"f",value:e.innerRadius},fInnerRadius2:{type:"f",value:e.innerRadius*e.innerRadius},fOuterRadius:{type:"f",value:e.outerRadius},fOuterRadius2:{type:"f",value:e.outerRadius*e.outerRadius},fKrESun:{type:"f",value:e.Kr*e.ESun},fKmESun:{type:"f",value:e.Km*e.ESun},fKr4PI:{type:"f",value:e.Kr*4*Math.PI},fKm4PI:{type:"f",value:e.Km*4*Math.PI},fScale:{type:"f",value:1/(e.outerRadius-e.innerRadius)},fScaleDepth:{type:"f",value:e.scaleDepth},fScaleOverScaleDepth:{type:"f",value:1/(e.outerRadius-e.innerRadius)/e.scaleDepth},g:{type:"f",value:e.g},g2:{type:"f",value:e.g*e.g},nSamples:{type:"i",value:3},fSamples:{type:"f",value:3},fNightScale:{type:"f",value:6}};this._atUniformsGround={cameraPositionGround:{type:"v3",value:vec3.fromValues(0,0,4.4*T.radius)},v3LightPositionGround:{type:"v3",value:vec3.normalize(vec3.create(),vec3.fromValues(100000000,0,100000000))},fCameraHeightGround:{type:"f",value:0},fCameraHeight2Ground:{type:"f",value:0}};this._lightForAni=vec3.create();this._lightForAniGround=vec3.create();this._processApart=false;this._initialized=false;var i=this;setTimeout(function(){i._init()},200);this.zIndex=2}gH.VS_SHADER_TEXT=["precision highp float;","attribute vec3 position;","uniform vec3 cameraPosition;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform vec3 v3LightPosition;","uniform vec3 v3LightPositionGround;","uniform vec3 v3InvWavelength;","uniform float fCameraHeight;","uniform float fCameraHeight2;","uniform float fCameraHeightGround;","uniform float fCameraHeight2Ground;","uniform float fOuterRadius;","uniform float fOuterRadius2;","uniform float fInnerRadius;","uniform float fInnerRadius2;","uniform float fKrESun;","uniform float fKmESun;","uniform float fKr4PI;","uniform float fKm4PI;","uniform float fScale;","uniform float fScaleDepth;","uniform float fScaleOverScaleDepth;","const int nSamples = 3;","const float fSamples = 3.0;","varying vec3 v3Direction;","varying vec3 c0;","varying vec3 c1;","float scale(float fCos) {","    float x = 1.0 - fCos;","    return fScaleDepth * exp(-0.00287 + x*(0.459 + x*(3.83 + x*(-6.80 + x*5.25))));","}","void main(void) {","    vec3 v3Ray = position - cameraPosition;","    float fFar = length(v3Ray);","    v3Ray /= fFar;","    float B = 2.0 * dot(cameraPosition, v3Ray);","    float C = fCameraHeight2 - fOuterRadius2;","    float fDet = max(0.0, B * B - 4.0 * C);","    float fNear = 0.5 * (-B - sqrt(fDet));","    vec3 v3Start = cameraPosition + v3Ray * fNear;","    fFar -= fNear;","    float fStartAngle = dot(v3Ray, v3Start) / fOuterRadius;","    float fStartDepth = exp(-1.0 / fScaleDepth);","    float fStartOffset = fStartDepth * scale(fStartAngle);","    float fSampleLength = fFar / fSamples;","    float fScaledLength = fSampleLength * fScale;","    vec3 v3SampleRay = v3Ray * fSampleLength;","    vec3 v3SamplePoint = v3Start + v3SampleRay * 0.5;","    vec3 v3FrontColor = vec3(0.0, 0.0, 0.0);","    for(int i = 0; i < nSamples; i++) {","        float fHeight = length(v3SamplePoint);","        float fDepth = exp(fScaleOverScaleDepth * (fInnerRadius - fHeight));","        float fLightAngle = dot(v3LightPosition, v3SamplePoint) / fHeight;","        float fCameraAngle = dot(v3Ray, v3SamplePoint) / fHeight;","        float fScatter = (fStartOffset + fDepth * (scale(fLightAngle) - scale(fCameraAngle)));","        vec3 v3Attenuate = exp(-fScatter * (v3InvWavelength * fKr4PI + fKm4PI));","        v3FrontColor += v3Attenuate * (fDepth * fScaledLength);","        v3SamplePoint += v3SampleRay;","    }","    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","    c0 = v3FrontColor * (v3InvWavelength * fKrESun);","    c1 = v3FrontColor * fKmESun;","    v3Direction = cameraPosition - position;","}",].join("\\n");gH.FS_SHADER_TEXT=["precision highp float;","uniform float g;","uniform float g2;","uniform vec3 v3LightDirection;","varying vec3 v3Direction;","varying vec3 c0;","varying vec3 c1;","float getMiePhase(float fCos, float fCos2, float g, float g2) {","    return 1.5 * ((1.0 - g2) / (2.0 + g2)) * (1.0 + fCos2) / pow(1.0 + g2 - 2.0 * g * fCos, 1.5);","}","float getRayleighPhase(float fCos2) {","    return 0.75 + 0.75 * fCos2;","}","void main (void) {","    float fCos = dot(v3LightDirection, v3Direction) / length(v3Direction);","    float fCos2 = fCos * fCos;","    vec3 color = getRayleighPhase(fCos2) * c0 + getMiePhase(fCos, fCos2, g, g2) * c1;","    if (color.r == 0.0 && color.g == 0.0 && color.b == 0.0) {","        discard;","    }","    gl_FragColor = vec4(color, color.b);","}"].join("\\n");C.extend(gH.prototype,{_init:function(){var i=new el(515,{latSpan:50});var e=C.Platform.macintosh?128:64;i.setSegments(e,e/6);this._ringData=i.generateAllVertex();this._initShaders();this._getAllUniforms();this._getAttribLocation();this._initialized=true;this._earth.fire(new a6("onforcerefresh"))},_initShaders:function(){var e=gH.VS_SHADER_TEXT;var T=gH.FS_SHADER_TEXT;var hJ=this._gl;var hK=this._glProgram=hJ.createProgram();var hI=this._makeShader(e,hJ.VERTEX_SHADER);var i=this._makeShader(T,hJ.FRAGMENT_SHADER);hJ.attachShader(hK,hI);hJ.attachShader(hK,i);hJ.bindAttribLocation(hK,0,"aVertexPosition");hJ.linkProgram(hK);hJ.useProgram(hK)},_makeShader:function(hI,e){var T=this._gl;var i=T.createShader(e);T.shaderSource(i,hI);T.compileShader(i);return i},_getAllUniforms:function(){var hI=this._glProgram;var T=this._gl;var i=this._uniformsCommon;for(var e in i){hH(T,hI,e)}i=this._uniforms;for(e in i){hH(T,hI,e)}i=this._atUniformsGround;for(e in i){hH(T,hI,e)}},_getAttribLocation:function(){var i=this._glProgram;var e=this._gl;i.vertexPositionAttribute=e.getAttribLocation(i,"position")},onStatusChange:function(T){if(!this._initialized){return}var hI=this._earth.getZoom();if(hI>=6){return}this._preZoom=this._zoom||hI;this._zoom=hI;this._camera=T;var i=this._earth.zoomForNight;if(this._sunLightAni){if(this._preZoom<hI&&this._aniDir==="in"||this._preZoom>hI&&this._aniDir==="out"||this._preZoom===hI){return}}if(this._preZoom<=i&&hI>i){this._sunLightAni&&this._sunLightAni.stop();this._startZoomInLightAnimation(T);return}if(hI<=i&&this._preZoom>i){this._sunLightAni&&this._sunLightAni.stop();this._startZoomOutLightAnimation(T);return}var hK=vec3.create();var hJ=T.getPositionForAt();var e=vec3.create();if(hI<=i){vec3.normalize(hK,T.getLightPositionForAt());vec3.normalize(e,T.getLightPosition())}else{vec3.normalize(hK,hJ);vec3.normalize(e,T.getPosition())}this._setAtUniforms(hK,e)},_startZoomInLightAnimation:function(T){this._aniDir="in";var i=this._lightForAni;var e=this._lightForAniGround;if(i[0]===0&&i[1]===0&&i[2]===0){vec3.normalize(i,T.getLightPositionForAt());vec3.normalize(e,T.getLightPosition())}var hI=this;this._sunLightAni=new o({duration:800,transition:ci.easeOutCubic,render:function(hL,hK){if(hL===0){return}var hO=hI._camera.getPositionForAt();var hM=vec3.normalize(vec3.create(),hO);var hN=hI._camera.getPosition();var hJ=vec3.normalize(vec3.create(),hN);i[0]=0.9*i[0]+0.1*hM[0];i[1]=0.9*i[1]+0.1*hM[1];i[2]=0.9*i[2]+0.1*hM[2];e[0]=0.9*e[0]+0.1*hJ[0];e[1]=0.9*e[1]+0.1*hJ[1];e[2]=0.9*e[2]+0.1*hJ[2];hI._setAtUniforms(i,e);hI._earth.fire(new a6("onrefresh"))},finish:function(){hI._earth.fire(new a6("onanimation_end"));hI._sunLightAni=null},onStop:function(hJ){hI._earth.fire(new a6("onanimation_end"));hI._sunLightAni=null}})},_startZoomOutLightAnimation:function(hL){this._aniDir="out";var e=hL.getPositionForAt();var i=vec3.normalize(vec3.create(),e);var hM=hL.getPosition();var hP=vec3.normalize(vec3.create(),hM);var hJ=this._lightForAni;var T=this._lightForAniGround;if(hJ[0]===0&&hJ[1]===0&&hJ[2]===0||this._sunLightAni===null){vec3.copy(hJ,i);vec3.copy(T,hP)}var hS=vec3.copy(vec3.create(),hJ);var hK=vec3.create();vec3.normalize(hK,hL.getLightPositionForAt());var hR=[hK[0]-hS[0],hK[1]-hS[1],hK[2]-hS[2]];var hI=vec3.copy(vec3.create(),T);var hO=vec3.create();vec3.normalize(hO,hL.getLightPosition());var hQ=[hO[0]-hI[0],hO[1]-hI[1],hO[2]-hI[2]];var hN=this;this._sunLightAni=new o({duration:800,transition:ci.easeOutCubic,render:function(hW,hV){if(hW===0){return}var hU=hN._lightForAni;var hT=hN._lightForAniGround;hU[0]=hS[0]+hW*hR[0];hU[1]=hS[1]+hW*hR[1];hU[2]=hS[2]+hW*hR[2];hT[0]=hI[0]+hW*hQ[0];hT[1]=hI[1]+hW*hQ[1];hT[2]=hI[2]+hW*hQ[2];hN._setAtUniforms(hU,hT);hN._earth.fire(new a6("onrefresh"))},finish:function(){hN._earth.fire(new a6("onanimation_end"));hN._sunLightAni=null},onStop:function(hT){hN._earth.fire(new a6("onanimation_end"));hN._sunLightAni=null}})},_setAtUniforms:function(T,i){var hJ=this._camera;var hM=this._uniformsCommon;hM.projectionMatrix.value=hJ.getProjectionMatrix();hM.modelViewMatrix.value=hJ.getModelViewMatrixForAt();var hL=hJ.getPositionForAt();var hK=hJ.getPosition();hM.cameraPosition.value=hL;var e=vec3.len(hL);hM.fCameraHeight.value=e;hM.fCameraHeight2.value=e*e;hM.v3LightPosition.value=T;hM.v3LightDirection.value=T;var hI=this._atUniformsGround;hI.cameraPositionGround.value=hK;e=vec3.len(hK);hI.fCameraHeightGround.value=e;hI.fCameraHeight2Ground.value=e*e;hI.v3LightPositionGround.value=i},renderFrame:function(){if(!this._initialized||this._earth.getZoom()>=6){return}var e=this._earth.getBounds();if(e.holeAtTopLeft===false){return}var T=this._gl;T.useProgram(this._glProgram);var i=this._webglState;i.enableCap("depthTest");i.depthMask(false);i.enableCap("cullFace");i.frontFace(T.CCW);i.cullFace(T.FRONT);i.blendFunc(T.SRC_ALPHA,T.ONE);i.initAttribute();i.enableAttribute(this._glProgram.vertexPositionAttribute);i.disableUnusedAttributes();this._setUniforms();this._renderSphere()},_setUniforms:function(){var hI=this._glProgram;var T=this._gl;var i=this._uniformsCommon;for(var e in i){eT(T,hI,e,i[e].value,i[e].type)}i=this._uniforms;for(var e in i){eT(T,hI,e,i[e].value,i[e].type)}},_renderSphere:function(){var hI=this._ringData;var i=hI.vertex;var e=hI.indice;var T=this._gl;this._float32Array.set(i);T.bindBuffer(T.ARRAY_BUFFER,this._trianglesVerticeBuffer);T.bufferData(T.ARRAY_BUFFER,this._float32Array,T.STREAM_DRAW);if(this._triangleVerticesIndexBuffer.vertexCount!=e.length){T.bindBuffer(T.ELEMENT_ARRAY_BUFFER,this._triangleVerticesIndexBuffer);this._uint16Array.set(e);T.bufferData(T.ELEMENT_ARRAY_BUFFER,this._uint16Array,T.STREAM_DRAW);this._triangleVerticesIndexBuffer.vertexCount=e.length}var hJ=this._glProgram;T.bindBuffer(T.ARRAY_BUFFER,this._trianglesVerticeBuffer);T.bindBuffer(T.ELEMENT_ARRAY_BUFFER,this._triangleVerticesIndexBuffer);T.vertexAttribPointer(hJ.vertexPositionAttribute,3,T.FLOAT,false,0,0);T.drawElements(T.TRIANGLES,this._triangleVerticesIndexBuffer.vertexCount,T.UNSIGNED_SHORT,0)}});function bo(T,e){this._earth=T;this._layer=e;this._canvas=T._canvas;var i=this._ratio=this._earth.scene._ratio;this._width=this._canvas.width/i;this._height=this._canvas.height/i;var hI=this._gl=T.scene._gl;this._webglState=b6.WebGLState.get(hI,T._guid);this._textTextureManager=new b6.TextTextureManager(hI,{width:e._textTextureImgWidth,height:e._textTextureImgHeight,name:"earth-text"});this._currentRenderTexture=null;this._glProgram=null;this._sphere=T._sphere;this._pMatrix=mat4.create();this._mvMatrix=mat4.create();this._mvMatrixCamera=mat4.create();this._trianglesVerticeBuffer=hI.createBuffer();this._iconTextureManager=new b6.TextTextureManager(hI,{width:1024,height:1024,name:"earth-icon"});this._iconTextureAtlas=this._iconTextureManager.getEmptyTexture();this._iconTextureAtlasOffset={};this._iconTextureAtlasCoords={};this.zIndex=15;this._textureInfoPool=new fC(350);this._enabled=true;this._collisionRet=[];this._loadedCount=0;this._refreshTimer=null;this._float32Array=new Float32Array(2000);this.curSpotAdded=false;this._init()}bo.VS_SHADER_TEXT=["precision highp float;","attribute vec3 aVertexPosition;","attribute vec2 aVertexTextureCoord;","varying vec2 vTextureCoord;","uniform mat4 uMVMatrix;","uniform mat4 uPMatrix;","void main(void) {","    gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);","    vTextureCoord = aVertexTextureCoord;","}"].join("\\n");bo.FS_SHADER_TEXT=["precision highp float;","uniform sampler2D uSampler;","varying vec2 vTextureCoord;","void main(void) {","    gl_FragColor = texture2D(uSampler, vTextureCoord);","}"].join("\\n");C.extend(bo.prototype,{_init:function(){this._initShaders();this._getAllUniforms();this._getAttribLocation();mat4.translate(this._mvMatrix,this._mvMatrix,[-this._width/2,-this._height/2,0]);mat4.ortho(this._pMatrix,-this._width/2,this._width/2,-this._height/2,this._height/2,800,-800);var e=this;this._currentRenderTexture=e._textTextureManager.getEmptyTexture();var i=this._earth.getMap();var e=this;i.on("maptypechange",function(T){if(T.mapType===BMAP_EARTH_MAP){e._isMapTypeChange=true;e._arrCurViewTileModels=null;e._collisionRet=[];e._earth.fire(new a6("onrefresh"))}});i.on("streetlayer_show",function(T){if(this.mapType===BMAP_EARTH_MAP){if(!e._camera){return}e._isStreetLayerChange=true;e._arrCurViewTileModels=null;e._collisionRet=[];e.onStatusChange(e._camera);e._earth.fire(new a6("onrefresh"))}});i.on("mousemove",function(){if(this.mapType!==BMAP_EARTH_MAP){return}if(e.curSpotAdded){return}if(this.currentOperation!==dO.idle){return}e._refreshSpotData();this.temp.isPermitSpotOver=true;e.curSpotAdded=true})},_refreshSpotData:function(){this._spotData=[];var T=this._collisionRet||[];for(var hK=0;hK<T.length;hK++){if(!T[hK].icTxtInfo||!T[hK].icTxtInfo.fixedLabel){continue}var hI=T[hK].icTxtInfo.fixedLabel;for(var hJ=0;hJ<hI.length;hJ++){if(!this.isClickableLabel(hI[hJ])){continue}this._spotData.push(this._getSpotDataFromLabel(hI[hJ]))}}var hM=new a6("onspotsdataready");hM.spots=this._spotData;var hL=this._earth.getMap();hL._spotDataOnCanvas=this._spotData;hL.dispatchEvent(hM)},isClickableLabel:function(e){if(e.isDel||(!e.guid&&!e.name)){return false}return true},_getSpotDataFromLabel:function(i){var hJ=this._earth.getMap();var T=null;if(i.iconPos){T=new hj(i.pt.lng,i.pt.lat)}var e=i.name?i.name.replace("\\\\","<br>"):"";if(i.iconPos&&i.iconPos.iconType.indexOf("ditie")>-1&&hJ.getZoom()>14){e=""}var hI={n:e,px:i.scrPt,bd:i.bds,pt:T,userdata:{iconPoint:T,uid:i.guid,name:e,mapPoi:true,type:i.iconPos?i.iconPos.iconType:"",tilePosStr:i.tilePosStr},tag:"MAP_SPOT_INFO"};return hI},_initShaders:function(){var i=bo.VS_SHADER_TEXT;var hJ=bo.FS_SHADER_TEXT;var hI=this._gl;var hK=this._glProgram=hI.createProgram();var T=this._makeShader(i,hI.VERTEX_SHADER);var e=this._makeShader(hJ,hI.FRAGMENT_SHADER);hI.attachShader(hK,T);hI.attachShader(hK,e);hI.linkProgram(hK);hI.useProgram(hK)},_makeShader:function(hI,e){var T=this._gl;var i=T.createShader(e);T.shaderSource(i,hI);T.compileShader(i);return i},_getAllUniforms:function(){var i=this._glProgram;var e=this._gl;i.pMatrixUniform=e.getUniformLocation(i,"uPMatrix");i.mvMatrixUniform=e.getUniformLocation(i,"uMVMatrix");i.sampler=e.getUniformLocation(i,"uSampler")},_setUniforms:function(){var i=this._glProgram;var e=this._gl;e.uniformMatrix4fv(i.pMatrixUniform,false,this._pMatrix);e.uniformMatrix4fv(i.mvMatrixUniform,false,this._mvMatrix)},_setPerpectiveUniforms:function(){var i=this._glProgram;var e=this._gl;e.uniformMatrix4fv(i.pMatrixUniform,false,this._pMatrix2);if(this._earth.getZoom()>15){e.uniformMatrix4fv(i.mvMatrixUniform,false,this._mvMatrixCamera)}else{e.uniformMatrix4fv(i.mvMatrixUniform,false,this._mvMatrix2)}},_getAttribLocation:function(){var i=this._glProgram;var e=this._gl;i.vertexPositionAttribute=e.getAttribLocation(i,"aVertexPosition");i.vertexTexCoordAttribute=e.getAttribLocation(i,"aVertexTextureCoord")},resize:function(){this._width=this._canvas.width/this._ratio;this._height=this._canvas.height/this._ratio;mat4.identity(this._mvMatrix);mat4.translate(this._mvMatrix,this._mvMatrix,[-this._width/2,-this._height/2,0]);mat4.ortho(this._pMatrix,-this._width/2,this._width/2,-this._height/2,this._height/2,800,-800);this._layer._lineLabelMagRatio=700*0.5/this._height},enable:function(){this._enabled=true},disable:function(){this._enabled=false},setTextureInfoRes:function(e,T){this._loadedCount--;this.curSpotAdded=false;this._textureInfoPool.setData(e,T);if(this._loadedCount===0){this._updateLabelData();this._earth.fire(new a6("onrefresh"));if(this._refreshTimer){clearTimeout(this._refreshTimer)}}else{if(this._refreshTimer===null){var i=this;this._refreshTimer=setTimeout(function(){i._updateLabelData();i._earth.fire(new a6("onrefresh"));i._refreshTimer=null},200)}}},addTextTexture:function(e,i){if(this._arrCurViewTileModels&&this._arrCurViewTileModels.textureInfo){return this._arrCurViewTileModels.textureInfo.addTexture(e,i)}return this._currentRenderTexture.addTexture(e,i)},onStatusChange:function(T){if(!this._enabled){return}this._camera=T;this._pMatrix2=T.getProjectionMatrix();this._mvMatrix2=T.getModelViewMatrix();this._mvMatrixCamera=T._mvMatrixForCamera;var i=this._earth.getZoom();this._isZoomOut=!!(i-this._lastZoom<0);this._isZoomLarge=!!(Math.abs(i-this._lastZoom)>2);this._lastZoom=i;if(i>=this._earth.zoomForNight+1){var hI=this;var e=hI._layer;if(hI.loadTimer){clearTimeout(hI.loadTimer)}hI.loadTimer=setTimeout(function(){if(hI._earth.getZoom()<hI._earth.zoomForNight+1){return}hI._arrCurViewTileModels=hI._sphere.getCurViewNormalModels(hI._layer._tileType);if(hI._textureInfoPool.getDataCount()>180||hI._currentRenderTexture.getUsage()>0.8){hI._arrCurViewTileModels.textureInfo=hI._textTextureManager.getEmptyTexture();hI._textureInfoPool.clear()}hI._loadCurViewData();hI.loadTimer=null},240)}else{this._arrCurViewTileModels=null;this._collisionRet=[]}this._updateScreenPixel();if(!this._locked&&this._isZoomOut){if(this._collisionRet&&this._collisionRet._arrLabels){this._layer.collisionTestByZoomingOut(this._collisionRet._arrLabels,this._height)}this._isZoomOut=false}},_updateScreenPixel:function(){if(!this._collisionRet){return}var hK=false;var hO=this._earth;if(hO.getZoom()<=6){hK=true}var hJ=hO.getCenter();for(var hI=0;hI<this._collisionRet.length;hI++){var e=this._collisionRet[hI];var hL=e.icTxtInfo.fixedLabel;for(var T=0;T<hL.length;T++){var hM=hL[T];if(hO.getZoom()>15){var hN=hO.scene.fromLatLngToXYZ(hM.latLng);hN=cD(hN,hO.rotationInfo);hM.scrPt=hO.scene.fromXYZToPixel(hN[0],hN[1],hN[2],{matrixInfo:{modelViewMatrix:hO.scene._camera._mvMatrixForCamera}})}else{hM.scrPt=hO.fromLatLngToPixel(hM.latLng,{isCalcOnBack:hK})}}}},getStatusChangeEvent:function(){return this._statusChangeEvt},_loadCurViewData:function(){var hO=this;var hM=hO._layer;var hP=this._arrCurViewTileModels;if(this._earth._notLoadHigh||!hP){return}for(var hL=0,hK=hP.length;hL<hK;hL++){var hI=hP[hL];var hJ=hI.col;var hR=hI.row;var hN=hI.imgZoom;var T=hI.useZoom;var hQ=hI.key;if(this._textureInfoPool.getData(hQ)){continue}this._loadedCount++;this._textureInfoPool.setData(hQ,{});hM.loadTileData(hJ,hR,hN,T,hQ)}var e=this._earth.getMap();e.temp.isPermitSpotOver=false;this.curSpotAdded=false;if(this._loadedCount===0){this._updateLabelData();this._earth.fire(new a6("onrefresh"));return}this._waitTimer&&clearTimeout(this._waitTimer);this._waitTimer=setTimeout(function(){if(hO._loadedCount>0){hO._updateLabelData();hO._earth.fire(new a6("onrefresh"))}hO._waitTimer=setTimeout(function(){if(hO._loadedCount>0){hO._updateLabelData();hO._earth.fire(new a6("onrefresh"))}hO._waitTimer=null},3000)},400)},renderFrame:function(){var T=this._earth._map;if(!T._displayOptions.poi){return}var hO=this._arrCurViewTileModels;if(!this._enabled||!hO||hO.length===0){return}var e=this._earth.getZoom();if(e<this._earth.zoomForNight+1){return}var hI=hO[0].imgZoom;var hP=this._earth;var hJ=hP.getImageZoom();if(!this._locked&&hI-hJ>=3){this._collisionRet=[];return}var hL=this._gl;var hK=this._glProgram;var i=this._webglState;var hM=this._layer;hL.useProgram(hK);i.disableCap("depthTest");i.enableCap("blend");i.enableCap("cullFace");i.cullFace(hL.BACK);i.initAttribute();i.enableAttribute(hK.vertexPositionAttribute);i.enableAttribute(hK.vertexTexCoordAttribute);i.disableUnusedAttributes();var hN=this._renderLineLabelFrame(hL,hK,this._collisionRet,false);this._renderFixedLabelFrame(hL,hK,this._collisionRet,false,hN);var hP=this._earth;if(!hP._firstLabelLoadedTime&&this._collisionRet.length>0){var hQ=new a6("onearthlabelloaded");hQ.initTime=hP._initFinishTime-hP._initStartTime;hQ.loadTime=hP._firstLabelLoadedTime=Date.now()-hP._initStartTime;hP.fire(hQ)}},_updateLabelData:function(){this._collisionRet=this._layer.collisionTest(this._arrCurViewTileModels,this._textureInfoPool,this._height);if(this._arrCurViewTileModels&&this._arrCurViewTileModels.textureInfo){if(this._currentRenderTexture){this._textTextureManager.free(this._currentRenderTexture)}this._currentRenderTexture=this._arrCurViewTileModels.textureInfo;this._arrCurViewTileModels.textureInfo=null}},_renderFixedLabelFrame:function(hS,hM,e,T,hV){var hU=this._iconTextureAtlas.getTexture();var hT=this._layer;var hW=this._float32Array;var hR=[];var hL=[];for(var hQ=0,hK=e.length;hQ<hK;hQ++){var hO=e[hQ];if(!hO){continue}var hJ=hT.mergeFixedLabelInfo(hO,this._width,this._height,this._isAnimationEnd,T);var hI=hJ.iconVertex;var hP=hJ.textVertex;if(hU&&hI.length>0){hR=hR.concat(hI)}if(hP.length>0){hL=hL.concat(hP)}}if(hL.length===0&&hR.length===0){return}this._setUniforms();if(this._currentRenderTexture&&hL.length>0){hS.bindBuffer(hS.ARRAY_BUFFER,this._trianglesVerticeBuffer);if(hL.length<hW.length){hW.set(hL,0)}else{hW=new Float32Array(hL)}hS.bufferData(hS.ARRAY_BUFFER,hW,hS.STREAM_DRAW);hS.vertexAttribPointer(hM.vertexPositionAttribute,3,hS.FLOAT,false,20,0);hS.vertexAttribPointer(hM.vertexTexCoordAttribute,2,hS.FLOAT,false,20,12);if(!hV){var hN=this._currentRenderTexture.getTexture();this._webglState.activeTexture(hS.TEXTURE0);hS.bindTexture(hS.TEXTURE_2D,hN);hS.uniform1i(hM.sampler,0)}hS.drawArrays(hS.TRIANGLES,0,hL.length/5)}if(hR.length===0){return}this._webglState.activeTexture(hS.TEXTURE0);hS.bindTexture(hS.TEXTURE_2D,hU);hS.uniform1i(hM.sampler,0);hS.bindBuffer(hS.ARRAY_BUFFER,this._trianglesVerticeBuffer);if(hR.length<hW.length){hW.set(hR,0)}else{hW=new Float32Array(hR)}hS.bufferData(hS.ARRAY_BUFFER,hW,hS.STREAM_DRAW);hS.vertexAttribPointer(hM.vertexPositionAttribute,3,hS.FLOAT,false,20,0);hS.vertexAttribPointer(hM.vertexTexCoordAttribute,2,hS.FLOAT,false,20,12);hS.drawArrays(hS.TRIANGLES,0,hR.length/5)},_renderLineLabelFrame:function(hP,hK,e,T){if(!this._currentRenderTexture||e.length===0){return false}var hQ=this._layer;var hR=this._float32Array;var hI=[];for(var hO=0,hJ=e.length;hO<hJ;hO++){var hM=e[hO];var hN=hQ.mergeLineLabelInfo(hM,T);if(hN.length>0){hI=hI.concat(hN)}}if(hI.length===0){return false}this._setPerpectiveUniforms();hP.bindBuffer(hP.ARRAY_BUFFER,this._trianglesVerticeBuffer);if(hI.length<hR.length){hR.set(hI,0)}else{hR=new Float32Array(hI)}hP.bufferData(hP.ARRAY_BUFFER,hR,hP.STATIC_DRAW);hP.vertexAttribPointer(hK.vertexPositionAttribute,3,hP.FLOAT,false,20,0);hP.vertexAttribPointer(hK.vertexTexCoordAttribute,2,hP.FLOAT,false,20,12);var hL=this._currentRenderTexture.getTexture();hP.bindTexture(hP.TEXTURE_2D,hL);hP.uniform1i(hK.sampler,0);hP.drawArrays(hP.TRIANGLES,0,hI.length/5);return true}});function cf(e){this._earth=e;this._radius=6*e.radius;this._canvas=e._canvas;var i=this._gl=e.scene._gl;this._webglState=b6.WebGLState.get(i,e._guid);this._glProgram=null;this._cols=2;this._rows=1;this._mvMatrix=mat4.create();this._mMatrixMilky=mat4.create();this._mMatrixSun=mat4.create();this._pMatrix=mat4.create();this._sunTexture={};this._float32Array=new Float32Array(243);this._uint16Array=new Uint16Array(384);this.zIndex=1;this._textureTransform={rotateX:300.611,rotateY:328.127};this.init()}cf.VS_SHADER_TEXT=["precision mediump float;","attribute vec3 aVertexPosition;","attribute vec2 aVertexTextureCoord;","varying vec2 vTextureCoord;","uniform mat4 uMVMatrix;","uniform mat4 uMMatrix;","uniform mat4 uPMatrix;","void main(void) {","    gl_Position = uPMatrix * uMVMatrix * uMMatrix * vec4(aVertexPosition, 1.0);","    vTextureCoord = aVertexTextureCoord;","}"].join("\\n");cf.FS_SHADER_TEXT=["precision mediump float;","varying vec2 vTextureCoord;","uniform sampler2D uSampler;","uniform float uAlpha;","uniform bool uRenderSun;","void main(void) {","    if (uRenderSun == true) {","        vec4 diffuse = texture2D(uSampler, vTextureCoord);","        float grayValue = (diffuse.r + diffuse.g + diffuse.b) / 3.0;","        float sunAlpha = 1.0;","        if (grayValue < 0.15) {","            sunAlpha = 0.0;","        } else {","            sunAlpha = grayValue + 0.14;","        }","        gl_FragColor = vec4(diffuse.rgb, sunAlpha) * uAlpha;","        return;","    }","    gl_FragColor = texture2D(uSampler, vTextureCoord) * uAlpha;","}"].join("\\n");C.extend(cf.prototype,{init:function(){this._genImgColsRowsInfo();this._initShaders();this._getUniforms();this._getAttribLocation();var e=new Z(this._radius,this._cols,this._rows);var i=e.initSphereFacesIndices();this._sphere={sphere:e,facesVertexIndice:i,facesVertex:e._facesVertex};this._vertexForSun=[-400,-400,2800,400,-400,2800,400,400,2800,-400,400,2800];this._indiceForSun=[0,3,2,0,2,1];this._coordsForSun=[0,0,0,1,1,1,1,0];var T=this;this._earth.on("preload",function(){T._prepareTexture()});this._earth.on("idle",function(){T._prepareTexture()});this._earth.on("onsunlighttime_change",function(){T._sunLightPos=null});this._earth.on("onsunlighttime_clear",function(){T._sunLightPos=null});this._initialized=true},_genImgColsRowsInfo:function(){this._imgColsRows=[];for(var e=2;e<=5;e++){this._imgColsRows[e]={cols:Math.pow(2,e-1),rows:Math.pow(2,e-1)/2}}this._imgColsRows[1]={cols:1,rows:1}},_initShaders:function(){var e=cf.VS_SHADER_TEXT;var T=cf.FS_SHADER_TEXT;var hJ=this._gl;var hK=this._glProgram=hJ.createProgram();var hI=this._makeShader(e,hJ.VERTEX_SHADER);var i=this._makeShader(T,hJ.FRAGMENT_SHADER);hJ.attachShader(hK,hI);hJ.attachShader(hK,i);hJ.bindAttribLocation(hK,0,"aVertexPosition");hJ.linkProgram(hK);hJ.useProgram(hK)},_makeShader:function(hI,e){var T=this._gl;var i=T.createShader(e);T.shaderSource(i,hI);T.compileShader(i);return i},_getUniforms:function(){var i=this._glProgram;var e=this._gl;i.pMatrixUniform=e.getUniformLocation(i,"uPMatrix");i.mvMatrixUniform=e.getUniformLocation(i,"uMVMatrix");i.mMatrixUniform=e.getUniformLocation(i,"uMMatrix");i.samplerUniform=e.getUniformLocation(i,"uSampler");i.alpha=e.getUniformLocation(i,"uAlpha");i.renderSun=e.getUniformLocation(i,"uRenderSun")},_getAttribLocation:function(){var e=this._gl;var i=this._glProgram;i.vertexPositionAttribute=e.getAttribLocation(i,"aVertexPosition");i.vertexTexCoordAttribute=e.getAttribLocation(i,"aVertexTextureCoord")},_setUniforms:function(){var i=this._glProgram;var e=this._gl;e.uniformMatrix4fv(i.pMatrixUniform,false,this._pMatrix);e.uniformMatrix4fv(i.mvMatrixUniform,false,this._mvMatrix)},onStatusChange:function(i){if(this._earth.getZoom()>=2){return}if(!this._initialized){return}this._camera=i;this._pMatrix=i.getProjectionMatrix();this._mvMatrix=i.getModelViewMatrix();this._calculateCelestialSpherePos();var e=this._getColAndRow();this._faceRange=e[0];this._imgRange=e[1]},_calculateCelestialSpherePos:function(){var hJ=this._camera;var hL=this._textureTransform.rotateX;var hK=this._textureTransform.rotateY;var hO=hJ.getSunZenith();var hP=hJ.getPosition();var e=hJ._date;var hI=e.getFullYear();var i=Math.floor(hI%100*0.2422+20.646)-Math.floor(hI%100/4);var hN=new Date(hI,2,i);var hM=e-hN;var T=Math.floor(hM/1000/60/60/24)/365.25*360;mat4.identity(this._mMatrixMilky);mat4.translate(this._mMatrixMilky,this._mMatrixMilky,hP);mat4.rotate(this._mMatrixMilky,this._mMatrixMilky,dE(195+hO.lng-T),[0,1,0]);mat4.rotate(this._mMatrixMilky,this._mMatrixMilky,dE(hL),[1,0,0]);mat4.rotate(this._mMatrixMilky,this._mMatrixMilky,dE(hK),[0,1,0])},renderFrame:function(){if(this._earth.getZoom()>=2){return}if(!this._initialized){return}var hY=this._gl;var hO=this._glProgram;hY.useProgram(hO);var hK=this._webglState;hK.initAttribute();hK.enableAttribute(hO.vertexPositionAttribute);hK.enableAttribute(hO.vertexTexCoordAttribute);hK.disableUnusedAttributes();var hV=this._faceRange;if(!this._faceRange){return}var hQ=this._rows;var hS=this._cols;var hW=hV[0];var hU=hV[1];var hZ=hV[2];var hX=hV[3];var hT=this._texturesInfo;if(!hT||!hT.done){return false}hK.enableCap("cullFace");hK.cullFace(hY.BACK);hK.disableCap("depthTest");hK.depthMask(true);this._justBindTexture(hT.texture);this._setUniforms();hY.uniform1f(hO.alpha,(1-(this._earth.getZoom()-1))*0.6);hY.uniform1i(hO.renderSun,false);hY.uniformMatrix4fv(hO.mMatrixUniform,false,this._mMatrixMilky);for(var hM=hZ;hM<=hX;hM++){var T=hW;var hJ=hU;if(typeof this._vertexFromRow==="number"&&hM>=this._vertexFromRow&&hM<=this._vertexToRow){T=0;hJ=this._cols-1}for(var hL=T;hL<=hJ;hL++){var hN=hL;while(hN<0){hN+=this._cols}hN=hN%this._cols;var h0=this._getVertex(hN,hM);var hR=this._sphere.facesVertexIndice;var e=this._getTextureCoord(hN,hM,1);this._setupBuffers(h0,hR,e);this._draw()}}if(!this._sunTexture.done){return}this._justBindTexture(this._sunTexture.texture);this._setupBuffers(this._vertexForSun,this._indiceForSun,this._coordsForSun);if(!this._sunLightPos){this._sunLightPos=vec3.normalize(vec3.create(),this._camera.getLightPosition());var hP=Math.sqrt(1-this._sunLightPos[1]*this._sunLightPos[1]);var h1=this._sunLightPos[2]/hP;h1=h1>1?1:h1;h1=h1<-1?-1:h1;var hI=Math.acos(h1);if(this._sunLightPos[0]<0){hI=dE(360)-hI}var h2=Math.asin(this._sunLightPos[1]);mat4.identity(this._mMatrixSun);mat4.rotate(this._mMatrixSun,this._mMatrixSun,hI,[0,1,0]);mat4.rotate(this._mMatrixSun,this._mMatrixSun,h2,[-1,0,0])}var i=this._earth;if(i._firstAni){hY.uniform1f(hO.alpha,1)}else{hY.uniform1f(hO.alpha,(1-(i.getZoom()-1)))}hY.uniform1i(hO.renderSun,true);hY.uniformMatrix4fv(hO.mMatrixUniform,false,this._mMatrixSun);this._draw()},_prepareTexture:function(){var i=this;if(!i._texturesInfo){i._texturesInfo={}}else{return}var e=i._texturesInfo;e.loaded=false;var T=eV.imgPath+"tiles/the-milkyway-2k.jpg?20150826";i._loadImage(T,function(hI){e.loaded=true;if(!e.done){i._setupTexture(e,hI);e.done=true}i._earth.fire(new a6("onrefresh"))});i._sunTexture.loaded=false;if(i._earth._showRealSunlight){i._loadImage(eV.imgPath+"sun.jpg?20150826",function(hI){i._sunTexture.loaded=true;if(!i._sunTexture.done){i._setupTexture(i._sunTexture,hI);i._sunTexture.done=true}i._earth.fire(new a6("onrefresh"))})}},_loadImage:function(i,T){var e=new Image();e.crossOrigin="anonymous";e._loaded=false;e.onload=function(){T(this);this._loaded=true};e.src=i},_setupTexture:function(i,e){if(!i){return}var hI=this._gl;this._webglState.activeTexture(hI.TEXTURE0);i.texture=hI.createTexture();var T=i.texture;hI.bindTexture(hI.TEXTURE_2D,T);hI.pixelStorei(hI.UNPACK_FLIP_Y_WEBGL,true);hI.texImage2D(hI.TEXTURE_2D,0,hI.RGBA,hI.RGBA,hI.UNSIGNED_BYTE,e);hI.texParameteri(hI.TEXTURE_2D,hI.TEXTURE_WRAP_S,hI.CLAMP_TO_EDGE);hI.texParameteri(hI.TEXTURE_2D,hI.TEXTURE_WRAP_T,hI.CLAMP_TO_EDGE);hI.texParameteri(hI.TEXTURE_2D,hI.TEXTURE_MAG_FILTER,hI.LINEAR);hI.texParameteri(hI.TEXTURE_2D,hI.TEXTURE_MIN_FILTER,hI.LINEAR)},_justBindTexture:function(e){if(!e){return}var i=this._gl;var T=this._glProgram;this._webglState.activeTexture(i.TEXTURE0);i.bindTexture(i.TEXTURE_2D,e);i.uniform1i(T.samplerUniform,0)},_setupBuffers:function(T,e,i){var hI=this._gl;if(!this._trianglesVerticeBuffer){this._trianglesVerticeBuffer=hI.createBuffer()}hI.bindBuffer(hI.ARRAY_BUFFER,this._trianglesVerticeBuffer);this._float32Array.set(T);hI.bufferData(hI.ARRAY_BUFFER,this._float32Array,hI.STREAM_DRAW);if(!this._triangleVerticesIndexBuffer){this._triangleVerticesIndexBuffer=hI.createBuffer();this._triangleVerticesIndexBuffer.vertexCount=e.length;hI.bindBuffer(hI.ELEMENT_ARRAY_BUFFER,this._triangleVerticesIndexBuffer);this._uint16Array.set(e);hI.bufferData(hI.ELEMENT_ARRAY_BUFFER,this._uint16Array,hI.STREAM_DRAW)}if(this._triangleVerticesIndexBuffer.vertexCount!==e.length){this._triangleVerticesIndexBuffer.vertexCount=e.length;hI.bindBuffer(hI.ELEMENT_ARRAY_BUFFER,this._triangleVerticesIndexBuffer);this._uint16Array.set(e);hI.bufferData(hI.ELEMENT_ARRAY_BUFFER,this._uint16Array,hI.STREAM_DRAW)}if(!this._vertexTexCoordBuffer){this._vertexTexCoordBuffer=hI.createBuffer()}hI.bindBuffer(hI.ARRAY_BUFFER,this._vertexTexCoordBuffer);this._float32Array.set(i);hI.bufferData(hI.ARRAY_BUFFER,this._float32Array,hI.STREAM_DRAW)},_getVertex:function(T,hI){var e=Z.H_SEGS/this._cols;var hJ=Z.H_SEGS/e;var i=T+hI*hJ;return this._sphere.facesVertex[i]},_getTextureCoord:function(e,i){return this._sphere.sphere.generateTextureCoord(1,e,i)},_draw:function(){var e=this._gl;var i=this._glProgram;e.bindBuffer(e.ARRAY_BUFFER,this._trianglesVerticeBuffer);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this._triangleVerticesIndexBuffer);e.vertexAttribPointer(i.vertexPositionAttribute,3,e.FLOAT,false,0,0);e.bindBuffer(e.ARRAY_BUFFER,this._vertexTexCoordBuffer);e.vertexAttribPointer(i.vertexTexCoordAttribute,2,e.FLOAT,false,0,0);e.drawElements(e.TRIANGLES,this._triangleVerticesIndexBuffer.vertexCount,e.UNSIGNED_SHORT,0)},_getColAndRow:function(){var hI;var hL;var hK;var T;var hM;var e;var hJ;var i;hI=0;hL=this._cols-1;hK=0;T=this._rows-1;hM=0;e=0;hJ=0;i=0;return[[hI,hL,hK,T],[hM,e,hJ,i]]}});function ax(e){this._earth=e;this._radius=6*e.radius;this._canvas=e._canvas;var i=this._gl=e.scene._gl;this._webglState=b6.WebGLState.get(i,e._guid);this._glProgram=null;this._cols=2;this._rows=1;this._mvMatrix=mat4.create();this._mMatrixMilky=mat4.create();this._mMatrixSun=mat4.create();this._pMatrix=mat4.create();this._sunTexture={};this._float32Array=new Float32Array(243);this._uint16Array=new Uint16Array(384);this.zIndex=1;this._textureTransform={rotateX:300.611,rotateY:328.127};this.init()}ax.VS_SHADER_TEXT=["precision mediump float;","attribute vec3 aVertexPosition;","attribute vec2 aVertexTextureCoord;","varying vec2 vTextureCoord;","uniform mat4 uMVMatrix;","uniform mat4 uMMatrix;","uniform mat4 uPMatrix;","void main(void) {","    gl_Position = uPMatrix * uMVMatrix * uMMatrix * vec4(aVertexPosition, 1.0);","    vTextureCoord = aVertexTextureCoord;","}"].join("\\n");ax.FS_SHADER_TEXT=["precision mediump float;","varying vec2 vTextureCoord;","uniform sampler2D uSampler;","uniform float uAlpha;","void main(void) {","    gl_FragColor = texture2D(uSampler, vTextureCoord) * uAlpha;","}"].join("\\n");C.extend(ax.prototype,{init:function(){this._genImgColsRowsInfo();this._initShaders();this._getUniforms();this._getAttribLocation();var e=new Z(this._radius,this._cols,this._rows);var i=e.initSphereFacesIndices();this._sphere={sphere:e,facesVertexIndice:i,facesVertex:e._facesVertex};var T=this;this._earth.on("preload",function(){T._prepareTexture()});this._earth.on("idle",function(){T._prepareTexture()});this._initialized=true},_genImgColsRowsInfo:function(){this._imgColsRows=[];for(var e=2;e<=5;e++){this._imgColsRows[e]={cols:Math.pow(2,e-1),rows:Math.pow(2,e-1)/2}}this._imgColsRows[1]={cols:1,rows:1}},_initShaders:function(){var e=ax.VS_SHADER_TEXT;var T=ax.FS_SHADER_TEXT;var hJ=this._gl;var hK=this._glProgram=hJ.createProgram();var hI=this._makeShader(e,hJ.VERTEX_SHADER);var i=this._makeShader(T,hJ.FRAGMENT_SHADER);hJ.attachShader(hK,hI);hJ.attachShader(hK,i);hJ.bindAttribLocation(hK,0,"aVertexPosition");hJ.linkProgram(hK);hJ.useProgram(hK)},_makeShader:function(hI,e){var T=this._gl;var i=T.createShader(e);T.shaderSource(i,hI);T.compileShader(i);return i},_getUniforms:function(){var i=this._glProgram;var e=this._gl;i.pMatrixUniform=e.getUniformLocation(i,"uPMatrix");i.mvMatrixUniform=e.getUniformLocation(i,"uMVMatrix");i.mMatrixUniform=e.getUniformLocation(i,"uMMatrix");i.samplerUniform=e.getUniformLocation(i,"uSampler");i.alpha=e.getUniformLocation(i,"uAlpha")},_getAttribLocation:function(){var e=this._gl;var i=this._glProgram;i.vertexPositionAttribute=e.getAttribLocation(i,"aVertexPosition");i.vertexTexCoordAttribute=e.getAttribLocation(i,"aVertexTextureCoord")},_setUniforms:function(){var i=this._glProgram;var e=this._gl;e.uniformMatrix4fv(i.pMatrixUniform,false,this._pMatrix);e.uniformMatrix4fv(i.mvMatrixUniform,false,this._mvMatrix)},onStatusChange:function(i){if(this._earth.getZoom()>=6){return}if(!this._initialized){return}this._camera=i;this._pMatrix=i.getProjectionMatrix();this._mvMatrix=i.getModelViewMatrix();this._calculateCelestialSpherePos();var e=this._getColAndRow();this._faceRange=e[0];this._imgRange=e[1]},_calculateCelestialSpherePos:function(){var hJ=this._camera;var hL=this._textureTransform.rotateX;var hK=this._textureTransform.rotateY;var hO=hJ.getSunZenith();var hP=hJ.getPosition();var e=hJ._date;var hI=e.getFullYear();var i=Math.floor(hI%100*0.2422+20.646)-Math.floor(hI%100/4);var hN=new Date(hI,2,i);var hM=e-hN;var T=Math.floor(hM/1000/60/60/24)/365.25*360;mat4.identity(this._mMatrixMilky);mat4.translate(this._mMatrixMilky,this._mMatrixMilky,hP);mat4.rotate(this._mMatrixMilky,this._mMatrixMilky,dE(195+hO.lng-T),[0,1,0]);mat4.rotate(this._mMatrixMilky,this._mMatrixMilky,dE(hL),[1,0,0]);mat4.rotate(this._mMatrixMilky,this._mMatrixMilky,dE(hK),[0,1,0])},renderFrame:function(){if(this._earth.getZoom()>=5){return}if(!this._initialized){return}var hU=this._gl;var hJ=this._glProgram;hU.useProgram(hJ);var i=this._webglState;i.initAttribute();i.enableAttribute(hJ.vertexPositionAttribute);i.enableAttribute(hJ.vertexTexCoordAttribute);i.disableUnusedAttributes();var hR=this._faceRange;if(!this._faceRange){return}var hK=this._rows;var hM=this._cols;var hS=hR[0];var hQ=hR[1];var hW=hR[2];var hT=hR[3];var hO=this._texturesInfo;if(!hO||!hO.done){return false}i.enableCap("cullFace");i.cullFace(hU.BACK);i.disableCap("depthTest");i.depthMask(true);this._justBindTexture(hO.texture);this._setUniforms();hU.uniform1f(hJ.alpha,1);hU.uniform1i(hJ.renderSun,false);hU.uniformMatrix4fv(hJ.mMatrixUniform,false,this._mMatrixMilky);for(var hI=hW;hI<=hT;hI++){var hP=hS;var hV=hQ;if(typeof this._vertexFromRow==="number"&&hI>=this._vertexFromRow&&hI<=this._vertexToRow){hP=0;hV=this._cols-1}for(var T=hP;T<=hV;T++){var hN=T;while(hN<0){hN+=this._cols}hN=hN%this._cols;var hX=this._getVertex(hN,hI);var hL=this._sphere.facesVertexIndice;var e=this._getTextureCoord(hN,hI,1);this._setupBuffers(hX,hL,e);this._draw()}}},_prepareTexture:function(){var T=this;if(!T._texturesInfo){T._texturesInfo={}}else{return}var i=T._texturesInfo;i.loaded=false;var e=T._earth._map.config.earthBackground;T._loadImage(e,function(hI){i.loaded=true;if(!i.done){T._setupTexture(i,hI);i.done=true}T._earth.fire(new a6("onrefresh"))})},_loadImage:function(i,T){var e=new Image();e.crossOrigin="anonymous";e._loaded=false;e.onload=function(){T(this);this._loaded=true};e.src=i},_setupTexture:function(i,e){if(!i){return}var hI=this._gl;this._webglState.activeTexture(hI.TEXTURE0);i.texture=hI.createTexture();var T=i.texture;hI.bindTexture(hI.TEXTURE_2D,T);hI.pixelStorei(hI.UNPACK_FLIP_Y_WEBGL,true);hI.texImage2D(hI.TEXTURE_2D,0,hI.RGBA,hI.RGBA,hI.UNSIGNED_BYTE,e);hI.texParameteri(hI.TEXTURE_2D,hI.TEXTURE_WRAP_S,hI.CLAMP_TO_EDGE);hI.texParameteri(hI.TEXTURE_2D,hI.TEXTURE_WRAP_T,hI.CLAMP_TO_EDGE);hI.texParameteri(hI.TEXTURE_2D,hI.TEXTURE_MAG_FILTER,hI.LINEAR);hI.texParameteri(hI.TEXTURE_2D,hI.TEXTURE_MIN_FILTER,hI.LINEAR)},_justBindTexture:function(e){if(!e){return}var i=this._gl;var T=this._glProgram;this._webglState.activeTexture(i.TEXTURE0);i.bindTexture(i.TEXTURE_2D,e);i.uniform1i(T.samplerUniform,0)},_setupBuffers:function(T,e,i){var hI=this._gl;if(!this._trianglesVerticeBuffer){this._trianglesVerticeBuffer=hI.createBuffer()}hI.bindBuffer(hI.ARRAY_BUFFER,this._trianglesVerticeBuffer);this._float32Array.set(T);hI.bufferData(hI.ARRAY_BUFFER,this._float32Array,hI.STREAM_DRAW);if(!this._triangleVerticesIndexBuffer){this._triangleVerticesIndexBuffer=hI.createBuffer();this._triangleVerticesIndexBuffer.vertexCount=e.length;hI.bindBuffer(hI.ELEMENT_ARRAY_BUFFER,this._triangleVerticesIndexBuffer);this._uint16Array.set(e);hI.bufferData(hI.ELEMENT_ARRAY_BUFFER,this._uint16Array,hI.STREAM_DRAW)}if(this._triangleVerticesIndexBuffer.vertexCount!==e.length){this._triangleVerticesIndexBuffer.vertexCount=e.length;hI.bindBuffer(hI.ELEMENT_ARRAY_BUFFER,this._triangleVerticesIndexBuffer);this._uint16Array.set(e);hI.bufferData(hI.ELEMENT_ARRAY_BUFFER,this._uint16Array,hI.STREAM_DRAW)}if(!this._vertexTexCoordBuffer){this._vertexTexCoordBuffer=hI.createBuffer()}hI.bindBuffer(hI.ARRAY_BUFFER,this._vertexTexCoordBuffer);this._float32Array.set(i);hI.bufferData(hI.ARRAY_BUFFER,this._float32Array,hI.STREAM_DRAW)},_getVertex:function(T,hI){var e=Z.H_SEGS/this._cols;var hJ=Z.H_SEGS/e;var i=T+hI*hJ;return this._sphere.facesVertex[i]},_getTextureCoord:function(e,i){return this._sphere.sphere.generateTextureCoord(1,e,i)},_draw:function(){var e=this._gl;var i=this._glProgram;e.bindBuffer(e.ARRAY_BUFFER,this._trianglesVerticeBuffer);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this._triangleVerticesIndexBuffer);e.vertexAttribPointer(i.vertexPositionAttribute,3,e.FLOAT,false,0,0);e.bindBuffer(e.ARRAY_BUFFER,this._vertexTexCoordBuffer);e.vertexAttribPointer(i.vertexTexCoordAttribute,2,e.FLOAT,false,0,0);e.drawElements(e.TRIANGLES,this._triangleVerticesIndexBuffer.vertexCount,e.UNSIGNED_SHORT,0)},_getColAndRow:function(){var hI;var hL;var hK;var T;var hM;var e;var hJ;var i;hI=0;hL=this._cols-1;hK=0;T=this._rows-1;hM=0;e=0;hJ=0;i=0;return[[hI,hL,hK,T],[hM,e,hJ,i]]}});function dn(i){this._earth=i;this._canvas=i._canvas;var e=this._ratio=this._earth.scene._ratio;this._width=this._canvas.width/e;this._height=this._canvas.height/e;var T=this._gl=i.scene._gl;this._webglState=b6.WebGLState.get(T,i._guid);this._glProgram=null;this._pMatrix=mat4.create();this._mvMatrix=mat4.create();this._vertexBuffer=T.createBuffer();this._markersRenderData=[];this._imgPool=new ge("img");this._imagesAdded={};this._float32Array=new Float32Array(2000);this._useRound=true;this.zIndex=20;this._init()}dn.VS_SHADER_TEXT=["precision highp float;","attribute vec3 aVertexPosition;","attribute vec2 aVertexTextureCoord;","varying vec2 vTextureCoord;","uniform mat4 uMVMatrix;","uniform mat4 uPMatrix;","void main(void) {","    gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);","    vTextureCoord = aVertexTextureCoord;","}"].join("\\n");dn.FS_SHADER_TEXT=["precision highp float;","uniform sampler2D uSampler;","varying vec2 vTextureCoord;","void main(void) {","    gl_FragColor = texture2D(uSampler, vTextureCoord);","}"].join("\\n");C.extend(dn.prototype,{_init:function(){this._initShaders();this._getAllUniforms();this._getAttribLocation();this._updateMatrix();this._textureAtlas=new b6.TextureAtlas(this._gl,{width:4096,height:4096});var e=this;var i=this._earth.getMap();var e=this;i.addEventListener("movestart",function(){e._useRound=false});i.addEventListener("moveend",function(){e._useRound=true});i.addEventListener("zoomstart",function(){e._useRound=false});i.addEventListener("zoomend",function(){e._useRound=true;e.onStatusChange();e._earth.fire(new a6("onrefresh"))});this._earth.on("markers_status_change",function(){e.onStatusChange();e._earth.fire(new a6("onrefresh"))})},_updateMatrix:function(){mat4.identity(this._mvMatrix);mat4.translate(this._mvMatrix,this._mvMatrix,[-this._width/2,this._height/2,0]);mat4.ortho(this._pMatrix,-this._width/2,this._width/2,-this._height/2,this._height/2,100,-100)},_initShaders:function(){var e=dn.VS_SHADER_TEXT;var T=dn.FS_SHADER_TEXT;var hJ=this._gl;var hK=this._glProgram=hJ.createProgram();var hI=this._makeShader(e,hJ.VERTEX_SHADER);var i=this._makeShader(T,hJ.FRAGMENT_SHADER);hJ.attachShader(hK,hI);hJ.attachShader(hK,i);hJ.linkProgram(hK);hJ.useProgram(hK)},_makeShader:function(hI,e){var T=this._gl;var i=T.createShader(e);T.shaderSource(i,hI);T.compileShader(i);return i},_getAllUniforms:function(){var i=this._glProgram;var e=this._gl;i.pMatrixUniform=e.getUniformLocation(i,"uPMatrix");i.mvMatrixUniform=e.getUniformLocation(i,"uMVMatrix");i.sampler=e.getUniformLocation(i,"uSampler")},_setUniforms:function(){var i=this._glProgram;var e=this._gl;e.uniformMatrix4fv(i.pMatrixUniform,false,this._pMatrix);e.uniformMatrix4fv(i.mvMatrixUniform,false,this._mvMatrix)},_getAttribLocation:function(){var i=this._glProgram;var e=this._gl;i.vertexPositionAttribute=e.getAttribLocation(i,"aVertexPosition");i.vertexTexCoordAttribute=e.getAttribLocation(i,"aVertexTextureCoord")},resize:function(){this._width=this._canvas.width/this._ratio;this._height=this._canvas.height/this._ratio;this._updateMatrix()},_addTexture:function(e){return this._textureAtlas.addTexture(e)},onStatusChange:function(hN){this._updateScreenPixel();this._calcCollision();var hK=this._earth.getZoom();if(hK>=this._earth.zoomForNight+1){this._markersRenderData=this._earth._overlayMgr.getMarkersRenderData();var hM=this;for(var hI=0;hI<this._markersRenderData.length;hI++){var T=this._markersRenderData[hI].overlay;var hL=T._config.icon;if(T.textureCoord){continue}var hO=hL.imageUrl;var hJ=hL.imageDom;if(hO){if(hM._ratio>1&&hL.srcSetObject["2x"]){hO=hL.srcSetObject["2x"];hL.ratio=2}if(hM._imagesAdded[hO]){if(hM._imagesAdded[hO].status==="loaded"){if(hL.imageSize){hL.ratio=hM._imagesAdded[hO].imgSize.width/hL.imageSize.width}T.textureCoord=hM._calcTextureCoords(hM._imagesAdded[hO].imgSize,hL.size,hL.imageOffset,hM._imagesAdded[hO].textureOffset,hL.ratio);hM._earth.fire(new a6("onrefresh"))}else{hM._imagesAdded[hO].markers.push(T)}continue}hM._imagesAdded[hO]={status:"loading",markers:[T]};hM._loadIconImageByUrl(hO)}else{if(hJ){if(hM._imagesAdded[hJ.id]){if(hL.imageSize){hL.ratio=hM._imagesAdded[hJ.id].imgSize.width/hL.imageSize.width}T.textureCoord=hM._calcTextureCoords(hM._imagesAdded[hJ.id].imgSize,hL.size,hL.imageOffset,hM._imagesAdded[hJ.id].textureOffset,hL.ratio);hM._earth.fire(new a6("onrefresh"));continue}hM._imagesAdded[hJ.id]={status:"loading",markers:[T]};hM._processImageAfterLoad(hJ.id,hJ)}}}}else{this._markersRenderData=[]}},_loadIconImageByUrl:function(hJ){var T=this;var e=T._imgPool.get();e.crossOrigin="anonymous";e.onload=function i(){T._processImageAfterLoad(hJ,this);T._imgPool.free(this)};e.onerror=function hI(){T._imgPool.free(this);T._imagesAdded[hJ]=null};e.src=hJ},_processImageAfterLoad:function(T,hK){this._imagesAdded[T].status="loaded";var i=this._addTexture(hK);var hJ=new d1(hK.width,hK.height);this._imagesAdded[T].imgSize=hJ;this._imagesAdded[T].textureOffset=i;for(var e=0;e<this._imagesAdded[T].markers.length;e++){var hL=this._imagesAdded[T].markers[e];var hI=hL._config.icon;if(hI.imageSize){hI.ratio=hJ.width/hI.imageSize.width}hL.textureCoord=this._calcTextureCoords(hJ,hI.size,hI.imageOffset,i,hI.ratio)}this._imagesAdded[T].markers=[];this._earth.fire(new a6("onrefresh"))},_calcTextureCoords:function(hM,hP,hU,hO,i){if(!hM||!hP||!hU||!hO){}i=i||1;var T=this._textureAtlas.getSize();var hN=-hU.width*i;var e=-hU.height*i;var hT=-hN/T.width+hO.width;var hL=(hM.height+e-hP.height*i)/T.height+hO.height;var hS=(-hN+hP.width*i)/T.width+hO.width;var hK=hL;var hR=hS;var hJ=(hM.height+e)/T.height+hO.height;var hQ=hT;var hI=hJ;return[hT,hL,hS,hK,hR,hJ,hT,hL,hR,hJ,hQ,hI]},_updateScreenPixel:function(){var hW=this._earth;var hP=hW.getCenter();var hS=hW.scene._camera;for(var hO=0;hO<this._markersRenderData.length;hO++){var hJ=this._markersRenderData[hO];var hQ=hJ.overlay;var hI;if(hW.getZoom()>15){var hT=hW.scene.fromLatLngToXYZ(hQ.latLng);hT=cD(hT,hW.rotationInfo);hI=hW.scene.fromXYZToPixel(hT[0],hT[1],hT[2],{isCalcOnBack:true,useRound:this._useRound,matrixInfo:{modelViewMatrix:hS._mvMatrixForCamera}})}else{hI=hW.fromLatLngToPixel(hQ.latLng,{isCalcOnBack:true,useRound:this._useRound})}if(hI.onBack){hJ.screenVertex=[];hJ.screenBounds=null;continue}if(hQ._config.enableCollisionDetection){var hV=hQ.getIcon();var hL=hI.x-hV.anchor.width;var hK=hI.y-hV.anchor.height;var T=hL+hV.size.width;var e=hK+hV.size.height;hJ.screenBounds={minX:hL,minY:hK,maxX:T,maxY:e}}var hR=hJ.iconRenderData.vertex;var hU=[];var hN=hQ._config.offset;for(var hM=0;hM<hR.length/3;hM++){hU[hM*3]=hR[hM*3]+hI.x+hN.width;hU[hM*3+1]=hR[hM*3+1]-hI.y+hN.height;hU[hM*3+2]=hR[hM*3+2]}hJ.screenVertex=hU}},_calcCollision:function(){var hQ=this._markersRenderData;var hP=[];for(var hM=0;hM<hQ.length;hM++){if(hQ[hM].overlay._config.enableCollisionDetection&&hQ[hM].screenBounds){hP.push(hQ[hM])}}hP.sort(function(hT,i){return i.overlay._config.rank-hT.overlay._config.rank});var hJ=2;for(var hM=0;hM<hP.length;hM++){var e=hP[hM];var hS=e.screenBounds;e._intersectIndex=[];hP[hM].overlay.collisionDetectionFailed=false;for(var hK=hM+1;hK<hP.length;hK++){var T=hP[hK].screenBounds;if(hS.minX+hJ<T.maxX-hJ&&hS.maxX-hJ>T.minX+hJ&&hS.minY+hJ<T.maxY-hJ&&hS.maxY-hJ>T.minY+hJ){e._intersectIndex.push(hK)}}}for(var hM=0,hI=hP.length;hM<hI;hM++){var hL=hP[hM].overlay;if(hL.collisionDetectionFailed===false){var hR=hP[hM]._intersectIndex;for(var hK=0,hO=hR.length;hK<hO;hK++){var hN=hR[hK];hP[hN].overlay.collisionDetectionFailed=true}}}for(var hM=0,hI=hP.length;hM<hI;hM++){var hL=hP[hM].overlay;if(hL.collisionDetectionFailed){hL.hideInternal("collision")}else{hL.showInternal()}}},renderFrame:function(i){var hI=this._earth._map;if(hI._displayOptions.overlay===false){return}if(this._markersRenderData.length===0){return}var e=this._earth.getZoom();if(e<this._earth.zoomForNight+1){return}var hJ=this._gl;var hK=this._glProgram;var T=this._webglState;hJ.useProgram(hK);T.disableCap("depthTest");T.enableCap("blend");T.enableCap("cullFace");T.cullFace(hJ.BACK);T.initAttribute();T.enableAttribute(hK.vertexPositionAttribute);T.enableAttribute(hK.vertexTexCoordAttribute);T.disableUnusedAttributes();this._drawOverlays(hJ,hK)},_drawOverlays:function(hL,e){var hO=this._textureAtlas.getTexture();var hP=this._float32Array;var hM=[];for(var hJ=0,T=this._markersRenderData.length;hJ<T;hJ++){var hK=this._markersRenderData[hJ].overlay;if(!hK.textureCoord||hK.collisionDetectionFailed===true){continue}var hN=this._markersRenderData[hJ].screenVertex;if(!hN){continue}for(var hI=0;hI<hN.length/3;hI++){hM.push(hN[hI*3]);hM.push(hN[hI*3+1]);hM.push(hN[hI*3+2]);hM.push(hK.textureCoord[hI*2]);hM.push(hK.textureCoord[hI*2+1])}}if(hM.length===0){return}this._setUniforms();this._webglState.activeTexture(hL.TEXTURE0);hL.bindTexture(hL.TEXTURE_2D,hO);hL.uniform1i(e.sampler,0);hL.bindBuffer(hL.ARRAY_BUFFER,this._vertexBuffer);if(hM.length<hP.length){hP.set(hM,0)}else{hP=new Float32Array(hM)}hL.bufferData(hL.ARRAY_BUFFER,hP,hL.STATIC_DRAW);hL.vertexAttribPointer(e.vertexPositionAttribute,3,hL.FLOAT,false,20,0);hL.vertexAttribPointer(e.vertexTexCoordAttribute,2,hL.FLOAT,false,20,12);hL.drawArrays(hL.TRIANGLES,0,hM.length/5)}});function aW(T,e){this._earth=T;this._opts=e||{};this.renderer=new d(T,this);this.domains=b1.B_SATELLITE_MAP.tileUrls;var i=az("ditu","satellite");this._udt=i.udt;this._version=i.ver}C.extend(aW.prototype,{getTilesUrl:function(e,hN,T,hJ,hL){var hK;var i="";var hI=a1();if(hJ==="night"){var hM=this._earth.getContainerSize().height;if(hM>800||hI>=1.5){return eV.imgPath+"tiles/night_1-2k.jpg?20150826"}return eV.imgPath+"tiles/night_1.jpg?20150826"}else{if(hJ==="world"){var hM=this._earth.getContainerSize().height;if(hM>800||hI>=1.5){return eV.imgPath+"tiles/world_1-2k.jpg?20150826"}return eV.imgPath+"tiles/world_1.jpg?20150826"}else{if(hJ==="er"){if(T<2){T=2}if(hL.indexOf("north")>-1){return eV.imgPath+"tiles/north_polar_"+T+".jpg?20150826"}else{return eV.imgPath+"tiles/south_polar_"+T+".jpg?20150826"}}else{i=Math.round(Math.abs(e+hN)%4);hK=this.domains[i]+"u=x={x};y={y};z={z};v=009;type=sate&fm=46&app=webearth2&v="+this._version+"&udt="+this._udt;var tdir = offmapcfg.tiles_satellite_dir.length > 0 ? offmapcfg.tiles_satellite_dir : offmapcfg.home + "tiles_satellite";hK=tdir + "/{z}/{x}/{y}" + offmapcfg.imgext;}}}return hK.replace("{index}",i).replace("{z}",T).replace("{x}",e).replace("{y}",hN)}});function gl(T,e){this._earth=T;this._opts=e||{};this.type="streetlayer";var i=az("ditu","satelliteStreet");this._udt=i.udt;this._version=i.ver}C.extend(gl.prototype,{getTilesUrl:function(hI,hL,hK,T){var e=b1.B_STREET_MAP.tileUrls;var i=Math.round(Math.abs(hI+hL)%e.length);var hJ=e[i]+"?qt=vtile&x={x}&y={y}&z={z}&styles=sl&showtext=0&v="+this._version+"&udt="+this._udt;var tdir = offmapcfg.tiles_road_dir.length > 0 ? offmapcfg.tiles_road_dir : offmapcfg.home + "tiles_road";hJ=tdir + "/{z}/{x}/{y}" + offmapcfg.imgext;return hJ.replace("{z}",hK).replace("{x}",hI).replace("{y}",hL)}});var hE=3;var g7=5;var b4=5;var dR=4;var hh=3;var e7=2;var hB=1;var dU=0;var I={3:{start:3,base:3},4:{start:4,base:5},5:{start:4,base:5},6:{start:6,base:7},7:{start:6,base:7},8:{start:8,base:9},9:{start:8,base:9},10:{start:10,base:10},11:{start:11,base:12},12:{start:11,base:12},13:{start:11,base:12},14:{start:14,base:15},15:{start:14,base:15},16:{start:16,base:17},17:{start:16,base:17},18:{start:18,base:19},19:{start:18,base:19},20:{start:18,base:19},21:{start:18,base:19}};function dj(hJ,hI){this._earth=hJ;var e=hJ.scene._ratio;this._width=hJ._canvas.width/e;this._height=hJ._canvas.height/e;this._opts=hI||{};var T=fr();this._udt=T.udt;this._version=T.ver;var i=az("ditu","normal");this._udt2=i.udt;this._version2=i.ver;this._tileType=cF.getInstance("na");this._iconRefreshTimer=null;this._rawDataCache=new fC(200);this._binaryCache={};this._iconCache={};this._init();this.renderer=new bo(hJ,this)}C.extend(dj.prototype,{_init:function(){this._imgPool=new ge("img");this._projection=this._earth.getProjection();this._radius=this._earth.radius;this._featureStyle=bj["FeatureStyle"+this._earth._map.config.style];this._textTextureImgWidth=4096;this._textTextureImgHeight=4096;if(this._earth.scene._ratio>1){this._textTextureImgWidth+=1024}this._textTextureImgWidth=Math.min(this._textTextureImgWidth,a3.params.maxTextureSize);this._tempI=mat2.create();this._tempRotateMatrix=mat2.create();this._tempOut=mat2.create();this._v2_0=vec2.create();this._v2_1=vec2.create();this._v2_2=vec2.create();this._v2_3=vec2.create();this._wordSpaceRatio=2;this._fixedLabelMagRatio=0.5;this._lineLabelMagRatio=700*0.56/this._earth.getContainerSize().height;this._headingHash={_0:true,_90:true,_180:true,_270:true,_360:true}},loadTileData:function(T,hN,hJ,i,hM){var hK=this;var hL=hM.replace("key","cbk").replace(/-/g,"M");bj[hL]=function(hR){var hS=hR[5];if(hS){var hP=hK._imgPool.get();if(C.Browser.safari){hP.src=""}var hO=hR[6];hP.onload=function(){hO=hO||this.height;var hU=hK.renderer.addTextTexture(this,hO);if(hU===null){hK._imgPool.free(this);return}var hT=hK._processData(this,hR,T,hN,hJ,i,hU,hO);hK.renderer.setTextureInfoRes(hM,hT);hK._imgPool.free(this)};hP.src=hS}else{var hQ=hK._processData(null,hR,T,hN,hJ,i);hK.renderer.setTextureInfoRes(hM,hQ)}hK._rawDataCache.setData(hM,hR);delete bj[hL]};var hI=this._rawDataCache.getData(hM);if(hI){bj[hL](hI)}else{var e=hK._getTilesUrl(T,hN,hJ,hL);hd.load(e)}},_processData:function(hL,hI,i,hO,hK,e,T,hM){var hN={};var hJ;if(hL){hJ=this._calcIconAndTextInfo(hI,i,hO,hK,e,hL.width,hM,T)}else{hJ=this._calcIconAndTextInfo(hI,i,hO,hK,e,null,null)}hN.icTxtInfo=hJ;hN.imageContentHeight=hM;return hN},_calcIconAndTextInfo:function(hP,hJ,hS,hQ,hI,hK,hR,hL){var T=[];if(hP[0]){for(var hO=0;hO<hP[0].length;hO++){if(hP[0][hO][0]===hE){T.push(hP[0][hO])}}}var hN=hP[2]||[];var hM=[];var e=[];for(var hO=0;hO<T.length;hO++){this._getFixedLabelInfo(T[hO],hJ,hS,hQ,hI,hK,hR,hL,hM)}for(hO=0;hO<hN.length;hO++){this._getLineLabelInfo(hN[hO],hJ,hS,hQ,hI,hK,hR,hL,e)}return{fixedLabel:hM,lineLabel:e}},_getFixedLabelInfo:function(h1,hJ,hS,e,h7,ic,h2,im,ik){var ih=this._earth._map.getMapStyleId();var h3=h1[1];if(!h3){return}var h8=this._featureStyle;var hM=h7;if(hM===9){hM=8}var h6=this._projection;var il=200;var ie=Math.pow(2,18-e);var T=this._tileType.getBaseTileSize(e);var h5=hJ*T*ie;var h4=hS*T*ie;for(var ij=0;ij<h3.length;ij++){var hO=h3[ij];var ib=hO[0];var hW=ed.getStyleFromCache(ih,ib,"point",hM,h8);var ig=ed.getStyleFromCache(ih,ib,"pointText",hM,h8);if((!ig||ig.length===0)&&(!hW||hW.length===0)){if(hM===5){var hI=hO[1];if(!hI){continue}for(var ii=0;ii<hI.length;ii++){var hT=hI[ii][4];if(hT&&hT[7]==="åäº¬"){hW=ed.getStyleFromCache(ih,ib,"point",6,h8);ig=ed.getStyleFromCache(ih,ib,"pointText",6,h8);break}else{continue}}}else{continue}}var hI=hO[1];if(!hI){continue}var hP=null;var hV=1;var hR=0;var hX=0;if(hW&&hW[0]){hW=hW[0];hP=hW.icon;hV=hW.zoom?hW.zoom/100:1}else{hW=null}for(var ii=0;ii<hI.length;ii++){var hT=hI[ii][4];if(!hT){continue}var id=hT[2];if(!this._isVisible(id,h7)){continue}var hQ=hT[12];if(ig&&ig.length>0&&!hQ){continue}var ia=Math.round(hT[0]/100);var h9=Math.round(hT[1]/100);var io={lng:h5+ia,lat:h4+h9};var hY=h6.convertMC2LL(io);var hZ=hT[7]||"";var hL={type:"fixed",latLng:hY,pt:io,name:hZ,rank:hT[4],iconPos:null,textPos:null,tilePosStr:hT[0]+","+hT[1],guid:hT[3]||""};var hN=hT[5];if((hN!==dR&&hQ||!hQ)&&hP!==null){hL.iconPos=this._getIconVertexData(hP,hV);if(hL.iconPos){hR=hL.iconPos.width;hX=hL.iconPos.height;var h0=this._iconCache[hP];if(!h0){h0=this._iconCache[hP]={loaded:false,img:null};var hU=this;var hK=new Image();hK.id=hP;hK.crossOrigin="anonymous";hK.onload=function(){hU._iconCache[this.id].img=this;hU._iconCache[this.id].loaded=true;hU._addToIconTexture(this);if(hU._iconRefreshTimer===null){hU._iconRefreshTimer=setTimeout(function(){hU._earth.fire(new a6("onrefresh"));hU._iconRefreshTimer=null},il)}this.onload=null};hK.onerror=function(){hU._iconCache[this.id]=null;this.onerror=null};hK.src=eV.getIconSetPath(this._earth._map)+hP+".png"}}}if(hQ){hL.textPos=this._getTextVertexData(hT,hR,hX,ic,h2,im)}if(hL.textPos||hL.iconPos){this._addBounds(hL);ik.push(hL)}}}},_getLineLabelInfo:function(hW,hN,hX,hJ,im,ix,ii,iH,ih){if(hW.length!==10){return}var hO=im;var hL=this._wordSpaceRatio;var h2=Math.pow(2,18-hJ);var hK=this._tileType.getBaseTileSize(hJ);var il=hN*hK*h2;var ik=hX*hK*h2;var iD=this._projection;var iw=hW[7].length;var h7=hW[1];var iy=hW[3];var hS=hW[4];var e=2;var hP=hS.slice(0,e);for(var iA=e;iA<hS.length;iA+=e){hP[iA]=hP[iA-e]+hS[iA];hP[iA+1]=hP[iA-(e-1)]+hS[iA+1]}for(var iC=0;iC<iw;iC++){var iz=hW[7][iC];if(!this._isVisible(iz,im)){continue}var it=hW[6][iC];var h5=iC*iy*e;hS=hP.slice(h5,h5+iy*e);var ic=[];var ir=1000;var iq=1000;var h4=-1000;var h3=-1000;var iF=hW[9].slice(0);if(it){iF.reverse()}var ib;var ia;var hM;var ic=[];var h9;for(var iB=0;iB<iy;iB++){var h1=hW[5][iy*iC+iB];var iv=hS[iB*e]/100;var iu=hS[iB*e+1]/100;var iJ={lng:il+iv,lat:ik+iu};var h6=iD.convertMC2LL(iJ);if(iB===0){ib=iv;ia=iu;hM={lng:il+ib,lat:ik+ia};var h8=hS[(iy-1)*e]-hS[0];var hR=hS[(iy-1)*e+1]-hS[1];if(it===1){h8=-h8;hR=-hR}h9=this._calcAngleByXYDiff(h8,hR);ic.baseX=hM.lng;ic.baseY=hM.lat}var h0=iF[iB];var hT=h0[0];var hV=h0[1];var hQ=h0[2];var hU=h0[3];var ip=(iv-ib)/h2*hL;var io=(iu-ia)/h2*hL;var iK=hT/this._textTextureImgWidth+iH.width;var ij=(ii-hV)/this._textTextureImgHeight+iH.height;var iI=iK;var ig=(ii-hV-hU)/this._textTextureImgHeight+iH.height;var iG=(hT+hQ)/this._textTextureImgWidth+iH.width;var ie=ij;var iE=iG;var id=ig;ic.push([[ip,io],[hQ,hU],h1,[iK,ij,iI,ig,iG,ie,iE,id]]);var hZ=ip-hQ/2;var hI=io+hU/2;var T=io-hU/2;var hY=ip+hQ/2;if(hZ<ir){ir=hZ}if(hY>h4){h4=hY}if(T<iq){iq=T}if(hI>h3){h3=hI}}ih.push({type:"line",rank:h7,pt:hM,bounds:[ir,iq,h4,h3],wordsInfo:ic,labelAngle:h9,latLng:h6})}},_calcAngleByXYDiff:function(hI,T){var i;if(hI===0){if(T>0){i=90}else{i=270}return i}var e=T/hI;var i=c8(Math.atan(e));if(hI<0&&T>0){i+=180}else{if(hI<0&&T<0){i+=180}else{if(hI>0&&T<0){i+=360}}}if(i===360){i=0}return i},_isVisible:function(e,i){var hI;if(!this._binaryCache[e]){hI=e.toString(2);if(hI.length<8){hI=new Array(8-hI.length+1).join("0")+hI}this._binaryCache[e]=hI}hI=this._binaryCache[e];var T=I[i].start;return hI[i-T]==="1"},_getTextVertexData:function(hY,hN,hU,hW,hQ,T){var h5=hY[5];if(typeof h5!=="number"){h5=0}var hT=hY[12];var hO=hT.length;var hV=[];var hX=[];var h0=0;var h6=0;for(var hZ=0;hZ<hO;hZ++){h6+=Math.round(hT[hZ][3])}for(var hZ=0;hZ<hO;hZ++){var hR=hT[hZ];var hP=hR[0];var i=hR[1];var hL=hR[2];var e=hR[3];var h7=4;var h4;var hM;if(hN===0){h5=dR}switch(h5){case hh:var hS=h6/2-e+h7*(hO-1)/2;h4=Math.round(-hN/2-hL)-h7;hM=Math.round(hS-h0-h7*hZ);break;case hB:var hS=h6/2-e+h7*(hO-1)/2;h4=Math.round(hN/2)+h7;hM=Math.round(hS-h0-h7*hZ);break;case e7:var hS=hU/2+h6-e+h7*hO;h4=Math.round(-hL/2);hM=Math.round(hS-h0-h7*hZ);break;case dU:var hS=-hU/2-h7-e;h4=Math.round(-hL/2);hM=Math.round(hS-h0-h7*hZ);break;case dR:var hS=-h6/2-h7*(hO-1)/2;h4=Math.round(-hL/2);hM=Math.round(hS-h0-h7*hZ);break}h0+=e;var h3=h4+Math.round(hL);var hK=hM;var h2=h3;var hJ=hK+Math.round(e);var h1=h4;var hI=hJ;hV.push(h4,hM,h3,hK,h2,hJ,h4,hM,h2,hJ,h1,hI);this._calcTexCoords(hP,i,hL,e,hW,hQ,T,hX)}return{destVertex:hV,srcCoord:hX,width:hL,height:e}},_getIconVertexData:function(hO,hL){var hJ=this._earth._map.config.style;var hS=bj["iconSetInfo"+hJ][hO];if(!hS){if(hO&&hO.charCodeAt(0)>=48&&hO.charCodeAt(0)<=57){hS=bj["iconSetInfo"+hJ]["_"+hO]}}if(hS){var hK=hS[0]*hL;var hP=hS[1]*hL;var hI=Math.round(-hK/2);var hR=Math.round(-hP/2);var T=hI+hK;var hQ=hR;var i=T;var hN=hQ+hP;var e=hI;var hM=hN;return{destVertex:[hI,hR,T,hQ,i,hN,hI,hR,i,hN,e,hM],srcCoord:null,width:hK,height:hP,iconType:hO}}return null},_addToIconTexture:function(hL){var hK=this.renderer;var e=hK._iconTextureAtlas.addTexture(hL);hK._iconTextureAtlasOffset[hL.id]=e;var hP=0*hL.width/1024+e.width;var hJ=0*hL.height/1024+e.height;var hO=hL.width/1024+e.width;var hI=hJ;var hN=hO;var T=hL.height/1024+e.height;var hM=hP;var i=T;hK._iconTextureAtlasCoords[hL.id]=[hP,hJ,hO,hI,hN,T,hP,hJ,hN,T,hM,i]},_addLineTextPos:function(hS,hQ,ir,h9,id,h0,iu,hY,hI,iz){var hR=hQ[8];var h4=hQ[7];var h1=hQ[3];var im=0;var hL=this._wordSpaceRatio;for(var iw=0,it=hR.length;iw<it;iw++){var io=hR[iw];var il=(io[1]==1?true:false);var h2=io[2];var hM=io[0];var h3=[];var ik=1000;var ij=1000;var hX=-1000;var hW=-1000;if(il&&!h4._reversed){h4.reverse();h4._reversed=true}var ie=hM[0][0][0];var ib=hM[0][0][1];h3.baseX=hY+ie*iu;h3.baseY=hI+ib*iu;var hZ=id.convertMC2LL(new hj(h3.baseX,h3.baseY));for(var iv=0,h7=hM.length;iv<h7;iv++){var hP=hM[iv];var hV=hP[1];var hN=h4[im][0];var hO=h4[im][1];var e=h4[im][2];var hK=h4[im][3];var ig=hP[0][0];var ic=hP[0][1];var ii=(ig-ie)*hL;var ih=(ic-ib)*hL;var iB=hN/this._textTextureImgWidth+iz.width;var ia=(h9-hO)/this._textTextureImgHeight+iz.height;var iA=iB;var h8=(h9-hO-hK)/this._textTextureImgHeight+iz.height;var iy=(hN+e)/this._textTextureImgWidth+iz.width;var h6=ia;var ix=iy;var h5=h8;var iq=[[ii,ih],[e,hK],hV,[iB,ia,iA,h8,iy,h6,ix,h5]];h3.push(iq);var hU=ii-e/2;var hJ=ih+hK/2;var T=ih-hK/2;var hT=ii+e/2;if(hU<ik){ik=hU}if(hT>hX){hX=hT}if(T<ij){ij=T}if(hJ>hW){hW=hJ}im++}if(h7>0){var ip={type:"line",wordsInfo:h3,labelAngle:h2,latLng:hZ,bounds:[ik,ij,hX,hW],rank:h1};hS.push(ip)}}},_addBounds:function(hO){var hK=1000;var hI=1000;var T=-1000;var e=-1000;if(hO.iconPos){var hM=hO.iconPos.destVertex;for(var hN=0,hJ=hM.length;hN<hJ;hN+=2){var hQ=hM[hN];var hP=hM[hN+1];if(hQ<hK){hK=hQ}if(hQ>T){T=hQ}if(hP<hI){hI=hP}if(hP>e){e=hP}}}if(hO.textPos){var hL=hO.textPos.destVertex;for(var hN=0,hJ=hL.length;hN<hJ;hN+=2){var hQ=hL[hN];var hP=hL[hN+1];if(hQ<hK){hK=hQ}if(hQ>T){T=hQ}if(hP<hI){hI=hP}if(hP>e){e=hP}}}hO.bounds=[hK,hI,T,e];hO.bds=[hK/2,hI/2,T/2,e/2]},_calcTexCoords:function(T,hO,i,hU,hI,hS,hJ,e){var hT=T/this._textTextureImgWidth+hJ.width;var hN=(hS-hO-hU)/this._textTextureImgHeight+hJ.height;var hR=(T+i)/this._textTextureImgWidth+hJ.width;var hM=hN;var hQ=hR;var hL=(hS-hO)/this._textTextureImgHeight+hJ.height;var hP=hT;var hK=hL;e.push(hT,hN,hR,hM,hQ,hL,hT,hN,hQ,hL,hP,hK)},updateTexCoords:function(hM,hK){for(var hJ=0,e=hM.length;hJ<e;hJ++){var T=hM[hJ].textPos;for(var hI=1,hL=T.srcCoord.length;hI<hL;hI+=2){T.srcCoord[hI]=T.srcCoord[hI]-T.offsetY+hK}T.offsetY=hK}},collisionTestByZoomingOut:function(hV,h3){var hI=this._earth;var hK=hI.getHeading();var hS=this._fixedLabelMagRatio;var hJ=this._lineLabelMagRatio;var e=hI.getCenter();for(var h5=0,h1=hV.length;h5<h1;h5++){var h0=hV[h5];if(h0.isDel===true){continue}if(h0.type==="fixed"){var hZ=h0.latLng;var hW;if(hI.getZoom()>15){var ic=hI.scene.fromLatLngToXYZ(hZ);ic=cD(ic,hI.rotationInfo);hW=hI.scene.fromXYZToPixel(ic[0],ic[1],ic[2],{matrixInfo:{modelViewMatrix:hI.scene._camera._mvMatrixForCamera}})}else{hW=hI.fromLatLngToPixel(hZ)}h0.scrPt=hW;var h7=hW.x;var h6=h3-hW.y;var hN=h0.bounds;h0._tempBounds=[h7+hN[0]*hS,h6+hN[1]*hS,h7+hN[2]*hS,h6+hN[3]*hS]}else{var hZ=h0.latLng;var hW=hI.fromLatLngToPixel(hZ);var h7=hW.x;var h6=h3-hW.y;var hN=h0.bounds;var hQ=hN[0]*hJ;var hP=hN[1]*hJ;var hO=hN[2]*hJ;var hM=hN[3]*hJ;var ib=hQ;var ia=hP;var h9=hO;var h8=hM;if(hK===0||hK===360){ib=hQ;ia=hP;h9=hO;h8=hM}else{if(hK===90||hK===-270){ib=hP;ia=-hO;h9=hM;h8=-hQ}else{if(hK===180||hK===-180){ib=-hO;ia=-hM;h9=-hQ;h8=-hP}else{if(hK===270||hK===-90){ib=-hM;ia=hQ;h9=-hP;h8=hO}}}}h0._tempBounds=[h7+ib,h6+ia,h7+h9,h6+h8]}}var hY=5;if(hI.getImageZoom()===5){hY=-2}if(hI.getImageZoom()===8){hY=10}for(var h5=0,h1=hV.length;h5<h1;h5++){var hX=hV[h5];if(hX.isDel===true){continue}var h4=hX._tempBounds;hX.arrIntersectIndex=[];for(h2=h5+1;h2<h1;h2++){var hU=hV[h2];if(hU.isDel===true){continue}var hL=hU._tempBounds;if(!(h4[2]+hY<hL[0]-hY||h4[0]-hY>hL[2]+hY||h4[3]+hY<hL[1]-hY||h4[1]-hY>hL[3]+hY)){hX.arrIntersectIndex.push(h2)}}}for(var h5=0,h1=hV.length;h5<h1;h5++){var hR=hV[h5];if(hR.isDel===false){var T=hR.arrIntersectIndex;for(var h2=0,hT=T.length;h2<hT;h2++){hV[T[h2]].isDel=true}}}},collisionTest:function(ia,ij,hI){if(!ia){return}var e=this._earth;var h8=e.getHeading();var hM=[];var hP=[];var il=this._fixedLabelMagRatio;var hO=this._lineLabelMagRatio;var id=false;if(e.getZoom()<=6){id=true}for(var ii=0,ig=ia.length;ii<ig;ii++){var T=ia[ii];var hR=T.key;var hJ=ij.getData(hR);if(!hJ||!hJ.icTxtInfo){continue}var h4=hJ.icTxtInfo.fixedLabel;for(var ih=0,h1=h4.length;ih<h1;ih++){var hL=h4[ih];var hX=hL.latLng;var h2;if(e.getZoom()>15){var hQ=e.scene.fromLatLngToXYZ(hX);hQ=cD(hQ,e.rotationInfo);h2=e.scene.fromXYZToPixel(hQ[0],hQ[1],hQ[2],{matrixInfo:{modelViewMatrix:e.scene._camera._mvMatrixForCamera}})}else{h2=e.fromLatLngToPixel(hX,{isCalcOnBack:id})}var h0=h2.x;var hZ=hI-h2.y;var h3=hL.bounds;hL.scrPt=h2;hL._tempBounds=[h0+h3[0]*il,hZ+h3[1]*il,h0+h3[2]*il,hZ+h3[3]*il];hP.push(hL)}var hN=hJ.icTxtInfo.lineLabel;for(var ih=0,h1=hN.length;ih<h1;ih++){var hL=hN[ih];var hX=hL.latLng;var h2=e.fromLatLngToPixel(hX);var h0=h2.x;var hZ=hI-h2.y;var h3=hL.bounds;var ie=h3[0]*hO;var ib=h3[1]*hO;var hW=h3[2]*hO;var hV=h3[3]*hO;var h9=ie;var h7=ib;var hU=hW;var hT=hV;if(h8===0||h8===360){h9=ie;h7=ib;hU=hW;hT=hV}else{if(h8===90||h8===-270){h9=ib;h7=-hW;hU=hV;hT=-ie}else{if(h8===180||h8===-180){h9=-hW;h7=-hV;hU=-ie;hT=-ib}else{if(h8===270||h8===-90){h9=-hV;h7=ie;hU=-ib;hT=hW}}}}hL._tempBounds=[h0+h9,hZ+h7,h0+hU,hZ+hT];hP.push(hL)}hM.push(hJ)}hP.sort(function(im,i){return i.rank-im.rank||i.pt.lng-i.pt.lng||i.pt.lat-im.pt.lat});var hK=5;if(e.getImageZoom()===5){hK=-2}if(e.getImageZoom()===8){hK=10}for(var ii=0,ig=hP.length;ii<ig;ii++){var h6=hP[ii];var hS=h6._tempBounds;h6.isDel=false;h6.arrIntersectIndex=[];for(ih=ii+1;ih<ig;ih++){var hY=hP[ih];var ik=hY._tempBounds;if(!(hS[2]+hK<ik[0]-hK||hS[0]-hK>ik[2]+hK||hS[3]+hK<ik[1]-hK||hS[1]-hK>ik[3]+hK)){h6.arrIntersectIndex.push(ih)}}}for(var ii=0,ig=hP.length;ii<ig;ii++){var ic=hP[ii];if(ic.isDel==false){var h5=ic.arrIntersectIndex;for(var ih=0,h1=h5.length;ih<h1;ih++){hP[h5[ih]].isDel=true}}}hM._arrLabels=hP;return hM},mergeFixedLabelInfo:function(hM,hZ,hU,T,hR){var e=hM.icTxtInfo.fixedLabel;var hI=[];var hJ=[];var hY=this._fixedLabelMagRatio;var hK=600;for(var hV=0,hS=e.length;hV<hS;hV++){var hP=e[hV];var hN=hP.scrPt;var hX=hN.x;var hW=hU-hN.y;if(hP.isDel||(hX<=0||hX>=hZ||hW<=0||hW>=hU)||hN.onBack){continue}if(hP.iconPos&&!hP.iconPos.srcCoord){if(this.renderer._iconTextureAtlasCoords[hP.iconPos.iconType]){hP.iconPos.srcCoord=this.renderer._iconTextureAtlasCoords[hP.iconPos.iconType]}}if(hP.iconPos&&hP.iconPos.srcCoord){var hQ=hP.iconPos.destVertex;var hO=hP.iconPos.srcCoord;for(var hT=0,hL=hQ.length;hT<hL;hT+=2){hI.push(hX+hQ[hT]*hY,hW+hQ[hT+1]*hY,hK,hO[hT],hO[hT+1])}}if(hP.textPos){var hQ=hP.textPos.destVertex;var hO=hP.textPos.srcCoord;for(var hT=0,hL=hQ.length;hT<hL;hT+=2){hJ.push(hX+hQ[hT]*hY,hW+hQ[hT+1]*hY,hK,hO[hT],hO[hT+1])}}}var h0={iconVertex:hI,textVertex:hJ};return h0},mergeLineLabelInfo:function(hP,ic){var hI=this._earth;var ix=hI.getHeading();var h9=hI.scene;var iq=this._projection;var h3=hI.getZoom();var hY=h3+2;var h5=Math.pow(2,18-hY);var h2=this._tempI;var h6=hP.icTxtInfo.lineLabel;var h4=[];var h8=this._lineLabelMagRatio;var h0="_"+ix+"_"+h3;if(ic&&h6[h0]){return h6[h0]}var id=this.renderer.getStatusChangeEvent();var iF="_"+Math.abs(ix);if(id&&id.type==="onheading_changed"&&!this._headingHash[iF]&&h6[h6.preCacheKey]){return h6[h6.preCacheKey]}for(var iD=0,iB=h6.length;iD<iB;iD++){var h1=h6[iD];if(h1.isDel){continue}var ie=h1.wordsInfo;var ib=h1.labelAngle;var iz=ie.baseX;var iy=ie.baseY;for(var iC=0,ii=ie.length;iC<ii;iC++){var iA=ie[iC];var iw=iA[0][0];var iu=iA[0][1];var e=iA[1][0];var hL=iA[1][1];var h7=iA[2];if(((ix===90||ix===-270)&&((ib>=45&&ib<=135)||(ib>=225&&ib<=315)))||((ix===-90||ix===270)&&((ib>=135&&ib<=225)||((ib>=315&&ib<=360)||(ib>=0&&ib<=45))))||(Math.abs(ix)===180)){var ia=ie[ii-1-iC];iw=ia[0][0];iu=ia[0][1];h7=ia[2]}var il=iA[3];var iM=il[0];var ik=il[1];var iL=il[2];var ij=il[3];var iK=il[4];var ih=il[5];var iJ=il[6];var ig=il[7];var hN=iz+(iw-e/2)*h5*h8;var it=iy+(iu+hL/2)*h5*h8;var hK=hN;var ir=iy+(iu-hL/2)*h5*h8;var hJ=iz+(iw+e/2)*h5*h8;var ip=it;var T=hJ;var im=ir;var hO=(hN+hJ)/2;var hM=(it+ir)/2;var io=this._tempRotateMatrix;var iv=this._tempOut;var hX=this._v2_0;var hU=this._v2_1;var hS=this._v2_2;var hQ=this._v2_3;vec2.set(hX,hN-hO,it-hM);vec2.set(hU,hK-hO,ir-hM);vec2.set(hS,hJ-hO,ip-hM);vec2.set(hQ,T-hO,im-hM);mat2.rotate(io,h2,(h7+ix)*Math.PI/180);mat2.multiply(iv,io,hX);hN=iv[0]+hO;it=iv[1]+hM;mat2.multiply(iv,io,hU);hK=iv[0]+hO;ir=iv[1]+hM;mat2.multiply(iv,io,hS);hJ=iv[0]+hO;ip=iv[1]+hM;mat2.multiply(iv,io,hQ);T=iv[0]+hO;im=iv[1]+hM;var hZ=iq.convertMC2LL(new hj(hN,it));var hW=iq.convertMC2LL(new hj(hK,ir));var hT=iq.convertMC2LL(new hj(hJ,ip));var hR=iq.convertMC2LL(new hj(T,im));var iI=h9.fromLatLngToXYZ(hZ,this._radius);var iH=h9.fromLatLngToXYZ(hW,this._radius);var iG=h9.fromLatLngToXYZ(hT,this._radius);var iE=h9.fromLatLngToXYZ(hR,this._radius);if(this._earth.getZoom()>15){iI=cD(iI,hI.rotationInfo);iH=cD(iH,hI.rotationInfo);iG=cD(iG,hI.rotationInfo);iE=cD(iE,hI.rotationInfo)}h4.push(iI[0],iI[1],iI[2],iM,ik,iH[0],iH[1],iH[2],iL,ij,iG[0],iG[1],iG[2],iK,ih,iH[0],iH[1],iH[2],iL,ij,iE[0],iE[1],iE[2],iJ,ig,iG[0],iG[1],iG[2],iK,ih)}}if(this._headingHash[iF]){var hV=h6.preCacheKey;if(hV){h6[hV]=null;delete h6[hV]}h6[h0]=h4;h6.preCacheKey=h0}return h4},_getTilesUrl:function(T,hN,hM,hL){var hJ=b1.B_NORMAL_MAP.vectorTileUrls;var hK=Math.round(Math.abs(T+hN)%hJ.length);var i="x={x}&y={y}&z={z}&udt={udt}&v={v}&styles=sl&textimg=1&textonly=1&scaler=2&fn="+es+".{fn}";var hI=i.replace("{x}",T).replace("{y}",hN).replace("{z}",hM).replace("{udt}",this._udt2).replace("{v}",this._version2).replace("{fn}",hL);var e=hJ[hK]+"?qt=vtile&param="+window.encodeURIComponent(gc(hI));var tiles_dir = offmapcfg.tiles_v_road_dir.length > 0 ? offmapcfg.tiles_v_road_dir : offmapcfg.home + "tiles_v_road";e=tiles_dir + "/"+hM+"/"+T+"/"+hN;return e}});function ds(e){this._earth=e;this._overlays=[[],[],[]];this._markersRenderData=[];this._tiles=new fC(200);this._customOverlays=[];this._init();e._overlayMgr=this}C.extend(ds.prototype,{_init:function(){this._bind();this._drawCanvas=S("canvas");this._drawCanvasLOD=S("canvas")},_bind:function(){var hI=this;var hK=this._earth._map;function e(hM){if(hK.mapType!==BMAP_EARTH_MAP){return}hI._update()}function hJ(hM){if(hK.mapType!==BMAP_EARTH_MAP){return}hI._updateMarker(hM.overlay,hM.action)}hK.on("addoverlay",function hL(hP){if(hK.mapType!==BMAP_EARTH_MAP){return}if(!(hP.overlay instanceof w)&&!(hP.overlay instanceof dk)){return}var hN=hP.overlay;var hM=0;if(hP.overlay instanceof a){hM=1}else{if(hP.overlay instanceof dk){hM=2}}for(var hO=0;hO<hI._overlays[hM].length;hO++){if(hI._overlays[hM][hO].hashCode===hN.hashCode){return}}hI._overlays[hM].push(hN);if(hM!==2){hN.on("lineupdate",e);hI._update()}else{hN.on("status_change",hJ);hI._updateMarker(hN,"add")}});hK.on("removeoverlay",function T(hP){if(hK.mapType!==BMAP_EARTH_MAP){return}if(!(hP.overlay instanceof w)&&!(hP.overlay instanceof dk)){return}var hN=hP.overlay;var hM=0;if(hP.overlay instanceof a){hM=1}else{if(hP.overlay instanceof dk){hM=2}}for(var hO=0;hO<hI._overlays[hM].length;hO++){if(hI._overlays[hM][hO].hashCode===hN.hashCode){hI._overlays[hM].splice(hO,1);break}}if(hM!==2){hN.off("lineupdate",e);hI._update()}else{hN.off("status_change",hJ);hI._updateMarker(hN,"remove")}});hK.on("clearoverlays",function i(hM){if(hK.mapType!==BMAP_EARTH_MAP){return}hI._syncOverlayFromMap(e,hJ)});hK.on("maptypechange",function(){if(this.mapType==="B_EARTH_MAP"){hI._syncOverlayFromMap(e,hJ)}});this._syncOverlayFromMap(e,hJ)},_updateRenderData:function(e){if(!this._markersRenderData[e.hashCode]){return}for(var T=0;T<this._markersRenderData.length;T++){if(this._markersRenderData[T].hashCode===e.hashCode){this._markersRenderData[T].iconRenderData=e._config.icon.getRenderData(e._rotation);break}}},_addMarkerToRenderData:function(e){if(this._markersRenderData[e.hashCode]){return}var i=e._config.icon;this._markersRenderData.push({overlay:e,hashCode:e.hashCode,iconRenderData:e._config.icon.getRenderData(e._rotation)});this._markersRenderData[e.hashCode]=true;this._markersRenderData.sort(function(hI,T){return hI.overlay._zIndex-T.overlay._zIndex})},_removeMarkerFromRenderData:function(e){if(!this._markersRenderData[e.hashCode]){return}for(var T=0;T<this._markersRenderData.length;T++){if(this._markersRenderData[T].hashCode===e.hashCode){this._markersRenderData.splice(T,1);break}}this._markersRenderData[e.hashCode]=null},_clearOverlaysData:function(e,hI){var hK;for(var T=0;T<this._overlays[0].length;T++){hK=this._overlays[0][T];hK.off("lineupdate",e)}for(T=0;T<this._overlays[1].length;T++){hK=this._overlays[1][T];hK.off("lineupdate",e)}var hJ;for(T=0;T<this._overlays[2].length;T++){hJ=this._overlays[2][T];hJ.off("status_change",hI)}this._overlays[0].length=this._overlays[1].length=this._overlays[2].length=0;this._markersRenderData=[]},_update:function(){var e=this;if(e._updateTimer){return}e._updateTimer=setTimeout(function(){e._tiles.clear();var i=new a6("onoverlaylayer_status_change");e._earth.fire(i);e._updateTimer=null},24)},_updateMarker:function(e,hJ){if(e&&hJ){if(hJ==="add"||hJ==="show"){if(e._visible===true){this._addMarkerToRenderData(e)}}else{if(hJ==="remove"||hJ==="hide"){this._removeMarkerFromRenderData(e)}else{this._updateRenderData(e);this._markersRenderData.sort(function(hK,i){return hK.overlay._zIndex-i.overlay._zIndex})}}}else{for(var T=0;T<this._overlays[2].length;T++){if(this._overlays[2][T]._visible===true){this._addMarkerToRenderData(this._overlays[2][T])}else{this._removeMarkerFromRenderData(this._overlays[2][T])}}}var hI=new a6("onmarkers_status_change");this._earth.fire(hI)},_syncOverlayFromMap:function(T,hJ){this._clearOverlaysData(T,hJ);var e=this._earth._map._overlays;for(var i in e){var hI=e[i];if(hI instanceof a===true||hI instanceof fd===true){this._overlays[1].push(hI);hI.on("lineupdate",T)}else{if(hI instanceof aM===true){this._overlays[0].push(hI);hI.on("lineupdate",T)}else{if(hI instanceof dk){this._overlays[2].push(hI);hI.on("status_change",hJ)}}}}this._update();this._updateMarker()},generateOverlayTile:function(e){var hS;if(typeof e==="number"){hS=this._drawCanvasLOD}else{hS=this._drawCanvas}hS.getContext("2d").clearRect(0,0,9999,9999);var h9=this._overlays[0];var hK=this._overlays[1];var ib;var hR=new dM();for(var h3=0,hZ=h9.length;h3<hZ;h3++){ib=h9[h3].getBoundsIn();hR.extend(ib.getMin());hR.extend(ib.getMax())}for(h3=0,hZ=hK.length;h3<hZ;h3++){ib=hK[h3].getBoundsIn(true);hR.extend(ib.getMin());hR.extend(ib.getMax())}var h1=hR.clone();var hX=this._earth.getBounds();var hV=hX.getSouthWest();var hL=hX.getNorthEast();if(hV.lng>hL.lng){hL.lng=180}var ic=ef.convertLL2MC(hV);var T=ef.convertLL2MC(hL);e=e||this._earth.getImageZoom();var hU=Math.pow(2,e-18);var ia=this._earth._map;var hI=ia.config.defaultMaxBounds;var h8=Math.max(ic.lng,hI.sw.lng);var h7=Math.max(ic.lat,hI.sw.lat);var h6=Math.min(T.lng,hI.ne.lng);var h5=Math.min(T.lat,hI.ne.lat);var hO=new dM(new hj(h8,h7),new hj(h6,h5));var hQ=h1.intersects(hO);if(hQ===null){if(!hO.containsBounds(h1)){if(this._earth.getZoom()>=4){return}}}hQ=hQ||h1;if(this._earth.getZoom()<4){hQ=h1}if(hQ.isEmpty()){return}var hJ=hQ.getMin();var hM=hQ.getMax();var hN=new eb(hJ.lng*hU,hJ.lat*hU);var hP=new eb(hM.lng*hU,hM.lat*hU);var hY=Math.floor(hN.x/256);var hW=Math.ceil(hP.x/256);var h2=Math.floor(hN.y/256);var h0=Math.ceil(hP.y/256);var h4=(hW-hY+1)*256;var hT=(h0-h2+1)*256;hS.width=h4;hS.height=hT;hS.fromCol=hY;hS.fromRow=h2;hS.toCol=hW;hS.toRow=h0;hS.cols=hW-hY+1;hS.rows=h0-h2+1;for(h3=0,hZ=h9.length;h3<hZ;h3++){this._generateOverlayTileEach(h9[h3],hY,hW,h2,h0,e,hS,true)}for(h3=0,hZ=hK.length;h3<hZ;h3++){this._generateOverlayTileEach(hK[h3],hY,hW,h2,h0,e,hS,false)}},_generateOverlayTileEach:function(h4,hX,hS,h2,hY,T,hJ,hO){var hM=h4.getBoundsIn(true);var h0=hM.clone();var hT=this._earth.getBounds();var h5=ef.convertLL2MC(hT.getSouthWest());var hI=ef.convertLL2MC(hT.getNorthEast());T=T||this._earth.getImageZoom();var hR=Math.pow(2,T-18);var hL=new dM(h5,hI);var hP=h0.intersects(hL);if(hP===null){if(!hL.containsBounds(h0)){if(this._earth.getZoom()>=4){return}}}if(h4.isVisible()===false){return}var hQ=(hY-h2+1)*256;var hW=hJ.getContext("2d");hW.save();hW.lineCap=h4.getStrokeLineCap();hW.lineJoin=h4.getStrokeLineJoin();hW.globalAlpha=h4.getStrokeOpacity()+0.1;hW.lineWidth=h4.getStrokeWeight()+1;hW.strokeStyle=h4.getStrokeColor();hW.beginPath();var e=h4.getParsedPoints();for(var hZ=0;hZ<e.length;hZ++){var hN=e[hZ];for(var h1=0,hV=hN.length;h1<hV;h1++){var hU=hN[h1];var hK=new eb(hU.lng*hR,hU.lat*hR);var h3=new eb(hK.x-hX*256,hQ-(hK.y-h2*256));if(h1===0){hW.moveTo(h3.x,h3.y)}else{hW.lineTo(h3.x,h3.y)}}if(hO){hW.closePath()}}if(h4.getStrokeStyle()==="dashed"){hW.setLineDash([hW.lineWidth*2,hW.lineWidth*3])}hW.stroke();if(h4 instanceof aM){hW.save();hW.globalAlpha=h4.getFillOpacity();hW.fillStyle=h4.getFillColor()||"transparent";hW.fill("evenodd");hW.restore()}hW.restore()},getOverlayCanvas:function(e){if(e){return this._drawCanvasLOD}return this._drawCanvas},getMarkersRenderData:function(){return this._markersRenderData}});function ev(i,e){this._map=i;this._earth=e;this._container=e.getContainer();this._initEarthZoom=e.getZoom();this._draggingOnEarth=false;this._npLatLng=new cX(90,0);this._spLatLng=new cX(-90,0);this._opButton="";this._moved=false;this._bind()}C.extend(ev.prototype,{_bind:function(){var i=this._map;var e=this;i.addEventListener("dblclick",function(hI){if(this.mapType!==BMAP_EARTH_MAP){return}if(e._earth.getLock()){return}if(e._clickTimer){clearTimeout(e._clickTimer);e._clickTimer=null}var T=hI.offsetPosMap;if(hI.overlay instanceof dk){return}if(e.dragAni){e.dragAni.stop();e.dragAni=null}e._earth.fire(new a6("onearthdblclickzoom"));e._earth.zoomWithMousePosFix(e._earth.getZoom()+1,T)});this._earth.on("earthwheelzoom",function(){if(e.dragAni){e.dragAni.stop();e.dragAni=null}});C.on(document,"keydown",function(T){if(i.mapType!==BMAP_EARTH_MAP){return}if(i.temp.stopArrow===true){i.temp.stopArrow=false}if(i.config.enableKeyboard&&i.temp.canKeyboard){switch(T.keyCode){case dO.KEY_LEFT:case dO.KEY_UP:case dO.KEY_RIGHT:case dO.KEY_DOWN:if(i.temp.operating===false){e._earth.fire(new a6("onearthkeyboardmove"))}i.temp.operating=true;e.moveByArrowKey(T.keyCode,"keydown");T.cancelBubble=true;T.returnValue=false;break}}});C.on(document,"keyup",function(T){if(i.mapType!==BMAP_EARTH_MAP){return}if(i.config.enableKeyboard){switch(T.keyCode){case dO.KEY_LEFT:case dO.KEY_UP:case dO.KEY_RIGHT:case dO.KEY_DOWN:e.moveByArrowKey(T.keyCode,"keyup");break}}i.temp.operating=false});i.addEventListener("minuspress",function(){if(this.mapType!==BMAP_EARTH_MAP){return}e._earth.fire(new a6("onearthkeyboardzoomout"));e._earth.zoomOut()});i.addEventListener("pluspress",function(){if(this.mapType!==BMAP_EARTH_MAP){return}e._earth.fire(new a6("onearthkeyboardzoomin"));e._earth.zoomIn()})},onReadyToDrag:function(T){if(this._earth.getLock()){return}var i=T.offsetPosMap.x;var hI=T.offsetPosMap.y;if(T.button===0){this._onDragStart(i,hI)}else{if(T.button===2){this._onDragStartRight(i,hI)}}},onReadyToPinch:function(){if(this._earth.getLock()){return}this._initEarthZoom=this._earth.getZoom()},onDragging:function(hI,T){if(this._earth.getLock()){return}var i=hI.offsetPosMap.x;var hJ=hI.offsetPosMap.y;this._lastMoveTime=Date.now();if(T.button===0){this._onDragging(i,hJ,T.velocity,T.dir)}else{if(T.button===2){this._onDraggingRight(i,hJ)}}this._moved=true},onPinching:function(hJ,i){if(this._earth.getLock()){return}var hI=i.zoomRatio;var T=this._initEarthZoom+Math.log(hI)/Math.log(2);this._earth.zoomWithMousePosFix(T,i.pinchStartPosition,{opMethod:"screenPinch",stopCurrentAnimation:true,noAnimation:true})},onDragEnd:function(hI,T){if(this._earth.getLock()){return}var i=hI.offsetPosMap.x;var hJ=hI.offsetPosMap.y;if(hI.button===0){this._onDragEnd(i,hJ,T.velocity,T.dir)}else{if(hI.button===2){this._onDragEndRight(i,hJ)}}this._moved=false},onPinchEnd:function(i){},_onDragStart:function(e,T){if(this.dragAni){this.dragAni.stop();this.dragAni=null}var i=this._initLatLng=this._earth.fromPixelToLatLng(new eb(e,T));if(!i){return}this._initX=e;this._initY=T;this._earth.scene.saveMatrixInfo();this._curCenter=this._earth.getCenter().clone()},_onDragging:function(hQ,hO,hK,hI){var hR=this._earth;if(!this._mousemove){this._mousemove=true;hR.fire(new a6("onmovestart"));hR.fire(new a6("ondragstart"));this._dragStartTime=Date.now()}var T=hR.fromPixelToLatLng(new eb(hQ,hO));if(!T){if(this._draggingOnEarth===false){return}this._draggingOnEarth=false;if(this._initLatLng){hR.fire(new a6("onearthdragend"));this._processMotion(hQ,hO,hK*1.3,hI);this._initLatLng=null}return}if(!this._initLatLng){return this._onDragStart(hQ,hO)}this._draggingOnEarth=true;var e=this._earth._map;e.platform.style.cursor=e.config.draggingCursor;var hM=this._getLatLngDiffByXYDiff(hQ,hO);if(hM===null){if(this._initLatLng){this._initLatLng=null}return}var hJ=hM.lat;var hL=hM.lng;hR.fire(new a6("ondragging"));if(hR.getZoom()<4){this._needToRevertX=false;this._needToRevertY=false;var hP=hQ-this._initX;var hN=hO-this._initY;var i;if(hR.ifLatLngInView(this._npLatLng)){i=this._earth.fromLatLngToPixel(this._npLatLng);var hS=this._earth.getHeading();if(hS===0&&this._initY<i.y||hS===180&&this._initY>i.y){hP=-hP;this._needToRevertX=true}else{if(hS===90&&this._initX>i.x||hS===270&&this._initX<i.x){hN=-hN;this._needToRevertY=true}}}else{if(hR.ifLatLngInView(this._spLatLng)){i=this._earth.fromLatLngToPixel(this._npLatLng);if(hS===0&&this._initY>i.y||hS===180&&this._initY>i.y){this._needToRevertX=true;hP=-hP}else{if(hS===90&&this._initX<i.x||hS===270&&this._initX<i.x){this._needToRevertY=true;hN=-hN}}}}this._setEarthCenterByXYDiff(hP,hN)}else{this._setEarthCenterByLatLngDiff(hJ,hL)}this._moveDiffX=this._lastDiffX-hP;this._moveDiffY=this._lastDiffY-hN;this._lastDiffX=hP;this._lastDiffY=hN},_getLatLngDiffByXYDiff:function(e,hJ){var T=this._earth.fromPixelToLatLng(new eb(e,hJ),{useOld:true});if(!T){return null}var hI=T.lat-this._initLatLng.lat;var i=T.lng-this._initLatLng.lng;return{lat:hI,lng:i}},_setEarthCenterByLatLngDiff:function(i,e){this._earth.fire(new a6("onmoving"));this._earth.setCenter(new cX(this._curCenter.lat-i,this._curCenter.lng-e),{noAnimation:true,noFireEvent:true,stopCurrentAnimation:true,from:"mouse"})},_setEarthCenterByXYDiff:function(hJ,T){this._earth.fire(new a6("onmoving"));var hL=this._earth.getHeading();var i=dE(hL);var e=this._getLatLngSpan(hJ,T);var hK=this._curCenter.lat+e.lat*Math.cos(i)+e.lng*Math.sin(i);var hI=this._curCenter.lng+e.lng*Math.cos(i)-e.lat*Math.sin(i);this._earth.setCenter(new cX(hK,hI),{noAnimation:true,stopCurrentAnimation:true,from:"mouse",noFireEvent:true})},_getLatLngSpan:function(hI,e){var T=this._earth._imageRawZoom||this._earth.getImageZoom();var i=-hI/Math.pow(2,T-1);var hJ=e/Math.pow(2,T-1);return{lat:hJ,lng:i}},_onDragEnd:function(i,hM,hJ,T){if(!this._mousemove){var hL=new a6("onclick");hL.pixel=new eb(i,hM);hL.latLng=this._initLatLng||null;this._earth.fire(hL);if(!this._clickTimer){var hI=this;this._clickTimer=setTimeout(function(){hI._clickTimer=null;var hN=new a6("onclickex");hN.pixel=new eb(i,hM);hI._earth.fire(hN)},200)}}else{var hK=this._earth._map;hK.platform.style.cursor=hK.config.defaultCursor;this._earth.fire(new a6("onearthdragend"))}if(this._draggingOnEarth===true&&this._earth._map.config.enableInertialDragging){this._processMotion(i,hM,hJ,T)}this._draggingOnEarth=false;this._lastMoveTime=null;this._mousemove=false},_processMotion:function(hR,hQ,hP,hX){if(!this._initLatLng){return}if(!this._moved){return}var h8={x:hR-this._initX,y:hQ-this._initY};var e=this._earth;var hM=Date.now();e.fire(new a6("ondragend"));var hV=hM-this._lastMoveTime;var hW=Math.abs(this._moveDiffX);var h2=Math.abs(this._moveDiffY);if(hV>100||(hV>10&&hW<10&&h2<10)||(hW<3&&h2<3)){this._earth.fire(new a6("onanimation_end"));this._earth.fire(new a6("onmoveend"));return}var hI=0.5*hP;var h1=0;var hZ=0;if(hX.y===0){h1=hI}else{var hO=Math.abs(hX.x/hX.y);hZ=Math.round(Math.sqrt(hI*hI/(1+hO*hO)));h1=Math.round(hO*hZ)}if(hX.x<0){h1=-h1}if(hX.y<0){hZ=-hZ}var hU;var hS;var h6;var i;var h5=e.getZoom();var h0=e.getHeading();var T=new cX(0,0);if(h5<4){hU=h8.x+h1;hS=h8.y+hZ}else{var h4=this._getLatLngDiffByXYDiff(hR,hQ);var hY=dE(h0);var hL=h1*Math.cos(hY)+hZ*Math.sin(hY);var hJ=hZ*Math.cos(hY)-h1*Math.sin(hY);var T=this._getLatLngSpan(hL,hJ);h6=h4.lng-T.lng;i=h4.lat-T.lat}var h7=this;var hN;var hK;var hT;var h3;this.dragAni=new o({duration:10000,fps:60,render:function(ia,h9){if(h9===1){return}this._motionElaspsed=Date.now()-hM;var ib=Math.exp(-this._motionElaspsed/250);if(ib<0.01){if(h7.dragAni){h7.dragAni.stop();h7.dragAni=null}return}if(h5<4){hN=(hU-h1*ib);hK=(hS-hZ*ib);if(h7._needToRevertX){hN=-hN}else{if(h7._needToRevertY){hK=-hK}}h7._setEarthCenterByXYDiff(hN,hK)}else{hT=(h6+T.lng*ib);h3=(i+T.lat*ib);h7._setEarthCenterByLatLngDiff(h3,hT)}},finish:function(){h7._earth.fire(new a6("onanimation_end"));h7.dragAni=null;h7._earth.fire(new a6("onmoveend"));h7._initLatLng=null},onStop:function(h9){h7._earth.fire(new a6("onanimation_end"));h7.dragAni=null;h7._initLatLng=null;h7._earth.fire(new a6("onmoveend"))}})},_onDragStartRight:function(e,i){this._initXRight=e;this._initYRight=i;if(this._earth.getZoom()<5){return}this._earth.fire(new a6("ondragstart"));this._initTilt=this._earth.getTilt()},_onDraggingRight:function(i,hI){if(this._earth.getZoom()<5){return}this._rightDragged=true;var T=hI-this._initYRight;var e=T/2;this._earth.fire(new a6("ondragging"));this._earth.setTilt(this._initTilt+e,{noAnimation:true})},_onDragEndRight:function(e,hK){var hJ=!this._rightDragged;var hI=this._earth._map;if(this._rightDblclickTimer){clearTimeout(this._rightDblclickTimer);this._rightDblclickTimer=null;if(hJ){hI.dispatchEvent(new a6("onrightclick"));hI.dispatchEvent(new a6("onrightdblclick"));this._earth.fire(new a6("onearthrightdblclickzoom"));this._earth.zoomWithMousePosFix(this._earth.getZoom()-1,new eb(e,hK))}}else{if(hJ){hI.dispatchEvent(new a6("onrightclick"))}else{this._earth.fire(new a6("ondragend"))}var i=new a6("onrightclickex");var T=this;this._rightDblclickTimer=setTimeout(function(){T._rightDblclickTimer=null;if(hJ){hI.dispatchEvent(i)}},hI.config.clickInterval)}if(this._rightDragged){this._earth.fire(new a6("onearthrightdragend"))}this._rightDragged=false},moveByArrowKey:function(hN,T){var hL=this._earth;if(hL.getLock()){return}if(hL._ani){hL._ani.stop()}var e=hL._map;if(T==="keydown"){this._earth.fire(new a6("onmovestart"));e.temp.arrow|=dO.arrowOpCodes[hN]}else{if(T==="keyup"){e.temp.arrow&=~dO.arrowOpCodes[hN]}}var hM=e.temp.arrow;var hK=e._arrow._lastArrow;var hI=hK===hM?false:true;e._arrow._lastArrow=hM;var hO=hL.getZoom();var hJ=this;if(hM===0||(hM&1&&hM&4)||(hM&2&&hM&8)){this._arrowAni&&this._arrowAni.stop();this._arrowMomentumAni&&this._arrowMomentumAni.stop();this._arrowAni=null;if(hM===0){this._initCenter=hL.getCenter().clone();this._initPanLng=8/Math.pow(2,hO);this._initPanLat=8/Math.pow(2,hO);var i=8/Math.pow(2,hO);this._arrowMomentumAni=new o({duration:500,transition:ci.easeInCubic,render:function(hQ){var hT=hJ._initCenter;var hP=hT.lat;var hS=hT.lng;var hR=hK;if(hR&dO.arrowOpCodes[dO.KEY_LEFT]){hJ._initPanLng+=i*(1-hQ);hS=hT.lng-hJ._initPanLng}if(hR&dO.arrowOpCodes[dO.KEY_RIGHT]){hJ._initPanLng+=i*(1-hQ);hS=hT.lng+hJ._initPanLng}if(hR&dO.arrowOpCodes[dO.KEY_UP]){hJ._initPanLat+=i*(1-hQ);hP=hT.lat+hJ._initPanLat}if(hR&dO.arrowOpCodes[dO.KEY_DOWN]){hJ._initPanLat+=i*(1-hQ);hP=hT.lat-hJ._initPanLat}hL.setCenter(new cX(hP,hS),{noAnimation:true,noFireEvent:true,from:"keyboard"})},finish:function(){hJ._earth.fire(new a6("onmoveend"));hJ._arrowMomentumAni=null},stop:function(){hJ._earth.fire(new a6("onmoveend"));hJ._arrowMomentumAni=null}})}return}if(hI){this._initCenter=hL.getCenter().clone();this._initPanLng=8/Math.pow(2,hO);this._initPanLat=8/Math.pow(2,hO)}if(this._arrowAni){return}this._arrowMomentumAni&&this._arrowMomentumAni.stop();var i=8/Math.pow(2,hO);this._arrowAni=new o({duration:999999,transition:ci.linear,render:function(hR,hQ){var hU=hJ._initCenter;var hP=hU.lat;var hT=hU.lng;var hS=e.temp.arrow;if(hS&dO.arrowOpCodes[dO.KEY_LEFT]){hJ._initPanLng+=i;hT=hU.lng-hJ._initPanLng}if(hS&dO.arrowOpCodes[dO.KEY_RIGHT]){hJ._initPanLng+=i;hT=hU.lng+hJ._initPanLng}if(hS&dO.arrowOpCodes[dO.KEY_UP]){hJ._initPanLat+=i;hP=hU.lat+hJ._initPanLat}if(hS&dO.arrowOpCodes[dO.KEY_DOWN]){hJ._initPanLat+=i;hP=hU.lat-hJ._initPanLat}hL.setCenter(new cX(hP,hT),{noAnimation:true,noFireEvent:true,from:"keyboard"})}})}});function ar(i,e){this._earth=e;this.scrollCount=0;this.maxZoomWheelDir=1;this.minZoomWheelDir=-1;var T=b1[i.getMapType()];this.maxZoom=T.maxZoom;this.minZoom=T.minZoom;this._lastWheelTime=0;this._opMethod="";this.lastWheelDelta=0;this.lastDiff=0;this.zoomEventStatus="idle";this._canDispatchEvent=true;this._mousePos=null;this._isMac=!!C.Platform.macintosh}ar.prototype.onWheel=function(hL){if(this._earth.getLock()){return}var T=Math.floor(hL.timeStamp);var i=T-this._lastWheelTime;var hK=hL.wheelDelta>=0||hL.deltaY<0||hL.detail<0;var hS=Math.abs(hL.deltaY);var hO=Math.abs(hL.wheelDelta);var hP=hS;if(hO===0&&hP===0){return}if(i>100){this._opMethod=bG(hO,hP,hL.deltaMode);this._mousePos=hL.offsetPosMap.clone();this.scrollCount=0;this.startZoom=this._earth.getZoom()}var hI=false;if(this._mousePos===null&&hL.offsetPosMap!==null){this._mousePos=hL.offsetPosMap.clone()}var hR=this._mousePos;this._lastWheelTime=T;if(this._opMethod==="mouseWheel"){var hN=hO?(hO/3):hP;this._onWheelMouse(hN,hK,hR,hL.deltaMode);return}else{if(this._opMethod==="padScroll"){hS=hP/50;hI=true}else{hS=hP/20;hI=true}}if(isNaN(hS)&&hL.detail){hS=Math.abs(hL.detail)}var hM=this;if(i<80){if(!this._wheelEventTimer){this._wheelEventTimer=setTimeout(function(){hM._canDispatchEvent=true;hM._wheelEventTimer=null},100)}if(hM._canDispatchEvent){var hQ=new a6("onearthwheelzoom");if(hM._isMac){hQ.opMethod=hM._opMethod}hM._earth.fire(hQ);hM._canDispatchEvent=false}}var hT=this._earth.getZoom();var hJ=hK===true?hT+0.2*hS:hT-0.2*hS;this._earth.zoomWithMousePosFix(hJ,hR,{duration:200,transition:ci.linear,stopCurrentAnimation:true,noAnimation:hI})};ar.prototype._onWheelMouse=function(hI,hK,e,hJ){var hL=this._earth;this.scrollCount++;if(this.scrollCount>10){this.scrollCount=10}if(C.Browser.firefox){if(hJ===1){hI*=15}if(!C.Platform.macintosh){this.zoomDiff=dI(hI*0.005,2)*this.scrollCount}else{if(hI%1!==0){hI*=10}this.zoomDiff=dI(hI*0.01,2)}}else{if(!C.Platform.macintosh){this.zoomDiff=dI(hI*0.005,2)*this.scrollCount}else{this.zoomDiff=dI(hI*0.005,2)}}if(this.zoomDiff>2){this.zoomDiff=2}if(hK===false){this.zoomDiff=-this.zoomDiff}var T=hL.getZoom()+this.zoomDiff;hL.zoomWithMousePosFix(T,e,{opMethod:"mouseWheel",stopCurrentAnimation:true});this._preTrend=this._trend;var i=new a6("onearthwheelzoom");if(this._isMac){i.opMethod="mousescroll"}this._earth.fire(i)};');
